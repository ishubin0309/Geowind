{% extends 'base.html.twig' %}

{% set title = 'Modifier ' ~ projet %}
{% set item = 'afficher' %}

{% block css %}
  <link rel="stylesheet" href="{{ asset('vendor/Leaflet.markercluster-1.1.0/dist/MarkerCluster.css') }}">
  <link rel="stylesheet" href="{{ asset('vendor/Leaflet.markercluster-1.1.0/dist/MarkerCluster.Default.css') }}">

{% endblock %}

{% form_theme form 'bootstrap_3_horizontal_sm_layout.html.twig' %}

{% block body %}
  <style>
  #nouveau_projet_nav > .nav > li > a {
    padding-right: 10px;
    padding-left: 10px;
  }
  .chat-online {
    color: #34ce57
  }
  .chat-offline {
    color: #e4606d
  }
  .chat-messages {
    display: flex;
    flex-direction: column;
    {# max-height: 800px;
    overflow-y: scroll #}
  }
  .chat-message-left,
  .chat-message-right {
    display: flex;
    flex-shrink: 0
  }
  .chat-message-left {
    margin-right: auto
  }
  .chat-message-right {
    flex-direction: row-reverse;
    margin-left: auto
  }
  .p-4 {
    padding: 1.5rem !important;
  }
  .pb-4, .py-4 {
    padding-bottom: 1.5rem !important;
  }
  .mb-4, .my-4 {
    margin-bottom: 1.5rem !important;
  }
  .font-weight-bold {
    font-weight: 700 !important;
  }
  .mb-1, .my-1 {
    margin-bottom: .25rem !important;
  }
  .pl-3, .px-3 {
    padding-left: 1rem !important;
  }
  .pr-3, .px-3 {
    padding-right: 1rem !important;
  }
  .pb-2, .py-2 {
    padding-bottom: .5rem !important;
  }
  .pt-2, .py-2 {
    padding-top: .5rem !important;
  }
  .mr-3, .mx-3 {
    margin-right: 1rem !important;
  }
  .ml-3, .mx-3 {
    margin-left: 1rem !important;
  }
  .bg-light {
    background-color: #f8f9fa !important;
  }
  .bg-gray {
    background-color: gray !important;
  }
  .border-bottom {
    border-bottom: 1px solid #dee2e6 !important;
    margin-bottom: .5rem !important;
  }
  .border-top {
    border-top: 1px solid #dee2e6 !important;
    margin-top: .5rem !important;
  }
  .px-4 {
    padding-right: 1.5rem !important;
    padding-left: 1.5rem !important;
  }
  .py-3 {
    padding-top: 1rem !important;
    padding-bottom: 1rem !important;
  }
  </style>
  {{ form_start(form) }}
  <div class="container-fluid">
    <nav class="navbar navbar-default">
      <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#nouveau_projet_nav" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">{# <img alt="Brand" width="20"  src="{{ asset('favicon.png') }}"> #}</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="nouveau_projet_nav">
          <ul class="nav navbar-nav">
            <li class="active"><a href="#" rel="tab_localisation">Localisation</a></li>
            <li><a href="#" rel="tab_contacts">Contacts</a></li>
            <li class=""><a href="#" rel="tab_parcelles">Parcelles</a></li>
            <li class=""><a href="#" rel="tab_foncier">Foncier</a></li>
            <li class=""><a href="#" rel="tab_projet">Projet</a></li>
            <li class=""><a href="#" rel="tab_site">Contexte</a></li>
            <li class=""><a href="#" rel="tab_enjeux">Enjeux</a></li>
            <li class=""><a href="#" rel="tab_etat">Etat</a></li>
            <li class=""><a href="#" rel="tab_taches">Taches</a></li>
            <li class=""><a href="#" rel="tab_concertation">Concertation</a></li>
            <li class=""><a href="#" rel="tab_commandes">Commandes</a></li>
            <li class=""><a href="#" rel="tab_documents">Documents</a></li>
            <li class=""><a href="#" rel="tab_images">Images</a></li>
            {% set unreadMessage = false %}
            {% for message in projet.messages %}
              {% if message.createdBy is not null and (app.user.id != message.createdBy.id and app.user not in message.viewers) %}{% set unreadMessage = true %}{% endif %}
            {% endfor %}
            <li class=""><a href="#" rel="tab_messagerie">Messagerie{% if unreadMessage %} <i class="fa fa-circle" style="color:red;"></i>{% endif %}</a></li>
          </ul>
        </div><!-- /.navbar-collapse -->
      </div><!-- /.container-fluid -->
    </nav>
    <h1><i class="fa fa-edit"></i> Editer {{ projet }}</h1>
    <div class="row">
    <div id="fields_div" class="col-sm-6">

      <fieldset class="" id="tab_localisation">
        <legend>Références</legend>
        {{ form_row(form.archived) }}
        {{ form_row(form.denomination) }}
        {{ form_row(form.dateCreation) }}
        
        <legend>Typologies</legend>
        {{ form_row(form.typeProjet) }}
        {{ form_row(form.typeSite) }}
        {{ form_row(form.environnement) }}

        {# <legend>Classement</legend>
        {{ form_row(form.phase) }}
        {{ form_row(form.progression) }} #}

        <legend>Situation administrative</legend>
        {{ form_row(form.departement) }}
        {{ form_row(form.communes) }}
        <div class="form-group form-group-sm">
          <label class="col-sm-4 control-label" for="projet_epci">EPCI</label>
          <div id="projet_epci" class="col-sm-8 control-label">
          </div>
        </div>
        
        <legend>Situation géographique</legend>
        {{ form_row(form.latitude) }}
        {{ form_row(form.longitude) }}

        <div id="population">
          <legend>Population</legend>
          <div class="form-group form-group-sm"><label class="col-sm-4 control-label">-:</label><div class="col-sm-8">-</div></div>
          <div class="form-group form-group-sm"><label class="col-sm-4 control-label">-:</label><div class="col-sm-8">-</div></div>
        </div>

        <legend>Commentaires</legend>
        {{ form_widget(form.commentaires) }}
      </fieldset>

      <fieldset class="hide" id="tab_contacts">
        <legend>Contacts</legend>
        <table class="table table-condensed table-form">
          <thead>
            <tr>
              <th>Fonction</th>
              <th>Utilisateur</th>
              <th>Téléphone</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Source</td>
              <td class="required">{% if is_granted('ROLE_ADMIN') or projet.origine.id == app.user.id %}{{ form_widget(form.origine, {'attr': {'style': 'width:100%'}}) }}{% else %}{{ form.vars.value.origine }}{{ form_widget(form.origine, {'attr': {'class': 'hide','style': 'width:100%'}}) }}{% endif %}</td>
              <td>{% if is_granted('ROLE_ADMIN') or projet.origine.id == app.user.id %}{{ form_widget(form.origineTelephone) }}{% else %}{{ form.vars.value.origineTelephone }}{{ form_widget(form.origineTelephone, {'attr': {'class': 'hide'}}) }}{% endif %}</td>
            </tr>
            {# {% if is_granted('ROLE_ADMIN') %} #}
            <tr>
              <td>Chef projet</td>
              <td class="required">{% if is_granted('ROLE_ADMIN') or projet.origine.id == app.user.id %}{{ form_widget(form.chefProjet, {'attr': {'style': 'width:100%'}}) }}{% else %}{{ form.vars.value.chefProjet }}{{ form_widget(form.chefProjet, {'attr': {'class': 'hide','style': 'width:100%'}}) }}{% endif %}</td>
              <td>{% if is_granted('ROLE_ADMIN') or projet.origine.id == app.user.id %}{{ form_widget(form.chefProjetTelephone) }}{% else %}{{ form.vars.value.chefProjetTelephone }}{{ form_widget(form.chefProjetTelephone, {'attr': {'class': 'hide'}}) }}{% endif %}</td>
            </tr>
            {# {% endif %} #}
            <tr>
              <td>Chargé foncier</td>
              <td>{% if is_granted('ROLE_ADMIN') or projet.origine.id == app.user.id %}{{ form_widget(form.chargeFoncier, {'attr': {'style': 'width:100%'}}) }}{% else %}{{ form.vars.value.chargeFoncier }}{{ form_widget(form.chargeFoncier, {'attr': {'class': 'hide','style': 'width:100%'}}) }}{% endif %}</td>
              <td>{% if is_granted('ROLE_ADMIN') or projet.origine.id == app.user.id %}{{ form_widget(form.chargeFoncierTelephone) }}{% else %}{{ form.vars.value.chargeFoncierTelephone }}{{ form_widget(form.chargeFoncierTelephone, {'attr': {'class': 'hide'}}) }}{% endif %}</td>
            </tr>
            <tr>
              <td>Partenaire</td>
              <td class="required">{% if is_granted('ROLE_ADMIN') or projet.origine.id == app.user.id %}{{ form_widget(form.partenaire, {'attr': {'style': 'width:100%'}}) }}{% else %}{{ form.vars.value.partenaire }}{{ form_widget(form.partenaire, {'attr': {'class': 'hide','style': 'width:100%'}}) }}{% endif %}</td>
              <td>{% if is_granted('ROLE_ADMIN') or projet.origine.id == app.user.id %}{{ form_widget(form.partenaireTelephone) }}{% else %}{{ form.vars.value.partenaireTelephone }}{{ form_widget(form.partenaireTelephone, {'attr': {'class': 'hide'}}) }}{% endif %}</td>
            <tr>
            <tr>
              <td>Mairie</td>
              <td class="required">{% if is_granted('ROLE_ADMIN') or projet.origine.id == app.user.id %}{{ form_widget(form.mairie, {'attr': {'style': 'width:100%'}}) }}{% else %}{{ form.vars.value.mairie }}{{ form_widget(form.mairie, {'attr': {'class': 'hide','style': 'width:100%'}}) }}{% endif %}</td>
              <td>{% if is_granted('ROLE_ADMIN') or projet.origine.id == app.user.id %}{{ form_widget(form.mairieTelephone) }}{% else %}{{ form.vars.value.mairieTelephone }}{{ form_widget(form.mairieTelephone, {'attr': {'class': 'hide'}}) }}{% endif %}</td>
            <tr>
            <tr>
              <td>Maire</td>
              <td class="required">{% if is_granted('ROLE_ADMIN') or projet.origine.id == app.user.id %}{{ form_widget(form.maire, {'attr': {'style': 'width:100%'}}) }}{% else %}{{ form.vars.value.maire }}{{ form_widget(form.maire, {'attr': {'class': 'hide','style': 'width:100%'}}) }}{% endif %}</td>
              <td>{% if is_granted('ROLE_ADMIN') or projet.origine.id == app.user.id %}{{ form_widget(form.maireTelephone) }}{% else %}{{ form.vars.value.maireTelephone }}{{ form_widget(form.maireTelephone, {'attr': {'class': 'hide'}}) }}{% endif %}</td>
            <tr>
            <tr id="contact_epci">
              <td>EPCI</td>
              <td class="required"></td>
              <td></td>
            </tr>
            {% if form.vars.value.proprietaires[0] is defined %}
              {% for proprietaire in form.vars.value.proprietaires %}
                <tr rel="{{ loop.index0 }}" class="{% if not proprietaire.proprietaire %}hide{% endif %}">
                  <td>Propriétaire</td>
                  <td class="required">{{ proprietaire.proprietaire ? proprietaire.proprietaire : '-' }}</td>
                  <td>{{ proprietaire.telephoneProprietaire ? proprietaire.telephoneProprietaire : '-' }}</td>
                <tr>
                <tr rel="{{ loop.index0 }}" class="{% if not proprietaire.proprietaire2 %}hide{% endif %}">
                  <td>Propriétaire 2</td>
                  <td class="required">{{ proprietaire.proprietaire2 ? proprietaire.proprietaire2 : '-' }}</td>
                  <td>{{ proprietaire.telephoneProprietaire2 ? proprietaire.telephoneProprietaire2 : '-' }}</td>
                <tr>
                <tr rel="{{ loop.index0 }}" class="{% if not proprietaire.proprietaire3 %}hide{% endif %}">
                  <td>Propriétaire 3</td>
                  <td class="required">{{ proprietaire.proprietaire3 ? proprietaire.proprietaire3 : '-' }}</td>
                  <td>{{ proprietaire.telephoneProprietaire3 ? proprietaire.telephoneProprietaire3 : '-' }}</td>
                <tr>
                <tr rel="{{ loop.index0 }}" class="{% if not proprietaire.proprietaire4 %}hide{% endif %}">
                  <td>Propriétaire 4</td>
                  <td class="required">{{ proprietaire.proprietaire4 ? proprietaire.proprietaire4 : '-' }}</td>
                  <td>{{ proprietaire.telephoneProprietaire4 ? proprietaire.telephoneProprietaire4 : '-' }}</td>
                <tr>
                <tr rel="{{ loop.index0 }}" class="{% if not proprietaire.exploitant %}hide{% endif %}">
                  <td>Exploitant</td>
                  <td class="required">{{ proprietaire.exploitant ? proprietaire.exploitant : '-' }}</td>
                  <td>{{ proprietaire.telephoneExploitant ? proprietaire.telephoneExploitant : '-' }}</td>
                <tr>
                <tr rel="{{ loop.index0 }}" class="{% if not proprietaire.exploitant2 %}hide{% endif %}">
                  <td>Exploitant 2</td>
                  <td class="required">{{ proprietaire.exploitant2 ? proprietaire.exploitant2 : '-' }}</td>
                  <td>{{ proprietaire.telephoneExploitant2 ? proprietaire.telephoneExploitant2 : '-' }}</td>
                <tr>
                <tr rel="{{ loop.index0 }}" class="{% if not proprietaire.exploitant3 %}hide{% endif %}">
                  <td>Exploitant 3</td>
                  <td class="required">{{ proprietaire.exploitant3 ? proprietaire.exploitant3 : '-' }}</td>
                  <td>{{ proprietaire.telephoneExploitant3 ? proprietaire.telephoneExploitant3 : '-' }}</td>
                <tr>
              {% endfor %}
            {% endif %}
            {% if form.vars.value.finances[0] is defined %}
              {% for finance in form.vars.value.finances %}
                <tr rel="{{ loop.index0 }}" class="{% if not finance.bureau %}hide{% endif %}">
                  <td>Chargé d'études</td>
                  <td class="required">{{ finance.bureau.representant is defined ? finance.bureau.representant : '-' }}</td>
                  <td>{{ finance.bureau.telephone is defined ? finance.bureau.telephone : '-' }}</td>
                <tr>
              {% endfor %}
            {% endif %}
          </tbody>
        </table>
      </fieldset>

      <fieldset class="hide" id="tab_site">
        <legend></legend>
        <div class="form_site hide" id="form_site_terrain">
          {{ form_widget(form.terrain) }}
        </div>
        <div class="form_site hide" id="form_site_batimentNouveau">
          {{ form_row(form.batimentNouveau) }}
        </div>
        <div class="form_site hide" id="form_site_batimentExistant">
          {{ form_widget(form.batimentExistant) }}
        </div>
      </fieldset>

      <fieldset class="hide" id="tab_projet">
        <legend>Implantation</legend>
        {{ form_row(form.typeImplantation) }}
        {{ form_row(form.titreImplantation) }}
        {{ form_row(form.photoImplantationFile) }}
        <legend>Conventions</legend>
        {{ form_row(form.contrat) }}
        {{ form_row(form.debouche) }}
        {{ form_row(form.tarif) }}
        <legend>Equipement</legend>
        {{ form_row(form.technologie) }}
        {{ form_row(form.equipement) }}
        <div class="form-group form-group-sm">
          <div class="col-sm-12">
            <p></p>
          </div>
        </div>
        {{ form_row(form.emprise) }}
        <legend>Installation</legend>
        <div class="clearfix"></div>
        {{ form_row(form.lineaire) }}
        {{ form_row(form.interdistance) }}
        {{ form_row(form.unite) }}
        {{ form_row(form.voiries) }}
        {{ form_row(form.surfaceUtile) }}
        {{ form_row(form.puissanceUnitaire) }}
        {{ form_row(form.puissanceTotale) }}
        {{ form_row(form.production) }}
        <div class="form-group form-group-sm"><label class="col-sm-4 control-label required" for="projet_potentiel"><strong>Potentiel (MW)</strong></label><div class="col-sm-8">    
          {{ form_widget(form.potentiel) }}</div>
        </div>
      </fieldset>

      <fieldset class="hide" id="tab_parcelles">
        <legend>Parcelles</legend>
        <ul class="nav nav-tabs" role="tablist">
          <li role="presentation" class="active"><a href="#parcelleCarte" aria-controls="parcelleCarte" role="tab" data-toggle="tab">Carte</a></li>
          <li role="presentation"><a href="#parcelleTable" aria-controls="parcelleTable" role="tab" data-toggle="tab">Table</a></li>
        </ul>
        <div class="tab-content">
          <div role="tabpanel" class="tab-pane active" id="parcelleCarte">
            <div class="form-group form-group-sm">
              <label class="col-sm-4 control-label">Section</label>
              <div class="col-sm-6">
                <input type="text" class="form-control sectionNum" placeholder="Section">
              </div>
            </div>
            <div class="form-group form-group-sm">
              <label class="col-sm-4 control-label">Numéro parcelle</label>
              <div class="col-sm-6">
                <input type="text" class="form-control parcelleNum" placeholder="Numéro parcelle">
              </div>
            </div>
            <button type="button" class="btn btn-success btn-sm" id="rechercher_cadastre"><i class="fa fa-search"></i> Rechercher</button>
            <button type="button" class="btn btn-info btn-sm" id="ajouter_cadastre"><i class="fa fa-plus"></i> Ajouter à la liste</button>
            <table class="table table-condensed table-form">
              <thead>
                <th>Section</th>
                <th>Numéro</th>
                <th>Commune</th>
                <th>Surface</th>
              </thead>
              <tbody id="parcelles_carte">
              </tbody>
            </table>
              
          </div>
          <div role="tabpanel" class="tab-pane" id="parcelleTable">{{ form_widget(form.parcelles) }}</div>
        </div>
        
      </fieldset>

      <fieldset class="hide" id="tab_enjeux">
        {{ form_widget(form.enjeuxs) }}
      </fieldset>

      <fieldset class="hide" id="tab_etat">
        {{ form_widget(form.etats) }}
      </fieldset>

      <fieldset class="hide" id="tab_taches">
        {{ form_widget(form.taches) }}
      </fieldset>
      
      <fieldset class="hide" id="tab_foncier">
        <legend>Accords</legend>
        <div class="col-sm-12 col-md-6 col-lg-3">
          <input type="text" id="projet_proprietaires_recherche" class="form-control {% if form.vars.value.proprietaires[0] is not defined %}hide{% endif %}" placeholder="recherche" autocomplete="off">
        </div>
        {{ form_widget(form.proprietaires) }}
      </fieldset>

      <fieldset class="hide" id="tab_concertation">
        {{ form_widget(form.concertations) }}
      </fieldset>

      <fieldset class="hide" id="tab_commandes">
        <h4 id="selected-counter">Total engagé: 0€ HT | Total payé: 0€ HT</h4>
        <div class="col-sm-12 col-md-6 col-lg-3">
          <input type="text" id="projet_finances_recherche" class="form-control hide" placeholder="recherche" autocomplete="off">
        </div>
        {{ form_widget(form.finances) }}
      </fieldset>

      <fieldset class="hide" id="tab_documents">
        {{ form_widget(form.documents) }}
      </fieldset>

      <fieldset class="hide" id="tab_images">
        <div class="col-md-6">
          <input type="text" id="projet_notes_recherche" class="form-control hide" placeholder="recherche" autocomplete="off">
        </div>
        {{ form_widget(form.notes) }}
      </fieldset>

      <fieldset class="hide" id="tab_messagerie">
        <div class="col-md-12">
          <div class="flex-grow-0 py-3 px-4 border-bottom">
            <div class="col-md-offset-8 col-md-4">
              <input type="text" id="message_search" class="form-control" placeholder="Rechercher">
            </div>
            <div class="clearfix"></div>
          </div>
          <div class="chat-messages p-4">
            {% for message in projet.messages %}
              {% if message.createdBy is not null and message.createdBy.id == app.user.id %}
              <div message="{{ message.id }}" class="chat-message-right mb-4">
								<div title="{{ message.createdAt|date('Y-m-d') }}">
									<img src="{{ asset('images/me.jpg') }}" class="rounded-circle mr-1" alt="{{ message.createdBy is not null ? message.createdBy.nom ~ ' ' ~ message.createdBy.prenom : '' }}" width="40" height="40">
									<div class="text-muted small text-nowrap mt-2">{{ message.createdAt|date('H:i A') }}</div>
								</div>
								<div class="flex-shrink-1 bg-gray rounded py-2 px-3 mr-3">
									<div class="font-weight-bold mb-1">Vous</div>
									{{ message.body }}
								</div>
							</div>
              {% else %}
              <div message="{{ message.id }}" class="chat-message-left pb-4">
								<div title="{{ message.createdAt|date('Y-m-d') }}">
									<img src="{{ asset('images/user.jpg') }}" class="rounded-circle mr-1" alt="{{ message.createdBy is not null ? message.createdBy.nom ~ ' ' ~ message.createdBy.prenom : '' }}" width="40" height="40">
									<div class="text-muted small text-nowrap mt-2">{{ message.createdAt|date('H:i A') }}</div>
								</div>
								<div class="flex-shrink-1 bg-light rounded py-2 px-3 ml-3">
									<div class="font-weight-bold mb-1">{{ message.createdBy is not null ? message.createdBy.nom ~ ' ' ~ message.createdBy.prenom : '' }}</div>
									{{ message.body }}
								</div>
							</div>
              {% endif %}
            {% endfor %}
          </div>
          <div class="flex-grow-0 py-3 px-4 border-top">
            <div class="input-group">
              <input type="text" id="send_body" class="form-control" placeholder="Ajouter un message">
              <span class="input-group-btn">
                <button id="send_message" class="btn btn-primary">Envoyer</button>
              </span>
            </div>
          </div>
        </div>
      </fieldset>

    </div>
    <div class="col-sm-offset-1 col-sm-5">
      <div id="map" class="map map-home" style="height: 500px; margin-bottom: 20px;"></div>
      <div id="parcelleMap" class="map map-home" style="height: 500px; margin-bottom: 20px;"></div>
      <div id="map_search">
        <div class="form-group form-group-sm">
          <label class="col-sm-4 control-label">Rechercher une adresse</label>
          <div class="col-sm-8">
            <input type="text" class="form-control" id="location" placeholder="Rechercher une adresse">
          </div>
        </div>
        {{ form_row(form.adresse) }}
      </div>
      
      <div id="main_photo" class="hide col-sm-12"><img style="width: inherit;" src=""><nav style="margin-left:30%;" aria-label="Page navigation center-text"><ul class="pagination"><li class="page-item disabled"><a id="prev_image" class="page-link" href="#">Précédent</a></li><li class="page-item disabled"><a id="next_image" class="page-link" href="#">Suivant</a></li></ul></nav></div>

      <div class="text-right m-t-10">
        <button type="submit" class="btn btn-primary"><i class="fa fa-save"></i> Sauvegarder</button>
      </div>
       
    </div>
  </div>
  
  <div class="row">
    <div class="col-xs-12">
    
      {{ form_rest(form) }}
    </div>
  </div>


  </div>

  {{ form_end(form) }}
  <div class="modal fade bs-modal-lg" tabindex="-1" role="dialog" aria-labelledby="carteModal">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content text-center">
        <div id="popup_photo" class="modal-body">
          <img id="popup_photo_close" title="Fermer" width="25" height="25" style="position:absolute;right:20px;top:20px;cursor:pointer;" src="{{ asset('images/close.png') }}">
          <a download="" href="#" title="Télécharger">
            <img style="max-width: 100%;padding:3%;" src="">
          </a>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade publish-modal" tabindex="-1" role="dialog" aria-labelledby="publishModal">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content text-center">
        <div class="modal-body">
          <form id="publish_form" class="form-horizontal" method="POST" action="{{ path('projet_publish') }}">

          </form>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade send-mail-modal" tabindex="-1" role="dialog" aria-labelledby="sendMailModal">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content text-center">
        <div class="modal-body">
          <h1>Envoyer un email</h1>
          <hr>
          {{ form_start(formMail) }}
          
          {{ form_row(formMail.from) }}
          {{ form_row(formMail.to) }}
          
          <hr>
          
          {{ form_rest(formMail) }}

          <div class="form-group">
            <div class="col-sm-10 col-sm-offset-2">
              <button type="submit" class="btn btn-primary"><i class="fa fa-send fa-fw"></i> Envoyer</button>
            </div>
          </div>
          {{ form_end(formMail) }}
        </div>
      </div>
    </div>
  </div>

{% endblock %}

{% block js %}
  <script src="{{ asset('vendor/Leaflet.markercluster-1.1.0/dist/leaflet.markercluster.js') }}"></script>
  <script src="https://france-cadastre.fr/assets/js/leaflet-providers.js"></script>
  <script src="https://unpkg.com/leaflet.vectorgrid@latest/dist/Leaflet.VectorGrid.bundled.js"></script>
  <script src="https://unpkg.com/leaflet-canvas-marker@0.2.0/dist/leaflet.canvas-markers.js"></script>
  <script src="https://france-cadastre.fr/assets/js/leaflet-event-forwarder.js"></script>
  
  <script>
    var mainMap = L.map('map').setView([46, 2], 5.5);
    
    var streetLayer = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(mainMap);

    var googleHybrid = L.tileLayer('http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}',{
        maxZoom: 20,
        subdomains:['mt0','mt1','mt2','mt3']
    });

    var googleTerrain = L.tileLayer('http://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}',{
        maxZoom: 20,
        subdomains:['mt0','mt1','mt2','mt3']
    });

    var baseMaps = {
        "Rue": streetLayer,
        "Aérienne": googleHybrid,
        "Terrain": googleTerrain
    };
    L.control.layers(baseMaps).addTo(mainMap);

    var marker = null;

    var default_lat = {{ projet.latitude }};
    var lat = {{ projet.latitude }};
    var long = {{ projet.longitude }};

    $('#projet_latitude').change(function() {
      lat = $(this).val().replace(',', '.');
      updateMarkerPosition();
    });

    $('#projet_longitude').change(function() {
      long = $(this).val().replace(',', '.');
      updateMarkerPosition();
    });

    function updateMarkerPosition() {

      if ($.isNumeric(lat) && $.isNumeric(long) && marker === null && lat != null && long != null) {
        marker = L.marker([lat, long]).addTo(mainMap);
        mainMap.panTo(new L.LatLng(lat, long));
        marker = L.marker([lat, long]).addTo(parcelleMap);
        parcelleMap.panTo(new L.LatLng(lat, long));
      }

      if ($.isNumeric(lat) && $.isNumeric(long) && marker != null && lat != null && long != null) {
        marker.setLatLng([lat, long]);
        mainMap.panTo(new L.LatLng(lat, long));
        parcelleMap.panTo(new L.LatLng(lat, long));
      }

    }
    var customControl =  L.Control.extend({

      options: {
        position: 'topleft'
      },

      onAdd: function (mainMap) {
        var container = L.DomUtil.create('a');
        container.setAttribute("role", "button");
        container.title="Center";
        container.text = "c";

        container.style.backgroundColor = 'white';     
        {# container.style.backgroundImage = "url(https://t1.gstatic.com/images?q=tbn:ANd9GcR6FCUMW5bPn8C4PbKak2BJQQsmC-K9-mbYBeFZm1ZM2w2GRy40Ew)"; #}
        container.style.backgroundSize = "30px 30px";
        container.style.width = '32px';
        container.style.height = '32px';
        container.style.lineHeight = '24px';
        container.style.textDecoration = 'none';
        container.style.cursor = 'pointer';
        container.style.textAlign = 'center';
        container.style.color = 'black';
        container.style.fontSize = '24px';
        container.style.borderRadius = '4px';
        container.style.marginTop = '2px';
        container.style.border = '2px solid rgba(0,0,0,0.2)';
        
        container.onmouseover = function(){
          container.style.backgroundColor = '#f4f4f4'; 
        }
        container.onmouseout = function(){
          container.style.backgroundColor = 'white'; 
        }

        container.onclick = function() {
          update_marker = 0;
          mainMap.setView([46,2],5);
        }

        return container;
      }
    });

    mainMap.addControl(new customControl());
    var update_marker = 1;
    mainMap.on('click', function(e) {
      if(update_marker) {
        lat = e.latlng.lat;
        long = e.latlng.lng;
        $('#projet_latitude').val(lat);
        $('#projet_longitude').val(long);
        default_lat = lat;
        updateMarkerPosition();
        reverseGeolocalisation(lat + ' ' + long, false);
      } else update_marker = 1;
    });

    var id = 0;
    var parcelleMap;
    var lastSearch = '';
    var lastFeature = {};
    var options = {
        center: [48.884, 2.59709],
        zoom: 12,
        minZoom: 1,
        maxZoom: 19,
        preferCanvas: true,
        fullscreenControl: true,
    },
    parcelleMap = L.map('parcelleMap', options);
    const myEventForwarder = new L.eventForwarder({
        // ref to leaflet map
        map: parcelleMap,
        // events to forward
        events: {
            click: true
        }
    });

    // enable event forwarding
    myEventForwarder.enable();

    // load map tiles and add to map
    var tiles = L.tileLayer('https://tile2.france-cadastre.fr/styles/klokantech-basic/{z}/{x}/{y}.png', {
        subdomains: 'abcd',
        maxZoom: 19
    });

    var grayscale = L.tileLayer.provider('CartoDB.Positron', {
            minZoom: 9,
            maxZoom: 19
        }),
        streets = L.tileLayer.provider('Esri.WorldImagery', {
            minZoom: 9,
            maxZoom: 19
        });
    var baseMaps = {
        "Carte": tiles,
        "Satellite": streets
    };

    parcelleMap.on("baselayerchange", function(event) {
        tileLayer.bringToFront();
    });

    var defaultLayer = tiles.addTo(parcelleMap);

    if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
        layerControl = L.control.layers(baseMaps, null, {
            collapsed: true
        });
    } else {
        layerControl = L.control.layers(baseMaps, null, {
            collapsed: false
        });
    }

    L.control.layers(baseMaps).addTo(parcelleMap);

    parcelleMap.createPane('parcelPane');

    parcelleMap.getPane('parcelPane').style.zIndex = 650;

    var communeInsee = '{{ projet.communes is defined and projet.communes is not empty ? projet.communes[0].insee : '' }}';

    var overlay;
    var newoverlay;
    parcelleMap.on('zoomend', function() {

        if (parcelleMap.getZoom() >= 13) {
            var bounds = new L.LatLngBounds(
                new L.LatLng(parcelleMap.getBounds().getNorth(), parcelleMap.getBounds().getWest()),
                new L.LatLng(parcelleMap.getBounds().getSouth(), parcelleMap.getBounds().getEast()));

            newoverlay = new L.ImageOverlay("https://admin.france-cadastre.fr/show_labels.php?nord=" + parcelleMap.getBounds().getNorth() + "&sud=" + parcelleMap.getBounds().getSouth() + "&est=" + parcelleMap.getBounds().getEast() + "&ouest=" + parcelleMap.getBounds().getWest() + "&zoom=" + parcelleMap.getZoom() + "&insee=" + communeInsee, bounds, {
                opacity: 1
            });

            parcelleMap.addLayer(newoverlay);
            newoverlay.on('load', function(event) {

                if ($('.leaflet-overlay-pane>img').length > 1)
                    $('.leaflet-overlay-pane>img:nth-child(1)').remove();
            });
            overlay = newoverlay;
        } else {
            if (typeof overlay != 'undefined') {
                parcelleMap.removeLayer(overlay);
            }
        }
    });
    parcelleMap.on('moveend', function() {

        if (parcelleMap.getZoom() >= 13) {
            var bounds = new L.LatLngBounds(
                new L.LatLng(parcelleMap.getBounds().getNorth(), parcelleMap.getBounds().getWest()),
                new L.LatLng(parcelleMap.getBounds().getSouth(), parcelleMap.getBounds().getEast()));

            newoverlay = new L.ImageOverlay("https://admin.france-cadastre.fr/show_labels.php?nord=" + parcelleMap.getBounds().getNorth() + "&sud=" + parcelleMap.getBounds().getSouth() + "&est=" + parcelleMap.getBounds().getEast() + "&ouest=" + parcelleMap.getBounds().getWest() + "&zoom=" + parcelleMap.getZoom() + "&insee=" + communeInsee, bounds, {
                opacity: 1
            });

            parcelleMap.addLayer(newoverlay);
            newoverlay.on('load', function(event) {

                if ($('.leaflet-overlay-pane>img').length > 1)
                    $('.leaflet-overlay-pane>img:nth-child(1)').remove();
            });
            overlay = newoverlay;
        } else {
            if (typeof overlay != 'undefined') {
                parcelleMap.removeLayer(overlay);
            }
        }
    });
    var parcels;
    function buildMap() {
        tileLayer = L.vectorGrid.slicer(parcels, {
            rendererFactory: L.canvas.tile,
            vectorTileLayerStyles: {
                sliced: {
                    fillColor: "green",
                    color: "black",
                    weight: 1,
                    fill: true,
                    fillOpacity: .1
                }
            },
            maxZoom: 22,
            indexMaxZoom: 5, // max zoom in the initial tile index
            interactive: true,
            getFeatureId: function(feature) {
                return feature.properties["id"]
            }
        });
        var tiletile = tileLayer.addTo(parcelleMap);

        var myRenderer = L.canvas({
            padding: 0.5
        });

        tileLayer.on('click', function(e) {

            //console.log(e);
            if (e.layer.feature) {
                var prop = e.layer.feature.properties;
                //var latlng = [e.latlng.lat,e.latlng.lng];
            } else {
                var prop = e.layer.properties;
                //var latlng = [Number(parcel.y),Number(parcel.x)];
            }
            //settimeout otherwise when map click fires it will override this color change
            if (id != 0) {
                tileLayer.setFeatureStyle(id, {
                    fillColor: "green",
                    color: "black",
                    weight: 1,
                    fill: true
                });
            }
            if (lastSearch != '') {
                tileLayer.setFeatureStyle(lastSearch, {
                    fillColor: "green",
                    color: "black",
                    weight: 1,
                    fill: true
                });
            }
            id = prop["id"];
            setTimeout(function() {
                tileLayer.setFeatureStyle(id, {
                    fillColor: "blue",
                    color: "blue",
                    weight: 1,
                    fill: true
                }, 100);
            });

            var feature = e.layer.properties;
            lastFeature = feature;

            //console.log(e);
            if (e.layer.feature) {
                var prop = e.layer.feature.properties;
                //var latlng = [e.latlng.lat,e.latlng.lng];
            } else {
                var prop = e.layer.properties;
                //var latlng = [Number(parcel.y),Number(parcel.x)];
            }
            //settimeout otherwise when map click fires it will override this color change
            if (id != 0) {
                tileLayer.setFeatureStyle(id, {
                    fillColor: "green",
                    color: "black",
                    weight: 1,
                    fill: true
                });
            }
            if (lastSearch != '') {
                tileLayer.setFeatureStyle(lastSearch, {
                    fillColor: "green",
                    color: "black",
                    weight: 1,
                    fill: true
                });
            }
            id = prop["id"];
            setTimeout(function() {
                tileLayer.setFeatureStyle(id, {
                    fillColor: "blue",
                    color: "blue",
                    weight: 1,
                    fill: true
                }, 100);
            });

            var feature = e.layer.properties;

            var note = '';
            $('#projet_parcelles tr').each(function() {
              sectionConcatNumero = feature.section + feature.numero;
              if(!note && $(this).find('input[id$="_nom"]').val().trim() == sectionConcatNumero && $(this).find('input[id$="_note"]').val().trim()) {
                note = 'Notes: ' + $(this).find('input[id$="_note"]').val().trim() + '<br />';
              }
            });
            if(!note) {
              note = 'Notes: -<br />';
            }
            
            var popup = L.popup()
                .setLatLng(e.latlng)
                .setContent("<h2>Parcelle " + feature.section + feature.numero + "</h2><p>" + note + "Superficie : " + feature.contenance + " m2<br />Section : " + feature.section + "<br />Numéro : " + feature.numero + "<br />préfixe : " + feature.prefixe + "<br /><a href='https://france-cadastre.fr/predemande?commune=Chelles&section=" + feature.section + "&prefixe=" + feature.prefixe + "&plan=" + feature.numero + "&insee=77108&' target='_blank'>Extrait de plan cadastral (PDF)</a><br/><a href='https://france-cadastre.fr/matrice?dep=77&section=" + feature.section + "&ville=Chelles&plan=" + feature.numero + "&insee=77108' target='_blank'>Qui est le propriétaire ?</a><br/><a href='https://france-cadastre.fr/risques?commune=Chelles&section=" + feature.section + "&prefixe=" + feature.prefixe + "&plan=" + feature.numero + "&insee=77108&scale=4000' target='_blank'>Étude des risques</a><br/><a href='https://france-cadastre.fr/permisdeconstruire/chelles-77&section=" + feature.section + "&plan=" + feature.numero + "' target='_blank'>Permis de construire</a></p>")
                .openOn(parcelleMap);

            $('.sectionNum').val(feature.section);
            $('.parcelleNum').val(feature.numero);
        });
        
        loadAllParcellesTags();
    }

    {# $('.dvf').click(function() {
        $.getJSON("https://api.cquest.org/dvf?code_commune=77108")
            .done(function(json) {
                $('.legendeDvf').css("display", 'block');
                $.each(json.resultats, function(i, item) {
                    //console.log(item.numero_plan);
                    //console.log(item.valeur_fonciere);

                    if (item.valeur_fonciere >= 200000) {
                        var couleur = "#e2534b";
                    } else if (item.valeur_fonciere >= 150000) {
                        var couleur = "#f5c94a";
                    } else if (item.valeur_fonciere >= 100000) {
                        var couleur = "#3e4ce9";
                    } else {
                        var couleur = "#89c358";
                    }

                    tileLayer.setFeatureStyle(item.numero_plan, {
                        fillColor: couleur,
                        color: "black",
                        weight: 1,
                        fill: true,
                        fillOpacity: 1
                    });
                });
            });
    }); #}

    $('#rechercher_cadastre').click(function() {
        var trouve = false;
        parcels.features.forEach(function(feature) {
            if ($('.parcelleNum').val() == feature.properties.numero) {
                if ($('.parcelleNum').val() == feature.properties.numero && $('.sectionNum').val().toUpperCase() == feature.properties.section) {
                    trouve = true;

                    var lng = feature.geometry.coordinates[0][0][0];
                    var lat = feature.geometry.coordinates[0][0][1];

                    var latlng = [lat,lng];

                    var note = '';
                    $('#projet_parcelles tr').each(function() {
                      sectionConcatNumero = feature.properties.section + feature.properties.numero;
                      if(!note && $(this).find('input[id$="_nom"]').val().trim() == sectionConcatNumero && $(this).find('input[id$="_note"]').val().trim()) {
                        note = 'Notes: ' + $(this).find('input[id$="_note"]').val().trim() + '<br />';
                      }
                    });
                    if(!note) {
                      note = 'Notes: -<br />';
                    }
                    var popup = L.popup()
                        .setLatLng(latlng)
                        .setContent("<h2>Parcelle " + feature.properties.section + feature.properties.numero + "</h2><p>" + note + "Superficie : " + feature.properties.contenance + " m2<br />Section : " + feature.properties.section + "<br />Numéro : " + feature.properties.numero + "<br />préfixe : " + feature.properties.prefixe + "<br /><a href='https://france-cadastre.fr/predemande?commune=Chelles&section=" + feature.properties.section + "&prefixe=" + feature.properties.prefixe + "&plan=" + feature.properties.numero + "&insee=77108&' target='_blank'>Extrait de plan cadastral (PDF)</a><br/><a href='https://france-cadastre.fr/matrice?dep=77&section=" + feature.properties.section + "&ville=Chelles&plan=" + feature.properties.numero + "&insee=77108' target='_blank'>Qui est le propriétaire ?</a><br/><a href='https://france-cadastre.fr/risques?commune=Chelles&section=" + feature.properties.section + "&prefixe=" + feature.properties.prefixe + "&plan=" + feature.properties.numero + "&insee=77108&scale=4000' target='_blank'>Étude des risques</a><br/><a href='https://france-cadastre.fr/permisdeconstruire/chelles-77&section=" + feature.properties.section + "&plan=" + feature.properties.numero + "' target='_blank'>Permis de construire</a></p>")
                        .openOn(parcelleMap);
                    
                    tileLayer.setFeatureStyle(feature.id, {
                        fillColor: "blue",
                        color: "black",
                        weight: 1,
                        fill: true
                    });

                    if (lastSearch != '') {
                        tileLayer.setFeatureStyle(lastSearch, {
                            fillColor: "green",
                            color: "black",
                            weight: 1,
                            fill: true
                        });
                    }

                    lastSearch = feature.id;
                    lastFeature = feature;

                    parcelleMap.setView(new L.LatLng(lat, lng), 16);
                }
            }


        });
        if (trouve == false) {
            alert("Cette parcelle n'existe pas.");
        }
        return false;
    });

    $('#ajouter_cadastre').click(function() {
      if(lastFeature.id !== undefined && $('.sectionNum').val() && $('.parcelleNum').val()) {
        $('#projet_parcelles_add_entry').click();
        $('#projet_parcelles tr:last input[id$="_nom"]').val(lastFeature.section + lastFeature.numero);
        $('#projet_parcelles tr:last input[id$="_surface"]').val(lastFeature.contenance);
        tileLayer.setFeatureStyle(lastFeature.id, {
            fillColor: "red",
            color: "black",
            weight: 1,
            fill: true
        });
        loadAllParcellesTags();
      }
    });
    
    function reverseGeolocalisation(query, update_marker) {
      var nominatimUrl = 'https://nominatim.openstreetmap.org/search';
      $.ajax({
          type: 'GET',
          url: nominatimUrl,
          data: {
            q: query,
            extratags: 0,
            namedetails: 0,
            polygon_geojson: 0,
            format: 'json',
          },
          dataType: 'json',

        })
        .done(function(data) {

          if (data.length === 0) {
            return;
          }

          var searchLat = data[0]['lat'];
          var searchLong = data[0]['lon'];
          var bbox = data[0]['boundingbox'];
          var adresse = data[0]['display_name'];
          if(!adresse.match('France') && data.length > 1) {
            var searchLat = data[1]['lat'];
            var searchLong = data[1]['lon'];
            var bbox = data[1]['boundingbox'];
            var adresse = data[1]['display_name'];
          }
          {# if(adresse.match('France')) { #}
            $('#projet_adresse').val(adresse);
            if(update_marker) {
              if (bbox != undefined) {
                mainMap.fitBounds([
                  [bbox[0], bbox[2]],
                  [bbox[1], bbox[3]]
                ]);
                parcelleMap.fitBounds([
                  [bbox[0], bbox[2]],
                  [bbox[1], bbox[3]]
                ]);
              } else {
                mainMap.setView([searchLat, searchLong], 10);
                parcelleMap.setView([searchLat, searchLong], 10);
              }
              if($('#projet_latitude').val() != searchLat && !default_lat) {
                lat = searchLat;
                long = searchLong;
                $('#projet_latitude').val(lat);
                $('#projet_longitude').val(long);
                updateMarkerPosition();
              }
            }
          {# } #}
          
        });
    }
    var last_reverse_search = null;
    $('#projet_communes, #projet_departement').change(function() {
      
      var nominatimUrl = 'https://nominatim.openstreetmap.org/search';
      $input = $(this);

      if($(this).attr('id') == 'projet_communes') {
        if(m = $('#projet_communes option:selected').text().match(/\((\d+)\)/)) {
          communeInsee = m[1];
        }
        var query = $('#projet_departement option:selected').text().replace(/\(.+/, '').trim() + ' ' + $('#projet_communes option:selected').text().replace(/\(.+/, '').trim();
        updateMairie(true);
        updateEpci();
        updateDenomination();
      } else {
        var query = $('#projet_departement option:selected').text().replace(/\(.+/, '').trim();
        {% if is_granted('ROLE_ADMIN') or projet.origine.id == app.user.id %}
        updateContacts();
        {% endif %}
      }
      updateParcEoliens();
      if(query && last_reverse_search != query) {
        last_reverse_search = query;
        reverseGeolocalisation(query, true);
      } else if(!query) {
        mainMap.setView([46,2],5.5);
      } else {
        mainMap.setView([lat, long], 10);
        parcelleMap.setView([lat, long], 10);
      }
      loadCoucheCadastre();
    });

    function loadCoucheCadastre() {
      communeIdsArray = [];
      $('#projet_parcelles tr').each(function(i,element) {
        if($(element).find('select[id$="_commune"]').val() && !communeIdsArray.includes($(element).find('select[id$="_commune"]').val())) {
          communeIdsArray.push($(element).find('select[id$="_commune"]').val());
        }
      });
      if(!communeIdsArray.length) {
        communeIdsArray.push($('#projet_communes option:selected').val());
      }
      if(communeIdsArray.length>0) {
        $.ajax({
          url: "{{ path('france_cadastre') }}",
          dataType: 'json',
          data: {communes: communeIdsArray},
          success:  function(data, textStatus, request) {
            parcels = data;
            buildMap();
            {# L.geoJson(data, {}).addTo(mainMap); #}
          }
        });
      }
    }

    function updateDenomination() {
      commune = $('#projet_communes option:selected').text().replace(/\(.+/, '').trim();
      commune_words = commune.split('-');
      commune_three_chars = '';
      commune_three_chars += commune_words[0][0].toUpperCase();
      if(commune_words[2] !== undefined) {
        commune_three_chars += commune_words[1][0].toUpperCase();
        commune_three_chars += commune_words[2][0].toUpperCase();
      } else if(commune_words[1] !== undefined) {
        commune_three_chars += commune_words[1][0].toUpperCase();
        commune_three_chars += commune_words[1][1].toUpperCase();
      } else {
        commune_three_chars += commune_words[0][1].toUpperCase();
        commune_three_chars += commune_words[0][2].toUpperCase();
      }
      denomination = $('#projet_denomination').val().trim();
      search = denomination.match(/_(\d+)/)
      id = search && search[1] !== undefined ? search[1] : 'id';
      $('#projet_denomination').val(commune_three_chars + '_' + id);
    }

    {# if(!$('#projet_adresse').val()) {
      if($('#projet_communes option:selected').text()) $('#projet_communes').change();
      else $('#projet_departement').change();
    } #}

    updateMarkerPosition(); {# this line is required for edit file #}

    $('#location').change(function() {
      
      var nominatimUrl = 'https://nominatim.openstreetmap.org/search';
      $input = $(this);

      var query = $('#location').val();
      $.ajax({
        type: 'GET',
        url: nominatimUrl,
        data: {
          q: query,
          extratags: 0,
          namedetails: 0,
          polygon_geojson: 0,
          format: 'json',
        },
        dataType: 'json',

      })
      .done(function(data) {

        if (data.length === 0) {
          $input.parent().addClass('has-error');
          return;
        }

        var lat = data[0]['lat'];
        var lon = data[0]['lon'];
        var bbox = data[0]['boundingbox'];
        
        if (bbox != undefined) {
          mainMap.fitBounds([
            [bbox[0], bbox[2]],
            [bbox[1], bbox[3]]
          ]);
        } else {
          mainMap.setView([lat, lon], 10);
        }
        
        $input.parent().removeClass('has-error');
        
      });
      
    });
    
    var geojsonMarkerOptions = {
      radius: 4,
      fillColor: "#ff7800",
      color: "#000",
      weight: 1,
      opacity: 1,
      fillOpacity: 0.8
    };
    $.ajax({
      url: "{{ asset('Poste-source.geojson') }}",
      beforeSend: function(xhr) {
        if (xhr.overrideMimeType) {
          xhr.overrideMimeType("application/json");
        }
      },
      dataType: 'json',
      data: null,
      success:  function(data, textStatus, request) {
        L.geoJson(data, {
          pointToLayer: function (feature, latlng) {
              return L.circleMarker(latlng, geojsonMarkerOptions);
          }
        }).addTo(mainMap);
      }
    });

    var typeProjetIcons = {{ grid_helper.getJsonIconsTypeProjets|raw }};
    var update_type_milieu = false;
    $('#projet_typeProjet').change(function() {
      type = $(this).val();
      label = $(this).parents('div.form-group').find('label');
      if (typeProjetIcons[type] !== undefined && typeProjetIcons[type]['name'].match('<i')) {
        if(label.find('span#projet_typeProjetIcon').length) {
          $(label.find('span#projet_typeProjetIcon').html(typeProjetIcons[type]['name']));
        } else {
          label.append('<span id="projet_typeProjetIcon" style="border-left: solid 2px blue;padding-left: 5px;" class="pull-right">' + typeProjetIcons[type]['name'] + '</span>');
        }
      } else if(typeProjetIcons[type] !== undefined) {
        if(label.find('span#projet_typeProjetIcon').length) {
          label.find('span#projet_typeProjetIcon').remove();
        }
      }
      if(type == 'parc__eolien') {
        $('#projet_typeSite').val('terrain');
        $.each($('#projet_typeSite option'), function(i, element) {
          if($(element).val() == 'terrain') $(element).removeClass('hide');
          else $(element).addClass('hide');
        });
      } else if(type == 'ferme_solaire') {
        if($('#projet_typeSite').val() != 'plan_deau') $('#projet_typeSite').val('terrain');
        $.each($('#projet_typeSite option'), function(i, element) {
          if($(element).val() == 'terrain' || $(element).val() == 'plan_deau') $(element).removeClass('hide');
          else $(element).addClass('hide');
        });
      } else if(type == 'ombriere_solaire') {
        $('#projet_typeSite').val('parking');
        $.each($('#projet_typeSite option'), function(i, element) {
          if($(element).val() == 'parking') $(element).removeClass('hide');
          else $(element).addClass('hide');
        });
      } else if(type == 'eolienne_isolee' || type == 'tracker_solaire') {
        if($('#projet_typeSite').val() != 'parking') $('#projet_typeSite').val('terrain');
        $.each($('#projet_typeSite option'), function(i, element) {
          if($(element).val() == 'terrain' || $(element).val() == 'parking') $(element).removeClass('hide');
          else $(element).addClass('hide');
        });
      } else if(type == 'toiture_solaire') {
        if($('#projet_typeSite').val() != 'nouveau_batiment') $('#projet_typeSite').val('batiment_existant');
        $.each($('#projet_typeSite option'), function(i, element) {
          if($(element).val().match('batiment')) $(element).removeClass('hide');
          else $(element).addClass('hide');
        });
      } else if(type == 'mesure_enviro') {
        $('#projet_typeSite').val('terrain');
        $.each($('#projet_typeSite option'), function(i, element) {
          if($(element).val() == 'terrain') $(element).removeClass('hide');
          else $(element).addClass('hide');
        });
      }
      if(type.match('olien')) {
        $('#projet_technologie').val('eolienne');
        $('#projet_technologie').change();
      } else {
        $('#projet_technologie').val('photovoltaique');
        $('#projet_technologie').change();
      }
      {# denomination = $('#projet_denomination').val().trim();
      search = denomination.match(/_(\d+)$/)
      id = search && search[1] !== undefined ? search[1] : 'id';
      if(!denomination || denomination == 'Esol_'+id || denomination == 'EOi_'+id || denomination == 'Ptoit_'+id || denomination == 'Psol_'+id || denomination == 'Pomb_'+id || denomination == 'Ptrack_'+id) {
        if(type == 'eolienne_isolee') $('#projet_denomination').val('EOi_'+id);
        if(type == 'toiture_solaire') {
          $('#projet_denomination').val('Ptoit_'+id);
          if(update_type_milieu) $('#projet_environnement').val('exploitation_agricole');
        }
        else if(type == 'ferme_solaire') {
          $('#projet_denomination').val('Psol_'+id);
          if(update_type_milieu) $('#projet_environnement').val('terre_arable');
        }
        else if(type == 'ombriere_solaire') $('#projet_denomination').val('Pomb_'+id);
        else if(type == 'tracker_solaire') $('#projet_denomination').val('Ptrack_'+id);
        else if(type == 'mesure_enviro') $('#projet_denomination').val('Menv_'+id);
        else {
          $('#projet_denomination').val('Esol_'+id);
          if(update_type_milieu) $('#projet_environnement').val('terre_arable');
        }
      } #}
    });
    {% if is_granted('ROLE_ADMIN') or projet.origine.id == app.user.id %}
    var contactsUrl = "{{ path('contacts_search') }}";
    function updateContacts() {
      var id = $('#projet_departement').val();
      jQuery.ajax({
          url: contactsUrl,
          method: "POST",
          data: {id: id, confirm: 1},
          dataType: "json",
          success: function (response) {
              var projet_chefProjet = $('#projet_chefProjet').val();
              $('#projet_chefProjet').html('');
              var first_option = false;
              jQuery.each(response.chef_projets, function(index, data) {
                if(!first_option) first_option = data.id;
                first_option = data.id != projet_chefProjet ? first_option : data.id
                var newOption = new Option(data.text, data.id, false, false);
                $('#projet_chefProjet').append(newOption);
              });
              if(first_option) $('#projet_chefProjet').val(first_option);
              else $('#projet_chefProjetTelephone').val('');
              $('#projet_chefProjet').trigger('change');

              var projet_chargeFoncier = $('#projet_chargeFoncier').val();
              $('#projet_chargeFoncier').html('');
              var first_option = false;
              jQuery.each(response.charge_fonciers, function(index, data) {
                if(!first_option) first_option = data.id;
                first_option = data.id != projet_chargeFoncier ? first_option : data.id
                var newOption = new Option(data.text, data.id, false, false);
                $('#projet_chargeFoncier').append(newOption);
              });
              if(first_option) $('#projet_chargeFoncier').val(first_option);
              else $('#projet_chargeFoncierTelephone').val('');
              $('#projet_chargeFoncier').trigger('change');

              var projet_partenaire = $('#projet_partenaire').val();
              $('#projet_partenaire').html('');
              var first_option = false;
              jQuery.each(response.partenaires, function(index, data) {
                if(!first_option) first_option = data.id;
                first_option = data.id != projet_partenaire ? first_option : data.id
                var newOption = new Option(data.text, data.id, false, false);
                $('#projet_partenaire').append(newOption);
              });
              if(first_option) $('#projet_partenaire').val(first_option);
              else $('#projet_partenaireTelephone').val('');
              $('#projet_partenaire').trigger('change');
          }, error: function () {
          }
      });
    }
    updateContacts();
    {% endif %}
    
    function showPopup(layer) {
      var status = layer.options.denomination;
      return status;
    }
    
    function showTooltip(layer) {
      var status = layer.options.denomination;
      return status;
    }

    var markers = {};
    
    var markerIcon = new L.DivIcon.SVGIcon({
      color: '#E53935',
      fillOpacity: 0.7
    });

    var markers = L.markerClusterGroup({
      maxClusterRadius: 40,
    });

    var parcMarkers = {};
    var parcEoliens = {};
    function loadParcMarkers() {
      markers.clearLayers();
      parcMarkers = {};
      $.each(parcEoliens, function(index, parc) {
        var marker = L.marker([parc.latitude, parc.longitude], {
          id: parc.id, 
          icon: markerIcon,
          denomination: parc.denomination,
        })
        .bindTooltip(showTooltip)
        .bindPopup(showPopup);
        
        markers.addLayer(marker);
        
        parcMarkers[parc.id] = marker;
      });
    
      mainMap.addLayer(markers);
    }
    function updateParcEoliens() {
      var departement = $('#projet_departement option:selected').text().replace(/\(.*/, '').trim();
      var commune_id = $('#projet_communes option:selected').val();
      if(departement) {
        jQuery.ajax({
          url: Routing.generate('parc_eoliens_search_by_departement', { departement: departement, commune_id: commune_id }),
          method: "POST",
          dataType: "json", 
          beforeSend: function () {
            markers.clearLayers();
            parcMarkers = {};
            $('#projet_terrain_eoliennesDepartement').val('');
            $('#projet_terrain_eoliennesCommune').val('');
          },
          success: function (response) {
            parcEoliens = response['parc_eoliens_departement'];
            $('#projet_terrain_eoliennesDepartement').val(response['parc_eoliens_departement'].length);
            $('#projet_terrain_eoliennesCommune').val(response['parc_eoliens_commune'].length);
          }, error: function () {
            markers.clearLayers();
            parcMarkers = {};
            $('#projet_terrain_eoliennesDepartement').val('');
            $('#projet_terrain_eoliennesCommune').val('');
          }
        });
      }
    }
    updateParcEoliens();

    var queryCommuneUrl = "{{ path('commune_search') }}";

    $('.datepicker-type').datepicker({
      format: 'dd/mm/yyyy',
      autoclose: true,
      language: 'fr',
      clearBtn: true,
    });
    
    $("#projet_communes").select2({
      ajax: {
        url: function () {
          return queryCommuneUrl + '?departement=' + $('#projet_departement').val();
        },
        dataType: 'json',
        delay: 500,
        processResults: function (data) {
          return {
            results: data
          };
        }
      },
      escapeMarkup: function (markup) { return markup; }, // let our custom formatter work
      minimumInputLength: 1,
    });
    
    $('#tab_parcelles [id*="_commune"]').select2({
      ajax: {
        url: queryCommuneUrl,
        dataType: 'json',
        delay: 500,
        processResults: function (data) {
          return {
            results: data
          };
        }
      },
      escapeMarkup: function (markup) { return markup; }, // let our custom formatter work
      minimumInputLength: 1,
    });
    {% if is_granted('ROLE_ADMIN') or projet.origine.id == app.user.id %}
    $("#tab_contacts td").dblclick(function() {
      if($(this).find('select').length) {
        if($(this).find('select').attr('id') == 'projet_partenaire') {
          var projet_partenaire = $('#projet_partenaire').val();
          $('#projet_partenaire').html($('#projet_origine').html());
          if(projet_partenaire) $('#projet_partenaire').val(projet_partenaire);
          $('#projet_partenaire').trigger('change');
        } else if($(this).find('select').attr('id') == 'projet_chefProjet') {
          var projet_chefProjet = $('#projet_chefProjet').val();
          $('#projet_chefProjet').html($('#projet_origine').html());
          if(projet_chefProjet) $('#projet_chefProjet').val(projet_chefProjet);
          $('#projet_chefProjet').trigger('change');
        } else if($(this).find('select').attr('id') == 'projet_chargeFoncier') {
          var projet_chargeFoncier = $('#projet_chargeFoncier').val();
          $('#projet_chargeFoncier').html($('#projet_origine').html());
          if(projet_chargeFoncier) $('#projet_chargeFoncier').val(projet_chargeFoncier);
          $('#projet_chargeFoncier').trigger('change');
        }
      }
    });
    $("#projet_origine, #projet_chargeFoncier, #projet_chefProjet, #projet_partenaire").select2({placeholder: "Non désigné"});
    var queryMairieUrl = "{{ path('mairie_search') }}";
    
    $("#projet_mairie").select2({
      placeholder: "Non désigné",
      ajax: {
        url: queryMairieUrl,
        dataType: 'json',
        delay: 500,
        processResults: function (data) {
          return {
            results: data
          };
        }
      },
      escapeMarkup: function (markup) { return markup; }, // let our custom formatter work
      minimumInputLength: 1,
    });
    $('#projet_mairie').on('select2:select', function (e) {
      var data = e.params.data;
      $('#projet_mairieTelephone').val(data.telephone);
      setTimeout(function() {$('#select2-projet_mairie-container').text(data.maire);}, 500);
      $('#projet_maire').val(data.maire);
      $('#projet_maireTelephone').val(data.telephone);
    });
    {% endif %}
    function updateMairie(update_maire) {
      var commune_id = $('#projet_communes option:selected').val();
      if(commune_id) {
        jQuery.ajax({
          url: Routing.generate('mairie_search_by_commune', { id: commune_id }),
          method: "POST",
          dataType: "json",
          success: function (response) {
            if(response['mairie']) {
              $('#projet_mairie').append(new Option(response['mairie']['text'], response['mairie']['id']));
              $('#projet_mairie').val(response['mairie']['id']);
              $('#projet_mairieTelephone').val(response['mairie']['telephone']);
              if(update_maire) {
                $('#projet_maire').val(response['mairie']['maire']);
                $('#projet_maireTelephone').val(response['mairie']['telephone']);
              }
            } else {
              $('#projet_mairie').val('');
              $('#projet_mairieTelephone').val('');
              if(update_maire) {
                $('#projet_maire').val('');
                $('#projet_maireTelephone').val('');
              }
            }
            $('#projet_mairie').trigger('change');
          }, error: function () {
          }
        });
      }
    }
    function updateEpci() {
      var commune_id = $('#projet_communes option:selected').val();
      if(commune_id) {
        jQuery.ajax({
          url: Routing.generate('epci_search_by_commune', { id: commune_id }),
          method: "POST",
          dataType: "json", 
          beforeSend: function () {
            $('#contact_epci td:eq(1)').text('-');
            $('#contact_epci td:eq(2)').text('-');
            $('#projet_epci').text('-');
            $('#population > div:eq(0)').html('<label class="col-sm-4 control-label">-:</label><div class="col-sm-8">-</div>');
            $('#population > div:eq(1)').html('<label class="col-sm-4 control-label">-:</label><div class="col-sm-8">-</div>');
            $('#projet_terrain_vitesseVent').val('');
            $('#projet_terrain_productiblePv').val('');
            $('#projet_terrain_altitude').val('');
            $('#projet_terrain_topographie').val('');
            $('#projet_terrain_documentUrbanisme').val('');
            $('#projet_terrain_etatUrbanisme').val('');
          },
          success: function (response) {
            if(response['nom_president']) $('#contact_epci td:eq(1)').text(response['nom_president']);
            if(response['telephone_president']) $('#contact_epci td:eq(2)').text(response['telephone_president']);
            if(response['epci']) $('#projet_epci').html('<input type="text" class="form-control" value="' + response['epci'] + '">');
            $('#population > div:eq(0)').html('<label class="col-sm-4 control-label">'+response['commune']+':</label><div class="col-sm-8">'+response['commune_pop']+'</div>');
            $('#population > div:eq(1)').html('<label class="col-sm-4 control-label">'+response['epci']+':</label><div class="col-sm-8">'+response['epci_pop']+'</div>');
            $('#projet_terrain_vitesseVent').val(response['vitesse_vent']);
            $('#projet_terrain_productiblePv').val(response['productible_pv']);
            $('#projet_terrain_altitude').val(response['altitude']);
            $('#projet_terrain_topographie').val(response['relief']);
            $('#projet_terrain_documentUrbanisme').val(response['urbanisme_type']);
            $('#projet_terrain_etatUrbanisme').val(response['urbanisme_etat']);
          }, error: function () {
            $('#contact_epci td:eq(1)').text('');
            $('#contact_epci td:eq(2)').text('');
            $('#projet_epci').text('');
            $('#population > div:eq(0)').html('<label class="col-sm-4 control-label"></label><div class="col-sm-8"></div>');
            $('#population > div:eq(1)').html('<label class="col-sm-4 control-label"></label><div class="col-sm-8"></div>');
            $('#projet_terrain_vitesseVent').val('');
            $('#projet_terrain_productiblePv').val('');
            $('#projet_terrain_altitude').val('');
            $('#projet_terrain_topographie').val('');
            $('#projet_terrain_documentUrbanisme').val('');
            $('#projet_terrain_etatUrbanisme').val('');
          }
        });
      }
    }
    updateMairie(true);
    {% if form.vars.value.communes[0].id is defined %}
      updateEpci();
    {% endif %}

    $('#projet_batimentExistant_longueur, #projet_batimentExistant_largeur').change(function() {
      var longueur = $('#projet_batimentExistant_longueur').val().trim();
      var largeur = $('#projet_batimentExistant_largeur').val().trim();
      if(!longueur || !largeur) $('#projet_batimentExistant_surfaceSol').val(0);
      else {
        longueur = parseInt(longueur);
        largeur = parseInt(largeur);
        $('#projet_batimentExistant_surfaceSol').val(longueur * largeur);
      }
    });
    $('#projet_batimentExistant_toitures').on('change', '[id*="_longueur"],[id*="_largeur"]', function() {
      var longueur = $(this).parents('tr').find('[id*="_longueur"]').val().trim();
      var largeur = $(this).parents('tr').find('[id*="_largeur"]').val().trim();
      if(!longueur || !largeur) $(this).parents('tr').find('[id*="_surfaceTotale"]').val(0);
      else {
        longueur = parseInt(longueur);
        largeur = parseInt(largeur);
        $(this).parents('tr').find('[id*="_surfaceTotale"]').val(longueur * largeur);
      }
    });
    
    {% if form.vars.value.batimentExistant.photo is defined and form.vars.value.batimentExistant.photo %}
      if(!$('#batiment_photo').length) $('<button id="batiment_photo" class="btn btn-info btn-sm popup_fichier" data-toggle="modal" data-target=".bs-modal-lg">Afficher</button>').insertAfter('#projet_batimentExistant_photoFile');

      $('#batiment_photo').attr('data-href', '{{ asset('upload/' ~ form.vars.value.batimentExistant.photo) }}');
      $('#batiment_photo').attr('data-download', '{{ form.vars.value.batimentExistant.photo }}');
      $('#batiment_photo').attr('data-src', '{{ asset('upload/' ~ form.vars.value.batimentExistant.photo) }}');
    {% endif %}
    
    $('#projet_batimentExistant_photoFile').change(function() {
      if (this.files && this.files[0]) {
        var reader = new FileReader();
        
        reader.onload = function(e) {
          if(!$('#batiment_photo').length) $('<button id="batiment_photo" class="btn btn-info btn-sm popup_fichier" data-toggle="modal" data-target=".bs-modal-lg">Afficher</button>').insertAfter('#projet_batimentExistant_photoFile');

          $('#batiment_photo').attr('data-href', '#');
          $('#batiment_photo').removeAttr('data-download');
          $('#batiment_photo').attr('data-src', e.target.result);
          $('#popup_photo a').attr('href', '#');
          $('#popup_photo a').removeAttr('download');
          $('#popup_photo img:eq(1)').attr('src', e.target.result);
        }
        
        reader.readAsDataURL(this.files[0]); // convert to base64 string
      }
    });
    
    {% if form.vars.value.photoImplantation is defined and form.vars.value.photoImplantation %}
      if(!$('#implantation_photo').length) $('<button id="implantation_photo" class="btn btn-info btn-sm popup_fichier" data-toggle="modal" data-target=".bs-modal-lg">Afficher</button>').insertAfter('#projet_photoImplantationFile');

      $('#implantation_photo').attr('data-href', '{{ asset('upload/' ~ form.vars.value.photoImplantation) }}');
      $('#implantation_photo').attr('data-download', '{{ form.vars.value.photoImplantation }}');
      $('#implantation_photo').attr('data-src', '{{ asset('upload/' ~ form.vars.value.photoImplantation) }}');
    {% endif %}

    {% if form.vars.value.documents is defined and form.vars.value.documents is not empty %}
      {% for document in form.vars.value.documents %}
        {% if document.plan or 'jpeg' in document.document|lower or 'jpg' in document.document|lower or 'png' in document.document|lower %}
          if(!$('#documents_{{ loop.index0 }}_photo').length) $('<button id="documents_{{ loop.index0 }}_photo" class="btn btn-info btn-sm popup_fichier" data-toggle="modal" data-target=".bs-modal-lg">Afficher</button>').insertAfter('#projet_documents_{{ loop.index0 }}_documentFile');

          $('#documents_{{ loop.index0 }}_photo').attr('data-href', '{{ asset('upload/' ~ document.document) }}');
          $('#documents_{{ loop.index0 }}_photo').attr('data-download', '{{ document.document }}');
          $('#documents_{{ loop.index0 }}_photo').attr('data-src', '{{ asset('upload/' ~ document.document) }}');
        {% else %}
          if(!$('#documents_{{ loop.index0 }}_photo').length) $('<a id="documents_{{ loop.index0 }}_photo" class="btn btn-info btn-sm" download="{{ document.document }}" href="{{ asset('upload/' ~ document.document) }}">Télécharger</a>').insertAfter('#projet_documents_{{ loop.index0 }}_documentFile');
        {% endif %}
      {% endfor %}
    {% endif %}
    
    var next_document_id = -1;
    $('#projet_photoImplantationFile').change(function() {
      if(next_document_id == -1) next_document_id = $('#projet_documents tr').length;
      if (this.files && this.files[0]) {
        var reader = new FileReader();
        
        reader.onload = function(e) {
          if(!$('#implantation_photo').length) $('<button id="implantation_photo" class="btn btn-info btn-sm popup_fichier" data-toggle="modal" data-target=".bs-modal-lg">Afficher</button>').insertAfter('#projet_photoImplantationFile');

          $('#implantation_photo').attr('data-href', '#');
          $('#implantation_photo').removeAttr('data-download');
          $('#implantation_photo').attr('data-src', e.target.result);
          $('#popup_photo a').attr('href', '#');
          $('#popup_photo a').removeAttr('download');
          $('#popup_photo img:eq(1)').attr('src', e.target.result);

          if($('#projet_documents_'+next_document_id+'_plan').length && !$('#projet_documents_'+next_document_id+'_plan').prop('checked')) 
            next_document_id =$('#projet_documents tr').length;
          if(!$('#projet_documents_'+next_document_id+'_type').length) $('#projet_documents_add_entry').click();
          $('#projet_documents_'+next_document_id+'_type').val($('#projet_typeImplantation option:selected').text());
          $('#projet_documents_'+next_document_id+'_titre').val($('#projet_titreImplantation option:selected').text());
          $('#projet_documents_'+next_document_id+'_plan').prop('checked', true);
        }
        
        reader.readAsDataURL(this.files[0]); // convert to base64 string
      }
    });
    $('#projet_typeImplantation, #projet_titreImplantation').change(function() {
      if(next_document_id != -1) {
        if(!$('#projet_documents_'+next_document_id+'_type').length) $('#projet_documents_add_entry').click();
        $('#projet_documents_'+next_document_id+'_type').val($('#projet_typeImplantation option:selected').text());
        $('#projet_documents_'+next_document_id+'_titre').val($('#projet_titreImplantation option:selected').text());
            $('#projet_documents_'+next_document_id+'_plan').prop('checked', true);
      }
    });
    $('body').on('click', '#popup_photo_close', function() {
      $('.bs-modal-lg').modal('hide');
    });
    $('body').on('click', '.popup_fichier', function(e) {
      e.preventDefault();
      $('#popup_photo a').attr('href', $(this).attr('data-href'));
      $('#popup_photo a').attr('download', $(this).attr('data-download'));
      $('#popup_photo img:eq(1)').attr('src', $(this).attr('data-src'));
    });

    var $collectionHolder = $('#projet_finances');
    var prototype = $collectionHolder.data('prototype');

    $('#projet_finances_add_entry').click(function () {
      var length = $collectionHolder.children().length;
      var entry = prototype.replace(/__name__label__/g, length);
      entry = entry.replace(/__name__/g, length);
      $collectionHolder.append(entry);

      $('#projet_finances_' + length + '_dateEngmt').datepicker({
        format: 'dd/mm/yyyy',
        autoclose: true,
        language: 'fr',
      });
      $('#projet_finances_' + length + '_dateEcheance').datepicker({
        format: 'dd/mm/yyyy',
        autoclose: true,
        language: 'fr',
        clear: true,
      });
      $('#projet_finances_' + length + '_dateFacture').datepicker({
        format: 'dd/mm/yyyy',
        autoclose: true,
        language: 'fr',
        clear: true,
      });
      commandeUpdate();
    });

    $('#projet_finances_duplicate_entry').click(function () {
      if(!$(this).hasClass('disabled') && $collectionHolder.find('tr.info:eq(0)').length) {
        var tr_index = $collectionHolder.find('tr.info:eq(0)').index() + 1;
        var clone = $collectionHolder.find('tr.info:eq(0)').clone();
        var cloned = 0;
        for(i=0; i<20; i++) {
          if(!cloned) {
            if(!$collectionHolder.find('tr:eq('+tr_index+')').length || typeof $collectionHolder.find('tr:eq('+tr_index+')').attr('duplicate') === 'undefined' || $collectionHolder.find('tr:eq('+tr_index+')').attr('duplicate') === false || $collectionHolder.find('tr:eq('+tr_index+')').attr('duplicate') != $collectionHolder.find('tr.info:eq(0)').index()) {
              $(clone).insertAfter($collectionHolder.find('tr:eq('+(tr_index-1)+')'));
              $collectionHolder.find('tr:eq('+tr_index+')').removeClass('info');
              $collectionHolder.find('tr:eq('+tr_index+')').attr('duplicate', $collectionHolder.find('tr.info:eq(0)').index());
              $collectionHolder.find('tr:eq('+tr_index+')').find('[id*="_phase"]').val($collectionHolder.find('tr:eq('+(tr_index-1)+')').find('[id*="_phase"]').val());
              $collectionHolder.find('tr:eq('+tr_index+')').find('[id*="_bureau"]').val($collectionHolder.find('tr:eq('+(tr_index-1)+')').find('[id*="_bureau"]').val());
              $collectionHolder.find('tr:eq('+tr_index+')').find('[id*="_montantEngage"]').val('0');
              $collectionHolder.find('tr:eq('+tr_index+')').find('[id*="_montantPaye"]').val('0');
              $collectionHolder.find('tr:eq('+tr_index+')').find('[id*="_montantRestant"]').val('');
              {# $collectionHolder.find('tr:eq('+tr_index+')').find('[id*="_dateFacture"]').val(''); #}
              $collectionHolder.find('tr:eq('+tr_index+')').find('[id*="_duplique"]').val($collectionHolder.find('tr.info:eq(0)').index());
              cloned = 1;
            } else {
              if(!$collectionHolder.find('tr:eq('+tr_index+')').length) cloned = 1;
              tr_index++;
            }
          }
        }
        if(cloned) {
          $collectionHolder.children().each(function() {
            tr_index = $(this).index();
            $(this).find('input').each(function() {
              name = $(this).attr('name').replace(/\[\d+\]/, '['+tr_index+']');
              $(this).attr('name', name);
              id = $(this).attr('id').replace(/_\d+_/, '_'+tr_index+'_');
              $(this).attr('id', id);
            });
            $(this).find('select').each(function() {
              name = $(this).attr('name').replace(/\[\d+\]/, '['+tr_index+']');
              $(this).attr('name', name);
              id = $(this).attr('id').replace(/_\d+_/, '_'+tr_index+'_');
              $(this).attr('id', id);
            });
          });
        }
        {# $collectionHolder.children().removeClass('info');
        $('#projet_finances_duplicate_entry').addClass('disabled'); #}
        commandeUpdate();
      }
    });

    $('#projet_finances_remove_entry').click(function () {
      $('> :last-child', $collectionHolder).remove();
    });
    
    $($collectionHolder).on('click', 'tr', function() {
      if(!$(this).find('[id*="_duplique"]').val()) {
        $collectionHolder.children().removeClass('info');
        $(this).addClass('info');
        if($collectionHolder.children().length) $('#projet_finances_duplicate_entry').removeClass('disabled');
      }
    });
    
    var $collectionHolderProprietaire = $('#projet_proprietaires');
    var prototypeproprietaire = $collectionHolderProprietaire.data('prototype');

    $('#projet_proprietaires_add_entry').click(function () {
      var length = $collectionHolderProprietaire.children().length / 7;
      var entry = prototypeproprietaire.replace(/__name__label__/g, length);
      entry = entry.replace(/__name__/g, length);
      $collectionHolderProprietaire.append(entry);

      $('#projet_proprietaires_' + length + '_accordProprietaire').val('NON');
      $('#projet_proprietaires_' + length + '_accordExploitant').val('NON');
      $('#projet_proprietaires_' + length + '_dateSignatureProprietaire').datepicker({
        format: 'dd/mm/yyyy',
        autoclose: true,
        language: 'fr',
        clear: true,
      });
      $('#projet_proprietaires_' + length + '_dateEcheanceProprietaire').datepicker({
        format: 'dd/mm/yyyy',
        autoclose: true,
        language: 'fr',
        clearBtn: true,
      });
      $('#projet_proprietaires_' + length + '_dateNaissanceProprietaire').datepicker({
        format: 'dd/mm/yyyy',
        autoclose: true,
        language: 'fr',
        clearBtn: true,
      });
  
      $('#projet_proprietaires_' + length + '_dateSignatureProprietaire2').datepicker({
        format: 'dd/mm/yyyy',
        autoclose: true,
        language: 'fr',
        clear: true,
      });
      $('#projet_proprietaires_' + length + '_dateEcheanceProprietaire2').datepicker({
        format: 'dd/mm/yyyy',
        autoclose: true,
        language: 'fr',
        clearBtn: true,
      });
      $('#projet_proprietaires_' + length + '_dateNaissanceProprietaire2').datepicker({
        format: 'dd/mm/yyyy',
        autoclose: true,
        language: 'fr',
        clearBtn: true,
      });
  
      $('#projet_proprietaires_' + length + '_dateSignatureProprietaire3').datepicker({
        format: 'dd/mm/yyyy',
        autoclose: true,
        language: 'fr',
        clear: true,
      });
      $('#projet_proprietaires_' + length + '_dateEcheanceProprietaire3').datepicker({
        format: 'dd/mm/yyyy',
        autoclose: true,
        language: 'fr',
        clearBtn: true,
      });
      $('#projet_proprietaires_' + length + '_dateNaissanceProprietaire3').datepicker({
        format: 'dd/mm/yyyy',
        autoclose: true,
        language: 'fr',
        clearBtn: true,
      });
  
      $('#projet_proprietaires_' + length + '_dateSignatureProprietaire4').datepicker({
        format: 'dd/mm/yyyy',
        autoclose: true,
        language: 'fr',
        clear: true,
      });
      $('#projet_proprietaires_' + length + '_dateEcheanceProprietaire4').datepicker({
        format: 'dd/mm/yyyy',
        autoclose: true,
        language: 'fr',
        clearBtn: true,
      });
      $('#projet_proprietaires_' + length + '_dateNaissanceProprietaire4').datepicker({
        format: 'dd/mm/yyyy',
        autoclose: true,
        language: 'fr',
        clearBtn: true,
      });
  
      $('#projet_proprietaires_' + length + '_dateSignatureExploitant').datepicker({
        format: 'dd/mm/yyyy',
        autoclose: true,
        language: 'fr',
        clearBtn: true,
      });
      $('#projet_proprietaires_' + length + '_dateEcheanceExploitant').datepicker({
        format: 'dd/mm/yyyy',
        autoclose: true,
        language: 'fr',
        clearBtn: true,
      });
      $('#projet_proprietaires_' + length + '_dateNaissanceExploitant').datepicker({
        format: 'dd/mm/yyyy',
        autoclose: true,
        language: 'fr',
        clearBtn: true,
      });
  
      $('#projet_proprietaires_' + length + '_dateSignatureExploitant2').datepicker({
        format: 'dd/mm/yyyy',
        autoclose: true,
        language: 'fr',
        clearBtn: true,
      });
      $('#projet_proprietaires_' + length + '_dateEcheanceExploitant2').datepicker({
        format: 'dd/mm/yyyy',
        autoclose: true,
        language: 'fr',
        clearBtn: true,
      });
      $('#projet_proprietaires_' + length + '_dateNaissanceExploitant2').datepicker({
        format: 'dd/mm/yyyy',
        autoclose: true,
        language: 'fr',
        clearBtn: true,
      });
  
      $('#projet_proprietaires_' + length + '_dateSignatureExploitant3').datepicker({
        format: 'dd/mm/yyyy',
        autoclose: true,
        language: 'fr',
        clearBtn: true,
      });
      $('#projet_proprietaires_' + length + '_dateEcheanceExploitant3').datepicker({
        format: 'dd/mm/yyyy',
        autoclose: true,
        language: 'fr',
        clearBtn: true,
      });
      $('#projet_proprietaires_' + length + '_dateNaissanceExploitant3').datepicker({
        format: 'dd/mm/yyyy',
        autoclose: true,
        language: 'fr',
        clearBtn: true,
      });
      
      $('#tab_contacts tbody').append('<tr rel="'+length+'" class="hide"><td>Propriétaire</td>><td>-</td><td>-</td></tr><tr rel="'+length+'" class="hide"><td>Propriétaire 2</td>><td>-</td><td>-</td></tr><tr rel="'+length+'" class="hide"><td>Propriétaire 3</td>><td>-</td><td>-</td></tr><tr rel="'+length+'" class="hide"><td>Exploitant</td><td>-</td><td>-</td></tr><tr rel="'+length+'" class="hide"><td>Exploitant 2</td><td>-</td><td>-</td></tr><tr rel="'+length+'" class="hide"><td>Exploitant 3</td><td>-</td><td>-</td></tr>');
      loadAllParcellesTags();
    });

    $('#projet_proprietaires_duplicate_entry').click(function () {
      if(!$(this).hasClass('disabled') && $collectionHolderProprietaire.find('tr.info').length == 7) {
        var tr_index = $collectionHolderProprietaire.find('tr.info:eq(2)').index() + 1;
        var clone = $collectionHolderProprietaire.find('tr.info').clone();
        var cloned = 0;
        $(clone).insertAfter($collectionHolderProprietaire.find('tr:eq('+(tr_index-1)+')'));
        $collectionHolderProprietaire.find('tr:eq('+tr_index+')').removeClass('info');
        $collectionHolderProprietaire.find('tr:eq('+(tr_index + 1)+')').removeClass('info');
        $collectionHolderProprietaire.find('tr:eq('+(tr_index + 2)+')').removeClass('info');
        
        $collectionHolderProprietaire.find('tr:eq('+tr_index+')').find('[id$="_civiliteProprietaire"]').val($collectionHolderProprietaire.find('tr:eq('+(tr_index-3)+')').find('[id$="_civiliteProprietaire"]').val());
        $collectionHolderProprietaire.find('tr:eq('+(tr_index + 1)+')').find('[id$="_civiliteExploitant"]').val($collectionHolderProprietaire.find('tr:eq('+(tr_index-2)+')').find('[id$="_civiliteExploitant"]').val());
        $collectionHolderProprietaire.find('tr:eq('+(tr_index + 2)+')').find('[id$="_civiliteProprietaire2"]').val($collectionHolderProprietaire.find('tr:eq('+(tr_index-1)+')').find('[id$="_civiliteProprietaire2"]').val());
        
        $collectionHolderProprietaire.find('tr:eq('+tr_index+')').find('[id$="_qualiteProprietaire"]').val($collectionHolderProprietaire.find('tr:eq('+(tr_index-3)+')').find('[id$="_qualiteProprietaire"]').val());
        $collectionHolderProprietaire.find('tr:eq('+(tr_index + 1)+')').find('[id$="_qualiteExploitant"]').val($collectionHolderProprietaire.find('tr:eq('+(tr_index-2)+')').find('[id$="_qualiteExploitant"]').val());
        $collectionHolderProprietaire.find('tr:eq('+(tr_index + 2)+')').find('[id$="_qualiteProprietaire2"]').val($collectionHolderProprietaire.find('tr:eq('+(tr_index-1)+')').find('[id$="_qualiteProprietaire2"]').val());
        
        $collectionHolderProprietaire.find('tr:eq('+tr_index+')').find('[id$="_accordProprietaire"]').val($collectionHolderProprietaire.find('tr:eq('+(tr_index-3)+')').find('[id$="_accordProprietaire"]').val());
        $collectionHolderProprietaire.find('tr:eq('+(tr_index + 1)+')').find('[id$="_accordExploitant"]').val($collectionHolderProprietaire.find('tr:eq('+(tr_index-2)+')').find('[id$="_accordExploitant"]').val());
        $collectionHolderProprietaire.find('tr:eq('+(tr_index + 2)+')').find('[id$="_accordProprietaire2"]').val($collectionHolderProprietaire.find('tr:eq('+(tr_index-1)+')').find('[id$="_accordProprietaire2"]').val());
        
        $collectionHolderProprietaire.find('tr:eq('+tr_index+')').find('[id$="_droitProprietaire"]').val($collectionHolderProprietaire.find('tr:eq('+(tr_index-3)+')').find('[id$="_droitProprietaire"]').val());
        $collectionHolderProprietaire.find('tr:eq('+(tr_index + 1)+')').find('[id$="_droitExploitant"]').val($collectionHolderProprietaire.find('tr:eq('+(tr_index-2)+')').find('[id$="_droitExploitant"]').val());
        $collectionHolderProprietaire.find('tr:eq('+(tr_index + 2)+')').find('[id$="_droitProprietaire2"]').val($collectionHolderProprietaire.find('tr:eq('+(tr_index-1)+')').find('[id$="_droitProprietaire2"]').val());
        
        $collectionHolderProprietaire.find('tr:eq('+tr_index+')').find('[id$="_maritalProprietaire"]').val($collectionHolderProprietaire.find('tr:eq('+(tr_index-3)+')').find('[id$="_maritalProprietaire"]').val());
        $collectionHolderProprietaire.find('tr:eq('+(tr_index + 1)+')').find('[id$="_maritalExploitant"]').val($collectionHolderProprietaire.find('tr:eq('+(tr_index-2)+')').find('[id$="_maritalExploitant"]').val());
        $collectionHolderProprietaire.find('tr:eq('+(tr_index + 2)+')').find('[id$="_maritalProprietaire2"]').val($collectionHolderProprietaire.find('tr:eq('+(tr_index-1)+')').find('[id$="_maritalProprietaire2"]').val());
        cloned = 1;
        if(cloned) {
          $collectionHolderProprietaire.children().each(function() {
            {# if($(this).attr('class').match('proprietaire_entry') foncierTypehead($(this).index()); #}
            if ($(this).attr('class').match('proprietaire_entry')) {
              tr_index = $(this).index();
            } else if ($(this).attr('class').match('exploitant_entry')) {
              tr_index = $(this).index() - 1;
            } else if ($(this).attr('class').match('proprietaire2_entry')) {
              tr_index = $(this).index() - 2;
            }
        
            $(this).find('input').each(function() {
              if($(this).attr('name') !== undefined) {
                name = $(this).attr('name').replace(/\[\d+\]/, '['+(tr_index/3)+']');
                $(this).attr('name', name);
                id = $(this).attr('id').replace(/_\d+_/, '_'+(tr_index/3)+'_');
                $(this).attr('id', id);
              }
            });
            $(this).find('select').each(function() {
              name = $(this).attr('name').replace(/\[\d+\]/, '['+(tr_index/3)+']');
              $(this).attr('name', name);
              id = $(this).attr('id').replace(/_\d+_/, '_'+(tr_index/3)+'_');
              $(this).attr('id', id);
            });
          });
        }
        loadAllParcellesTags();
      }
    });

    $('#projet_proprietaires_add_proprietaire_entry').click(function () {
      if (!$(this).hasClass('disabled') && $collectionHolderProprietaire.find('tr.info').length == 7) {
        if ($collectionHolderProprietaire.find('tr[class*="info"][class*="proprietaire"][class*="hide"]:eq(0)').length) {
          $collectionHolderProprietaire.find('tr[class*="info"][class*="proprietaire"][class*="hide"]:eq(0)').removeClass('hide');
          if (!$collectionHolderProprietaire.find('tr[class*="info"][class*="proprietaire"][class*="hide"]:eq(0)').length) {
            $('#projet_proprietaires_add_proprietaire_entry').addClass('disabled');
          }
        }
      }
    });

    $('#projet_proprietaires_add_exploitant_entry').click(function () {
      if (!$(this).hasClass('disabled') && $collectionHolderProprietaire.find('tr.info').length == 7) {
        if ($collectionHolderProprietaire.find('tr[class*="info"][class*="exploitant"][class*="hide"]:eq(0)').length) {
          $collectionHolderProprietaire.find('tr[class*="info"][class*="exploitant"][class*="hide"]:eq(0)').removeClass('hide');
          if (!$collectionHolderProprietaire.find('tr[class*="info"][class*="exploitant"][class*="hide"]:eq(0)').length) {
            $('#projet_proprietaires_add_exploitant_entry').addClass('disabled');
          }
        }
      }
    });
    
    $('#projet_proprietaires_publish_entry').click(function () {
      if(!$(this).hasClass('disabled') && $collectionHolderProprietaire.find('tr.info').length == 7) {
        var tr_proprietaire = $collectionHolderProprietaire.find('tr.info:eq(0)');
        var tr_proprietaire2 = $collectionHolderProprietaire.find('tr.info:eq(1)');
        var tr_proprietaire3 = $collectionHolderProprietaire.find('tr.info:eq(2)');
        var tr_proprietaire4 = $collectionHolderProprietaire.find('tr.info:eq(3)');
        var tr_exploitant = $collectionHolderProprietaire.find('tr.info:eq(4)');
        var tr_exploitant2 = $collectionHolderProprietaire.find('tr.info:eq(5)');
        var tr_exploitant3 = $collectionHolderProprietaire.find('tr.info:eq(6)');
        var publish_form = $('#publish_form');
        var fields = [];
        // name, type, value
        fields.push(['PARTIES', 'title', '']);
        fields.push(['proprietaire_civilite', 'field', tr_proprietaire.find('select[id$="_civiliteProprietaire"]').val()]);
        fields.push(['proprietaire_identite', 'field', tr_proprietaire.find('input[id$="_proprietaire"]').val()]);
        fields.push(['proprietaire_qualite', 'field', tr_proprietaire.find('select[id$="_qualiteProprietaire"]').val()]);
        fields.push(['proprietaire_adresse', 'field', tr_proprietaire.find('input[id$="_adresseProprietaire"]').val()]);
        fields.push(['proprietaire_droit', 'field', tr_proprietaire.find('select[id$="_droitProprietaire"]').val()]);
        fields.push(['proprietaire_marital', 'field', tr_proprietaire.find('select[id$="_maritalProprietaire"]').val()]);
        fields.push(['proprietaire_ne_le', 'field', tr_proprietaire.find('input[id$="_dateNaissanceProprietaire"]').val()]);
        fields.push(['proprietaire_ne_a', 'field', tr_proprietaire.find('input[id$="_lieuNaissanceProprietaire"]').val()]);
        fields.push(['exploitant_civilite', 'field', tr_exploitant.find('select[id$="_civiliteExploitant"]').val()]);
        fields.push(['exploitant_identite', 'field', tr_exploitant.find('input[id$="_exploitant"]').val()]);
        fields.push(['exploitant_qualite', 'field', tr_exploitant.find('select[id$="_qualiteExploitant"]').val()]);
        fields.push(['exploitant_adresse', 'field', tr_exploitant.find('input[id$="_adresseExploitant"]').val()]);
        fields.push(['exploitant_ne_le', 'field', tr_exploitant.find('input[id$="_dateNaissanceExploitant"]').val()]);
        fields.push(['exploitant_ne_a', 'field', tr_exploitant.find('input[id$="_lieuNaissanceExploitant"]').val()]);
        fields.push(['exploitant_droit', 'field', tr_exploitant.find('select[id$="_droitExploitant"]').val()]);
        fields.push(['exploitant_marital', 'field', tr_exploitant.find('select[id$="_maritalExploitant"]').val()]);

        if($('#projet_technologie').val() == 'eolienne') {
          fields.push(['WKN', 'title', '']);
          fields.push(['WKN_Raison_sociale', 'field', 'WKN France']);
          fields.push(['Type de groupement', 'field', 'SASU']);
          fields.push(['WKN_capital_social', 'field', '500000 €']);
          fields.push(['WKN_siege_social', 'field', 'immeuble « le Sanitat », 10, rue Charles Brunellière 44100 NANTES']);
          fields.push(['WKN_immatriculation', 'field', 'RCS de Nantes']);
          fields.push(['WKN_numero', 'field', 'B 443 622 295']);
          fields.push(['WKN_representant', 'field', 'Roland STANZE']);
          fields.push(['BAIL', 'title', '']);
          fields.push(['montant_base', 'field', 'CINQ CENTS EUROS (500 €)']);
          fields.push(['montant_exploitation', 'field', 'DEUX MILLE CINQ CENTS EUROS (2500€), par an']);
          fields.push(['montant_pdf', 'field', 'MILLE CINQ CENTS (1.500 €) par an']);
          fields.push(['part_proprietaire', 'field', '50%']);
          fields.push(['part_exploitant', 'field', '50%']);
          fields.push(['montant_fin_exploit', 'field', 'CINQ CENTS (500) € par an']);
          fields.push(['montant_reseau', 'field', 'UN (1) euros et CINQUANTE (50) centimes']);
          fields.push(['montant_surplomb', 'field', 'TROIS CENTS (300) euros par an']);
          fields.push(['montant_passage', 'field', 'CINQUANTE (50) centimes d’euros par mètre carré et par an']);
          fields.push(['emprise_eolienne', 'field', $('#projet_emprise').val() + ' m²']);
          fields.push(['emprise_pdf', 'field', '200 m²']);
          fields.push(['exclusivite_dist', 'field', 'MILLE CINQ CENTS (1 500) mètres']);
          fields.push(['duree_bail', 'field', 'TRENTE (30)  années']);
          fields.push(['xprorogation_bail', 'field', 'UNE (1) fois']);
          fields.push(['tprorogation_bail', 'field', 'DIX (10) années']);
          fields.push(['avis_entree', 'field', 'QUINZE (15) jours']);
          fields.push(['avis_demantellement', 'field', 'UN (1) mois']);
          fields.push(['delais_entree', 'field', '']);
          fields.push(['largeur_enligne', 'field', 'CINQ (5) mètres']);
          fields.push(['largeur_encourbe', 'field', 'DIX (10) mètres']);
          fields.push(['duree_promesse', 'field', 'HUIT (8) années']);
          fields.push(['SIGNATURES', 'title', '']);
          fields.push(['exemplaires', 'field', 'DEUX (2)']);
          fields.push(['date_signature', 'field', '{{ "now"|date("d/m/Y") }}']);
          fields.push(['lieu_signature', 'field', '']);
          fields.push(['representant_societe', 'field', '']);
          fields.push(['societe', 'field', 'WKN France']);
          fields.push(['ANNEXES', 'title', '']);
          var selectedParcelles = tr_proprietaire.find('input[id$="_parcelles"]').val().trim().split(',');
          var parcellesArray = [];
          if($('#projet_parcelles tr').length) {
            $('#projet_parcelles tr').each(function(i,element) {
              if(selectedParcelles.includes($(element).find('td:eq(0) input[name]').val().trim())) {
                parcellesArray.push([$(element).find('td:eq(0) input[name]').val(), $(element).find('td:eq(2) select option:selected').text().replace(/\(.+/, '').trim(), $(element).find('td:eq(3) input[name]').val().trim(), $(element).find('td:eq(4) input[name]').val().trim()]);
              }
            });
          }
          fields.push(['publish_parcelles', 'field', JSON.stringify(parcellesArray)]);
          {# fields.push(['Né(e) le', 'field', '']);
          fields.push(['Demeurant à', 'field', '']);
          fields.push(['Représenté(e) par', 'field', '']); #}
        } else {
          fields.push(['representant', 'field', '']);
          fields.push(['representant_proprietaire', 'field', '']);
          fields.push(['representant_exploitant', 'field', '']);
          fields.push(['representant_wkn', 'field', '']);
          fields.push(['WKN', 'title', '']);
          fields.push(['WKN_Raison_sociale', 'field', 'WKN France']);
          fields.push(['Type de groupement', 'field', 'SASU']);
          fields.push(['WKN_capital_social', 'field', '500000 €']);
          fields.push(['WKN_siege_social', 'field', 'immeuble « le Sanitat », 10, rue Charles Brunellière 44100 NANTES']);
          fields.push(['WKN_immatriculation', 'field', 'RCS de Nantes']);
          fields.push(['WKN_numero', 'field', 'B 443 622 295']);
          fields.push(['WKN_representant', 'field', 'Roland STANZE']);
          fields.push(['EXPOSE', 'title', '']);
          var tr_index = $collectionHolderProprietaire.find('tr.info:eq(1)').index() + 1;
          fields.push(['commune', 'field', $('#projet_parcelles_' + (tr_index/2) + '_commune option:selected').text()]);
          fields.push(['BAIL', 'title', '']);
          fields.push(['montant_base', 'field', 'DEUX MILLE CINQ CENT EUROS (2500 €)']);
          fields.push(['montant_exploitation', 'field', 'DEUX MILLE CINQ CENT EUROS (2500 €)']);
          fields.push(['part_proprietaire', 'field', '50%']);
          fields.push(['part_exploitant', 'field', '50%']);
          fields.push(['duree_bail', 'field', 'DIX HUIT (18)']);
          fields.push(['xprorogation_bail', 'field', 'Cinq (5) années']);
          fields.push(['tprorogation_bail', 'field', 'DEUX (2) fois']);
          fields.push(['avis1_LRAR', 'field', 'SIX (6) mois pleins']);
          fields.push(['delais1_levee_doption', 'field', 'DEUX (2) années pleines']);
          fields.push(['delais2_levee_doption', 'field', 'UNE (1) année(s) pleine(s)']);
          fields.push(['avis2_LRAR', 'field', 'SIX (6) mois pleins']);
          fields.push(['ptf_mois', 'field', '5 (cinq)']);
          fields.push(['ptf_%capex', 'field', '25%']);
          fields.push(['puissance', 'field', '5 Mwc (cinq mégawatts-crête)']);
          fields.push(['pdl', 'field', 'UN (1) poste']);
          fields.push(['avis_entree', 'field', 'DIX (10) jours']);
          fields.push(['SERVITUDES', 'title', '']);
          fields.push(['delais_servitudes', 'field', 'SIX (6) mois pleins']);
          fields.push(['largeur_enligne', 'field', 'QUATRE (4) mètres']);
          fields.push(['largeur_encourbe', 'field', 'DIX (10) mètres']);
          fields.push(['PROMESSE', 'title', '']);
          fields.push(['duree_promesse', 'field', 'Cinq (5) années']);
          fields.push(['ndelais_promesse', 'field', '2 (deux) fois']);
          fields.push(['prorogation_promesse', 'field', '2 (deux) années']);
          fields.push(['LRAR1_promesse', 'field', '6 (six) mois']);
          fields.push(['indeminite_sinon', 'field', 'CINQ CENT EUROS (500€)']);
          fields.push(['n_annexe', 'field', '6 (six)']);
          fields.push(['SIGNATURES', 'title', '']);
          fields.push(['lesExemplaires', 'field', 'DEUX (2)']);
          fields.push(['date_signature', 'field', '{{ "now"|date("d/m/Y") }}']);
          fields.push(['lieu_signature', 'field', '']);
          fields.push(['representant_societe', 'field', '']);
          fields.push(['societe', 'field', 'WKN France']);
          fields.push(['ANNEXES', 'title', '']);
          var selectedParcelles = tr_proprietaire.find('input[id$="_parcelles"]').val().trim().split(',');
          var parcellesArray = [];
          if($('#projet_parcelles tr').length) {
            $('#projet_parcelles tr').each(function(i,element) {
              if(selectedParcelles.includes($(element).find('td:eq(0) input[name]').val().trim())) {
                parcellesArray.push([$(element).find('td:eq(0) input[name]').val(), $(element).find('td:eq(2) select option:selected').text().replace(/\(.+/, '').trim(), $(element).find('td:eq(3) input[name]').val().trim(), $(element).find('td:eq(4) input[name]').val().trim()]);
              }
            });
          }
          fields.push(['publish_parcelles', 'field', JSON.stringify(parcellesArray)]);
          {# fields.push(['Né(e) le', 'field', '']);
          fields.push(['Demeurant à', 'field', '']);
          fields.push(['Représenté(e) par', 'field', '']); #}
        }
        //if (tr_proprietaire2.find('input[id$="_proprietaire2"]').val() && tr_proprietaire2.find('select[id$="_qualiteProprietaire2"]').val() == 'Personne') {
          fields.push(['proprietaire2_civilite', 'field', tr_proprietaire2.find('select[id$="_civiliteProprietaire2"]').val()]);
          fields.push(['proprietaire2_identite', 'field', tr_proprietaire2.find('input[id$="_proprietaire2"]').val()]);
          fields.push(['proprietaire2_qualite', 'field', tr_proprietaire2.find('select[id$="_qualiteProprietaire2"]').val()]);
          fields.push(['proprietaire2_adresse', 'field', tr_proprietaire2.find('input[id$="_adresseProprietaire2"]').val()]);
          fields.push(['proprietaire2_droit', 'field', tr_proprietaire2.find('select[id$="_droitProprietaire2"]').val()]);
          fields.push(['proprietaire2_marital', 'field', tr_proprietaire2.find('select[id$="_maritalProprietaire2"]').val()]);
          fields.push(['proprietaire2_ne_le', 'field', tr_proprietaire2.find('input[id$="_dateNaissanceProprietaire2"]').val()]);
          fields.push(['proprietaire2_ne_a', 'field', tr_proprietaire2.find('input[id$="_lieuNaissanceProprietaire2"]').val()]);
        //}
        //if (tr_proprietaire3.find('input[id$="_proprietaire3"]').val() && tr_proprietaire3.find('select[id$="_qualiteProprietaire3"]').val() == 'Personne') {
        fields.push(['proprietaire3_civilite', 'field', tr_proprietaire3.find('select[id$="_civiliteProprietaire3"]').val()]);
        fields.push(['proprietaire3_identite', 'field', tr_proprietaire3.find('input[id$="_proprietaire3"]').val()]);
        fields.push(['proprietaire3_qualite', 'field', tr_proprietaire3.find('select[id$="_qualiteProprietaire3"]').val()]);
        fields.push(['proprietaire3_adresse', 'field', tr_proprietaire3.find('input[id$="_adresseProprietaire3"]').val()]);
        fields.push(['proprietaire3_droit', 'field', tr_proprietaire3.find('select[id$="_droitProprietaire3"]').val()]);
        fields.push(['proprietaire3_marital', 'field', tr_proprietaire3.find('select[id$="_maritalProprietaire3"]').val()]);
        fields.push(['proprietaire3_ne_le', 'field', tr_proprietaire3.find('input[id$="_dateNaissanceProprietaire3"]').val()]);
        fields.push(['proprietaire3_ne_a', 'field', tr_proprietaire3.find('input[id$="_lieuNaissanceProprietaire3"]').val()]);
        //}
        //if (tr_proprietaire4.find('input[id$="_proprietaire4"]').val() && tr_proprietaire4.find('select[id$="_qualiteProprietaire4"]').val() == 'Personne') {
        fields.push(['proprietaire4_civilite', 'field', tr_proprietaire4.find('select[id$="_civiliteProprietaire4"]').val()]);
        fields.push(['proprietaire4_identite', 'field', tr_proprietaire4.find('input[id$="_proprietaire4"]').val()]);
        fields.push(['proprietaire4_qualite', 'field', tr_proprietaire4.find('select[id$="_qualiteProprietaire4"]').val()]);
        fields.push(['proprietaire4_adresse', 'field', tr_proprietaire4.find('input[id$="_adresseProprietaire4"]').val()]);
        fields.push(['proprietaire4_droit', 'field', tr_proprietaire4.find('select[id$="_droitProprietaire4"]').val()]);
        fields.push(['proprietaire4_marital', 'field', tr_proprietaire4.find('select[id$="_maritalProprietaire4"]').val()]);
        fields.push(['proprietaire4_ne_le', 'field', tr_proprietaire4.find('input[id$="_dateNaissanceProprietaire4"]').val()]);
        fields.push(['proprietaire4_ne_a', 'field', tr_proprietaire4.find('input[id$="_lieuNaissanceProprietaire4"]').val()]);
        //}
        fields.push(['exploitant2_civilite', 'field', tr_exploitant2.find('select[id$="_civiliteExploitant2"]').val()]);
        fields.push(['exploitant2_identite', 'field', tr_exploitant2.find('input[id$="_exploitant2"]').val()]);
        fields.push(['exploitant2_qualite', 'field', tr_exploitant2.find('select[id$="_qualiteExploitant2"]').val()]);
        fields.push(['exploitant2_adresse', 'field', tr_exploitant2.find('input[id$="_adresseExploitant2"]').val()]);
        fields.push(['exploitant2_ne_le', 'field', tr_exploitant2.find('input[id$="_dateNaissanceExploitant2"]').val()]);
        fields.push(['exploitant2_ne_a', 'field', tr_exploitant2.find('input[id$="_lieuNaissanceExploitant2"]').val()]);
        fields.push(['exploitant2_droit', 'field', tr_exploitant2.find('select[id$="_droitExploitant2"]').val()]);
        fields.push(['exploitant2_marital', 'field', tr_exploitant2.find('select[id$="_maritalExploitant2"]').val()]);
        
        fields.push(['exploitant3_civilite', 'field', tr_exploitant3.find('select[id$="_civiliteExploitant3"]').val()]);
        fields.push(['exploitant3_identite', 'field', tr_exploitant3.find('input[id$="_exploitant3"]').val()]);
        fields.push(['exploitant3_qualite', 'field', tr_exploitant3.find('select[id$="_qualiteExploitant3"]').val()]);
        fields.push(['exploitant3_adresse', 'field', tr_exploitant3.find('input[id$="_adresseExploitant3"]').val()]);
        fields.push(['exploitant3_ne_le', 'field', tr_exploitant3.find('input[id$="_dateNaissanceExploitant3"]').val()]);
        fields.push(['exploitant3_ne_a', 'field', tr_exploitant3.find('input[id$="_lieuNaissanceExploitant3"]').val()]);
        fields.push(['exploitant3_droit', 'field', tr_exploitant3.find('select[id$="_droitExploitant3"]').val()]);
        fields.push(['exploitant3_marital', 'field', tr_exploitant3.find('select[id$="_maritalExploitant3"]').val()]);
        if (publish_form.text().trim().length == 0 ) {
          publish_form.append('<div class="form-group row"><div class="col-xs-offset-4 col-xs-8"><button name="submit" type="submit" class="btn btn-primary">Publier</button></div></div>');
          publish_form.append('<input type="hidden" name="projet_technologie" value="' + $('#projet_technologie').val() + '">');
          $.each(fields, function(index, field) {
            if(field[1] == 'title') {
              publish_form.append('<legend>' + field[0] + '</legend>');
            } else if(field[1] == 'field') {
              publish_form.append('<div class="form-group"><label for="text" style="color:#B0413E;" class="control-label col-xs-4">{' + field[0] + '}</label><div class="col-xs-8"><input id="text" name="{' + field[0] + '}" value="" type="text" class="form-control"></div></div>');
              $(publish_form).find('input[name="{' + field[0] + '}"]').val(field[2]);
            }
          });
          publish_form.append('<div class="form-group row"><div class="col-xs-offset-4 col-xs-8"><button name="submit" type="submit" class="btn btn-primary">Publier</button></div></div>');
        } else {
          publish_form.find('input[name="{proprietaire_civilite}"]').val(tr_proprietaire.find('select[id$="_civiliteProprietaire"]').val());
          publish_form.find('input[name="{proprietaire_identite}"]').val(tr_proprietaire.find('input[id$="_proprietaire"]').val());
          publish_form.find('input[name="{proprietaire_qualite}"]').val(tr_proprietaire.find('select[id$="_qualiteProprietaire"]').val());
          publish_form.find('input[name="{proprietaire_adresse}"]').val(tr_proprietaire.find('input[id$="_adresseProprietaire"]').val());
          publish_form.find('input[name="{proprietaire_ne_le}"]').val(tr_proprietaire.find('input[id$="_dateNaissanceProprietaire"]').val());
          publish_form.find('input[name="{proprietaire_ne_a}"]').val(tr_proprietaire.find('input[id$="_lieuNaissanceProprietaire"]').val());
          publish_form.find('input[name="{proprietaire_droit}"]').val(tr_proprietaire.find('select[id$="_droitProprietaire"]').val());
          publish_form.find('input[name="{proprietaire_marital}"]').val(tr_proprietaire.find('select[id$="_maritalProprietaire"]').val());
  
          if (publish_form.find('input[name="{proprietaire2_civilite}"]').length) {
            publish_form.find('input[name="{proprietaire2_civilite}"]').val(tr_proprietaire2.find('select[id$="_civiliteProprietaire2"]').val());
            publish_form.find('input[name="{proprietaire2_identite}"]').val(tr_proprietaire2.find('input[id$="_proprietaire2"]').val());
            publish_form.find('input[name="{proprietaire2_qualite}"]').val(tr_proprietaire2.find('select[id$="_qualiteProprietaire2"]').val());
            publish_form.find('input[name="{proprietaire2_adresse}"]').val(tr_proprietaire2.find('input[id$="_adresseProprietaire2"]').val());
            publish_form.find('input[name="{proprietaire2_ne_le}"]').val(tr_proprietaire2.find('input[id$="_dateNaissanceProprietaire2"]').val());
            publish_form.find('input[name="{proprietaire2_ne_a}"]').val(tr_proprietaire2.find('input[id$="_lieuNaissanceProprietaire2"]').val());
            publish_form.find('input[name="{proprietaire2_droit}"]').val(tr_proprietaire2.find('select[id$="_droitProprietaire2"]').val());
            publish_form.find('input[name="{proprietaire2_marital}"]').val(tr_proprietaire2.find('select[id$="_maritalProprietaire2"]').val());
          }
          if (publish_form.find('input[name="{proprietaire3_civilite}"]').length) {
            publish_form.find('input[name="{proprietaire3_civilite}"]').val(tr_proprietaire3.find('select[id$="_civiliteProprietaire3"]').val());
            publish_form.find('input[name="{proprietaire3_identite}"]').val(tr_proprietaire3.find('input[id$="_proprietaire3"]').val());
            publish_form.find('input[name="{proprietaire3_qualite}"]').val(tr_proprietaire3.find('select[id$="_qualiteProprietaire3"]').val());
            publish_form.find('input[name="{proprietaire3_adresse}"]').val(tr_proprietaire3.find('input[id$="_adresseProprietaire3"]').val());
            publish_form.find('input[name="{proprietaire3_ne_le}"]').val(tr_proprietaire3.find('input[id$="_dateNaissanceProprietaire3"]').val());
            publish_form.find('input[name="{proprietaire3_ne_a}"]').val(tr_proprietaire3.find('input[id$="_lieuNaissanceProprietaire3"]').val());
            publish_form.find('input[name="{proprietaire3_droit}"]').val(tr_proprietaire3.find('select[id$="_droitProprietaire3"]').val());
            publish_form.find('input[name="{proprietaire3_marital}"]').val(tr_proprietaire3.find('select[id$="_maritalProprietaire3"]').val());
         }
          if (publish_form.find('input[name="{proprietaire4_civilite}"]').length) {
            publish_form.find('input[name="{proprietaire4_civilite}"]').val(tr_proprietaire4.find('select[id$="_civiliteProprietaire4"]').val());
            publish_form.find('input[name="{proprietaire4_identite}"]').val(tr_proprietaire4.find('input[id$="_proprietaire4"]').val());
            publish_form.find('input[name="{proprietaire4_qualite}"]').val(tr_proprietaire4.find('select[id$="_qualiteProprietaire4"]').val());
            publish_form.find('input[name="{proprietaire4_adresse}"]').val(tr_proprietaire4.find('input[id$="_adresseProprietaire4"]').val());
            publish_form.find('input[name="{proprietaire4_ne_le}"]').val(tr_proprietaire4.find('input[id$="_dateNaissanceProprietaire4"]').val());
            publish_form.find('input[name="{proprietaire4_ne_a}"]').val(tr_proprietaire4.find('input[id$="_lieuNaissanceProprietaire4"]').val());
            publish_form.find('input[name="{proprietaire4_droit}"]').val(tr_proprietaire4.find('select[id$="_droitProprietaire4"]').val());
            publish_form.find('input[name="{proprietaire4_marital}"]').val(tr_proprietaire4.find('select[id$="_maritalProprietaire4"]').val());
          }
          
          publish_form.find('input[name="{exploitant_civilite}"]').val(tr_exploitant.find('select[id$="_civiliteExploitant"]').val());
          publish_form.find('input[name="{exploitant_identite}"]').val(tr_exploitant.find('input[id$="_exploitant"]').val());
          publish_form.find('input[name="{exploitant_qualite}"]').val(tr_exploitant.find('select[id$="_qualiteExploitant"]').val());
          publish_form.find('input[name="{exploitant_adresse}"]').val(tr_exploitant.find('input[id$="_adresseExploitant"]').val());
          publish_form.find('input[name="{exploitant_ne_le}"]').val(tr_exploitant.find('input[id$="_dateNaissanceExploitant"]').val());
          publish_form.find('input[name="{exploitant_ne_a}"]').val(tr_exploitant.find('input[id$="_lieuNaissanceExploitant"]').val());
          publish_form.find('input[name="{exploitant_droit}"]').val(tr_exploitant.find('select[id$="_droitExploitant"]').val());
          publish_form.find('input[name="{exploitant_marital}"]').val(tr_exploitant.find('select[id$="_maritalExploitant"]').val());
  
          if (publish_form.find('input[name="{exploitant2_civilite}"]').length) {
            publish_form.find('input[name="{exploitant2_civilite}"]').val(tr_exploitant2.find('select[id$="_civiliteExploitant2"]').val());
            publish_form.find('input[name="{exploitant2_identite}"]').val(tr_exploitant2.find('input[id$="_exploitant2"]').val());
            publish_form.find('input[name="{exploitant2_qualite}"]').val(tr_exploitant2.find('select[id$="_qualiteExploitant2"]').val());
            publish_form.find('input[name="{exploitant2_adresse}"]').val(tr_exploitant2.find('input[id$="_adresseExploitant2"]').val());
            publish_form.find('input[name="{exploitant2_ne_le}"]').val(tr_exploitant2.find('input[id$="_dateNaissanceExploitant2"]').val());
            publish_form.find('input[name="{exploitant2_ne_a}"]').val(tr_exploitant2.find('input[id$="_lieuNaissanceExploitant2"]').val());
            publish_form.find('input[name="{exploitant2_droit}"]').val(tr_exploitant2.find('select[id$="_droitExploitant2"]').val());
            publish_form.find('input[name="{exploitant2_marital}"]').val(tr_exploitant2.find('select[id$="_maritalExploitant2"]').val());
          }
  
          if (publish_form.find('input[name="{exploitant3_civilite}"]').length) {
            publish_form.find('input[name="{exploitant3_civilite}"]').val(tr_exploitant3.find('select[id$="_civiliteExploitant3"]').val());
            publish_form.find('input[name="{exploitant3_identite}"]').val(tr_exploitant3.find('input[id$="_exploitant3"]').val());
            publish_form.find('input[name="{exploitant3_qualite}"]').val(tr_exploitant3.find('select[id$="_qualiteExploitant3"]').val());
            publish_form.find('input[name="{exploitant3_adresse}"]').val(tr_exploitant3.find('input[id$="_adresseExploitant3"]').val());
            publish_form.find('input[name="{exploitant3_ne_le}"]').val(tr_exploitant3.find('input[id$="_dateNaissanceExploitant3"]').val());
            publish_form.find('input[name="{exploitant3_ne_a}"]').val(tr_exploitant3.find('input[id$="_lieuNaissanceExploitant3"]').val());
            publish_form.find('input[name="{exploitant3_droit}"]').val(tr_exploitant3.find('select[id$="_droitExploitant3"]').val());
            publish_form.find('input[name="{exploitant3_marital}"]').val(tr_exploitant3.find('select[id$="_maritalExploitant3"]').val());
          }
  
          var selectedParcelles = tr_proprietaire.find('input[id$="_parcelles"]').val().trim().split(',');
          var parcellesArray = [];
          if($('#projet_parcelles tr').length) {
            $('#projet_parcelles tr').each(function(i,element) {
              if(selectedParcelles.includes($(element).find('td:eq(0) input[name]').val().trim())) {
                parcellesArray.push([$(element).find('td:eq(0) input[name]').val(), $(element).find('td:eq(2) select option:selected').text().replace(/\(.+/, '').trim(), $(element).find('td:eq(3) input[name]').val().trim(), $(element).find('td:eq(4) input[name]').val().trim()]);
              }
            });
          }
          $(publish_form).find('input[name="{publish_parcelles}"]').val(JSON.stringify(parcellesArray));
        }
  
        if (publish_form.find('input[name="{proprietaire2_civilite}"]').length) {
          if (tr_proprietaire2.find('input[id$="_proprietaire2"]').val()) {
            publish_form.find('input[name="{proprietaire2_civilite}"]').parents('.form-group').removeClass('hide');
            publish_form.find('input[name="{proprietaire2_identite}"]').parents('.form-group').removeClass('hide');
            publish_form.find('input[name="{proprietaire2_qualite}"]').parents('.form-group').removeClass('hide');
            publish_form.find('input[name="{proprietaire2_adresse}"]').parents('.form-group').removeClass('hide');
            publish_form.find('input[name="{proprietaire2_ne_le}"]').parents('.form-group').removeClass('hide');
            publish_form.find('input[name="{proprietaire2_ne_a}"]').parents('.form-group').removeClass('hide');
            publish_form.find('input[name="{proprietaire2_droit}"]').parents('.form-group').removeClass('hide');
            publish_form.find('input[name="{proprietaire2_marital}"]').parents('.form-group').removeClass('hide');
          } else {
            publish_form.find('input[name="{proprietaire2_civilite}"]').parents('.form-group').addClass('hide');
            publish_form.find('input[name="{proprietaire2_identite}"]').parents('.form-group').addClass('hide');
            publish_form.find('input[name="{proprietaire2_qualite}"]').parents('.form-group').addClass('hide');
            publish_form.find('input[name="{proprietaire2_adresse}"]').parents('.form-group').addClass('hide');
            publish_form.find('input[name="{proprietaire2_ne_le}"]').parents('.form-group').addClass('hide');
            publish_form.find('input[name="{proprietaire2_ne_a}"]').parents('.form-group').addClass('hide');
            publish_form.find('input[name="{proprietaire2_droit}"]').parents('.form-group').addClass('hide');
            publish_form.find('input[name="{proprietaire2_marital}"]').parents('.form-group').addClass('hide');
          }
        }
        if (publish_form.find('input[name="{proprietaire3_civilite}"]').length) {
          if (tr_proprietaire3.find('input[id$="_proprietaire3"]').val()) {
            publish_form.find('input[name="{proprietaire3_civilite}"]').parents('.form-group').removeClass('hide');
            publish_form.find('input[name="{proprietaire3_identite}"]').parents('.form-group').removeClass('hide');
            publish_form.find('input[name="{proprietaire3_qualite}"]').parents('.form-group').removeClass('hide');
            publish_form.find('input[name="{proprietaire3_adresse}"]').parents('.form-group').removeClass('hide');
            publish_form.find('input[name="{proprietaire3_ne_le}"]').parents('.form-group').removeClass('hide');
            publish_form.find('input[name="{proprietaire3_ne_a}"]').parents('.form-group').removeClass('hide');
            publish_form.find('input[name="{proprietaire3_droit}"]').parents('.form-group').removeClass('hide');
            publish_form.find('input[name="{proprietaire3_marital}"]').parents('.form-group').removeClass('hide');
          } else {
            publish_form.find('input[name="{proprietaire3_civilite}"]').parents('.form-group').addClass('hide');
            publish_form.find('input[name="{proprietaire3_identite}"]').parents('.form-group').addClass('hide');
            publish_form.find('input[name="{proprietaire3_qualite}"]').parents('.form-group').addClass('hide');
            publish_form.find('input[name="{proprietaire3_adresse}"]').parents('.form-group').addClass('hide');
            publish_form.find('input[name="{proprietaire3_ne_le}"]').parents('.form-group').addClass('hide');
            publish_form.find('input[name="{proprietaire3_ne_a}"]').parents('.form-group').addClass('hide');
            publish_form.find('input[name="{proprietaire3_droit}"]').parents('.form-group').addClass('hide');
            publish_form.find('input[name="{proprietaire3_marital}"]').parents('.form-group').addClass('hide');
          }
        }
        if (publish_form.find('input[name="{proprietaire4_civilite}"]').length) {
          if (tr_proprietaire4.find('input[id$="_proprietaire4"]').val()) {
            publish_form.find('input[name="{proprietaire4_civilite}"]').parents('.form-group').removeClass('hide');
            publish_form.find('input[name="{proprietaire4_identite}"]').parents('.form-group').removeClass('hide');
            publish_form.find('input[name="{proprietaire4_qualite}"]').parents('.form-group').removeClass('hide');
            publish_form.find('input[name="{proprietaire4_adresse}"]').parents('.form-group').removeClass('hide');
            publish_form.find('input[name="{proprietaire4_ne_le}"]').parents('.form-group').removeClass('hide');
            publish_form.find('input[name="{proprietaire4_ne_a}"]').parents('.form-group').removeClass('hide');
            publish_form.find('input[name="{proprietaire4_droit}"]').parents('.form-group').removeClass('hide');
            publish_form.find('input[name="{proprietaire4_marital}"]').parents('.form-group').removeClass('hide');
          } else {
            publish_form.find('input[name="{proprietaire4_civilite}"]').parents('.form-group').addClass('hide');
            publish_form.find('input[name="{proprietaire4_identite}"]').parents('.form-group').addClass('hide');
            publish_form.find('input[name="{proprietaire4_qualite}"]').parents('.form-group').addClass('hide');
            publish_form.find('input[name="{proprietaire4_adresse}"]').parents('.form-group').addClass('hide');
            publish_form.find('input[name="{proprietaire4_ne_le}"]').parents('.form-group').addClass('hide');
            publish_form.find('input[name="{proprietaire4_ne_a}"]').parents('.form-group').addClass('hide');
            publish_form.find('input[name="{proprietaire4_droit}"]').parents('.form-group').addClass('hide');
            publish_form.find('input[name="{proprietaire4_marital}"]').parents('.form-group').addClass('hide');
          }
        }
  
        if (publish_form.find('input[name="{exploitant2_civilite}"]').length) {
          if (tr_exploitant2.find('input[id$="_exploitant2"]').val()) {
            publish_form.find('input[name="{exploitant2_civilite}"]').parents('.form-group').removeClass('hide');
            publish_form.find('input[name="{exploitant2_identite}"]').parents('.form-group').removeClass('hide');
            publish_form.find('input[name="{exploitant2_qualite}"]').parents('.form-group').removeClass('hide');
            publish_form.find('input[name="{exploitant2_adresse}"]').parents('.form-group').removeClass('hide');
            publish_form.find('input[name="{exploitant2_ne_le}"]').parents('.form-group').removeClass('hide');
            publish_form.find('input[name="{exploitant2_ne_a}"]').parents('.form-group').removeClass('hide');
            publish_form.find('input[name="{exploitant2_droit}"]').parents('.form-group').removeClass('hide');
            publish_form.find('input[name="{exploitant2_marital}"]').parents('.form-group').removeClass('hide');
          } else {
            publish_form.find('input[name="{exploitant2_civilite}"]').parents('.form-group').addClass('hide');
            publish_form.find('input[name="{exploitant2_identite}"]').parents('.form-group').addClass('hide');
            publish_form.find('input[name="{exploitant2_qualite}"]').parents('.form-group').addClass('hide');
            publish_form.find('input[name="{exploitant2_adresse}"]').parents('.form-group').addClass('hide');
            publish_form.find('input[name="{exploitant2_ne_le}"]').parents('.form-group').addClass('hide');
            publish_form.find('input[name="{exploitant2_ne_a}"]').parents('.form-group').addClass('hide');
            publish_form.find('input[name="{exploitant2_droit}"]').parents('.form-group').addClass('hide');
            publish_form.find('input[name="{exploitant2_marital}"]').parents('.form-group').addClass('hide');
          }
        }
        if (publish_form.find('input[name="{exploitant3_civilite}"]').length) {
          if (tr_exploitant3.find('input[id$="_exploitant3"]').val()) {
            publish_form.find('input[name="{exploitant3_civilite}"]').parents('.form-group').removeClass('hide');
            publish_form.find('input[name="{exploitant3_identite}"]').parents('.form-group').removeClass('hide');
            publish_form.find('input[name="{exploitant3_qualite}"]').parents('.form-group').removeClass('hide');
            publish_form.find('input[name="{exploitant3_adresse}"]').parents('.form-group').removeClass('hide');
            publish_form.find('input[name="{exploitant3_ne_le}"]').parents('.form-group').removeClass('hide');
            publish_form.find('input[name="{exploitant3_ne_a}"]').parents('.form-group').removeClass('hide');
            publish_form.find('input[name="{exploitant3_droit}"]').parents('.form-group').removeClass('hide');
            publish_form.find('input[name="{exploitant3_marital}"]').parents('.form-group').removeClass('hide');
          } else {
            publish_form.find('input[name="{exploitant3_civilite}"]').parents('.form-group').addClass('hide');
            publish_form.find('input[name="{exploitant3_identite}"]').parents('.form-group').addClass('hide');
            publish_form.find('input[name="{exploitant3_qualite}"]').parents('.form-group').addClass('hide');
            publish_form.find('input[name="{exploitant3_adresse}"]').parents('.form-group').addClass('hide');
            publish_form.find('input[name="{exploitant3_ne_le}"]').parents('.form-group').addClass('hide');
            publish_form.find('input[name="{exploitant3_ne_a}"]').parents('.form-group').addClass('hide');
            publish_form.find('input[name="{exploitant3_droit}"]').parents('.form-group').addClass('hide');
            publish_form.find('input[name="{exploitant3_marital}"]').parents('.form-group').addClass('hide');
          }
        }
        
        $('.publish-modal').modal('show');
      }
    });

    $('#projet_proprietaires_remove_entry').click(function () {
      if(!$(this).hasClass('disabled') && $collectionHolderProprietaire.find('tr.info').length == 7) {
        var id = $collectionHolderProprietaire.find('tr.info:eq(0) input[name]:eq(0)').attr('id').match(/\d+/);
        id = parseInt(id);
        $('#tab_contacts tbody tr[rel="'+id+'"]').remove();
        $collectionHolderProprietaire.find('tr.info').remove();
        $('#projet_proprietaires_remove_entry').addClass('disabled');
        $('#projet_proprietaires_duplicate_entry').addClass('disabled');
        $('#projet_proprietaires_publish_entry').addClass('disabled');
        $('#projet_proprietaires_add_proprietaire_entry').addClass('disabled');
        $('#projet_proprietaires_add_exploitant_entry').addClass('disabled');
        loadAllParcellesTags();
      }
    });

    function exportToCsv(titles, data, file_name) {
      var CSVString = prepCSVRow(titles, titles.length, '');
      CSVString = prepCSVRow(data, titles.length, CSVString);

      var downloadLink = document.createElement("a");
      var blob = new Blob(["\ufeff", CSVString]);
      var url = URL.createObjectURL(blob);
      downloadLink.href = url;
      id = $('#projet_denomination').val();
      downloadLink.download = file_name + id + '.csv';

      document.body.appendChild(downloadLink);
      downloadLink.click();
      document.body.removeChild(downloadLink);
    }

    $('#projet_proprietaires_export_entry').click(function () {
      if($collectionHolderProprietaire.find('tr').length) {
        var titles = ['Fonction'];
        var data = [];
        $collectionHolderProprietaire.parents('table').find('th').each(function() {
          titles.push($(this).text());
        });
        $collectionHolderProprietaire.children().each(function(i, tr) {
          if (($(tr).find('input[id*="_proprietaire"]').length && $(tr).find('input[id*="_proprietaire"]').val().trim()) || ($(tr).find('input[id*="_exploitant"]').length && $(tr).find('input[id*="_exploitant"]').val().trim())) {
            if ($(tr).hasClass('proprietaire_entry')) {
              data.push('Proprietaire');
            } else if ($(tr).hasClass('proprietaire2_entry')) {
              data.push('Proprietaire 2');
            } else if ($(tr).hasClass('proprietaire3_entry')) {
              data.push('Proprietaire 3');
            } else if ($(tr).hasClass('proprietaire4_entry')) {
              data.push('Proprietaire 4');
            } else if ($(tr).hasClass('exploitant_entry')) {
              data.push('Exploitant');
            } else if ($(tr).hasClass('exploitant2_entry')) {
              data.push('Exploitant 2');
            } else if ($(tr).hasClass('exploitant3_entry')) {
              data.push('Exploitant 3');
            }
            if($(tr).find('td').length) {
              $(tr).find('td').each(function(j, td) {
                if ($(td).find('input[name]:eq(0)').length) {
                  data.push('"' + $(td).find('input[name]:eq(0)').val() + '"');
                } else if ($(td).find('select[name]:eq(0)').length) {
                  data.push('"' + $(td).find('select[name]:eq(0)').val() + '"');
                } else if (j > 0) {
                  data.push('"' + $(td).text() + '"');
                } else {
                  data.push('');
                }
              });
            }
          }
        });
        
        exportToCsv(titles, data, 'foncier_');
      }
    });

    function prepCSVRow(arr, columnCount, initial) {
      var row = ''; // this will hold data
      var delimeter = ','; // data slice separator, in excel it's `;`, in usual CSv it's `,`
      var newLine = '\r\n'; // newline separator for CSV row
  
      /*
	   * Convert [1,2,3,4] into [[1,2], [3,4]] while count is 2
	   * @param _arr {Array} - the actual array to split
	   * @param _count {Number} - the amount to split
	   * return {Array} - splitted array
	   */
      function splitArray(_arr, _count) {
        var splitted = [];
        var result = [];
        _arr.forEach(function(item, idx) {
          if ((idx + 1) % _count === 0) {
            splitted.push(item);
            result.push(splitted);
            splitted = [];
          } else {
            splitted.push(item);
          }
        });
        return result;
      }
      var plainArr = splitArray(arr, columnCount);
      // don't know how to explain this
      // you just have to like follow the code
      // and you understand, it's pretty simple
      // it converts `['a', 'b', 'c']` to `a,b,c` string
      plainArr.forEach(function(arrItem) {
        arrItem.forEach(function(item, idx) {
          row += item + ((idx + 1) === arrItem.length ? '' : delimeter);
        });
        row += newLine;
      });
      return initial + row;
    }
    
    $collectionHolderProprietaire.on('change', '[id$="_proprietaire"], [id$="_telephoneProprietaire"], [id$="_proprietaire2"], [id$="_telephoneProprietaire2"], [id$="_proprietaire3"], [id$="_telephoneProprietaire3"], [id$="_proprietaire4"], [id$="_telephoneProprietaire4"], [id$="_exploitant"], [id$="_telephoneExploitant"], [id$="_exploitant2"], [id$="_telephoneExploitant2"], [id$="_exploitant3"], [id$="_telephoneExploitant3"]', function () {
      var id = $(this).attr('id').match(/\d+/);
      id = parseInt(id);
      if($(this).attr('id')=='projet_proprietaires_'+id+'_proprietaire') {
        $('#tab_contacts tbody tr[rel="'+id+'"]:eq(0) td:eq(1)').text($(this).val());
        if($(this).val()) $('#tab_contacts tbody tr[rel="'+id+'"]:eq(0)').removeClass('hide');
        else $('#tab_contacts tbody tr[rel="'+id+'"]:eq(0)').addClass('hide');
      } else if($(this).attr('id')=='projet_proprietaires_'+id+'_telephoneProprietaire')
        $('#tab_contacts tbody tr[rel="'+id+'"]:eq(0) td:eq(2)').text($(this).val());
      else if($(this).attr('id')=='projet_proprietaires_'+id+'_proprietaire2') {
        $('#tab_contacts tbody tr[rel="'+id+'"]:eq(1) td:eq(1)').text($(this).val());
        if($(this).val()) $('#tab_contacts tbody tr[rel="'+id+'"]:eq(1)').removeClass('hide');
        else $('#tab_contacts tbody tr[rel="'+id+'"]:eq(1)').addClass('hide');
      } else if($(this).attr('id')=='projet_proprietaires_'+id+'_telephoneProprietaire2')
        $('#tab_contacts tbody tr[rel="'+id+'"]:eq(1) td:eq(2)').text($(this).val());
      else if($(this).attr('id')=='projet_proprietaires_'+id+'_proprietaire3') {
        $('#tab_contacts tbody tr[rel="'+id+'"]:eq(2) td:eq(1)').text($(this).val());
        if($(this).val()) $('#tab_contacts tbody tr[rel="'+id+'"]:eq(2)').removeClass('hide');
        else $('#tab_contacts tbody tr[rel="'+id+'"]:eq(2)').addClass('hide');
      } else if($(this).attr('id')=='projet_proprietaires_'+id+'_telephoneProprietaire3')
        $('#tab_contacts tbody tr[rel="'+id+'"]:eq(2) td:eq(2)').text($(this).val());
      else if($(this).attr('id')=='projet_proprietaires_'+id+'_proprietaire4') {
        $('#tab_contacts tbody tr[rel="'+id+'"]:eq(3) td:eq(1)').text($(this).val());
        if($(this).val()) $('#tab_contacts tbody tr[rel="'+id+'"]:eq(2)').removeClass('hide');
        else $('#tab_contacts tbody tr[rel="'+id+'"]:eq(3)').addClass('hide');
      } else if($(this).attr('id')=='projet_proprietaires_'+id+'_telephoneProprietaire4')
        $('#tab_contacts tbody tr[rel="'+id+'"]:eq(3) td:eq(2)').text($(this).val());
      else if($(this).attr('id')=='projet_proprietaires_'+id+'_exploitant') {
        $('#tab_contacts tbody tr[rel="'+id+'"]:eq(4) td:eq(1)').text($(this).val());
        if($(this).val()) $('#tab_contacts tbody tr[rel="'+id+'"]:eq(4)').removeClass('hide');
        else $('#tab_contacts tbody tr[rel="'+id+'"]:eq(4)').addClass('hide');
      } else if($(this).attr('id')=='projet_proprietaires_'+id+'_telephoneExploitant')
        $('#tab_contacts tbody tr[rel="'+id+'"]:eq(4) td:eq(2)').text($(this).val());
      else if($(this).attr('id')=='projet_proprietaires_'+id+'_exploitant2') {
        $('#tab_contacts tbody tr[rel="'+id+'"]:eq(5) td:eq(1)').text($(this).val());
        if($(this).val()) $('#tab_contacts tbody tr[rel="'+id+'"]:eq(5)').removeClass('hide');
        else $('#tab_contacts tbody tr[rel="'+id+'"]:eq(5)').addClass('hide');
      } else if($(this).attr('id')=='projet_proprietaires_'+id+'_telephoneExploitant2')
        $('#tab_contacts tbody tr[rel="'+id+'"]:eq(5) td:eq(2)').text($(this).val());
      else if($(this).attr('id')=='projet_proprietaires_'+id+'_exploitant3') {
        $('#tab_contacts tbody tr[rel="'+id+'"]:eq(6) td:eq(1)').text($(this).val());
        if($(this).val()) $('#tab_contacts tbody tr[rel="'+id+'"]:eq(6)').removeClass('hide');
        else $('#tab_contacts tbody tr[rel="'+id+'"]:eq(6)').addClass('hide');
      } else if($(this).attr('id')=='projet_proprietaires_'+id+'_telephoneExploitant3')
        $('#tab_contacts tbody tr[rel="'+id+'"]:eq(6) td:eq(2)').text($(this).val());
    });
    $collectionHolderProprietaire.on('change', '[id$="_dureeProprietaire"], [id$="_dateSignatureProprietaire"], [id$="_dateSignatureProprietaire2"], [id$="_dateSignatureProprietaire3"], [id$="_dateSignatureProprietaire4"], [id$="_dateSignatureExploitant"], [id$="_dateSignatureExploitant2"], [id$="_dateSignatureExploitant3"]', function () {
      var id = $(this).attr('id').match(/\d+/);
      id = parseInt(id);
      
      if($('#projet_proprietaires_'+id+'_dateSignatureProprietaire').val() && $('#projet_proprietaires_'+id+'_dureeProprietaire').val()) {
        var duree = $('#projet_proprietaires_'+id+'_dureeProprietaire').val().trim();
        var dateSplitted = $('#projet_proprietaires_'+id+'_dateSignatureProprietaire').val().trim().split('/');
        var year  = dateSplitted[2];
        var month = dateSplitted[1];
        var day   = dateSplitted[0];
        var dateEcheanceProprietaire  = new Date((parseInt(year) + parseInt(duree)), month, day);
        $('#projet_proprietaires_'+id+'_dateEcheanceProprietaire').val(('0' + dateEcheanceProprietaire.getDate()).slice(-2) + '/' + ('0' + dateEcheanceProprietaire.getMonth()).slice(-2) + '/' + dateEcheanceProprietaire.getFullYear());
      }
      if($('#projet_proprietaires_'+id+'_dateSignatureProprietaire2').val() && $('#projet_proprietaires_'+id+'_dureeProprietaire').val()) {
        var duree = $('#projet_proprietaires_'+id+'_dureeProprietaire').val().trim();
        var dateSplitted = $('#projet_proprietaires_'+id+'_dateSignatureProprietaire2').val().trim().split('/');
        var year  = dateSplitted[2];
        var month = dateSplitted[1];
        var day   = dateSplitted[0];
        var dateEcheanceProprietaire  = new Date((parseInt(year) + parseInt(duree)), month, day);
        $('#projet_proprietaires_'+id+'_dateEcheanceProprietaire2').val(('0' + dateEcheanceProprietaire.getDate()).slice(-2) + '/' + ('0' + dateEcheanceProprietaire.getMonth()).slice(-2) + '/' + dateEcheanceProprietaire.getFullYear());
      }
      if($('#projet_proprietaires_'+id+'_dateSignatureProprietaire3').val() && $('#projet_proprietaires_'+id+'_dureeProprietaire').val()) {
        var duree = $('#projet_proprietaires_'+id+'_dureeProprietaire').val().trim();
        var dateSplitted = $('#projet_proprietaires_'+id+'_dateSignatureProprietaire3').val().trim().split('/');
        var year  = dateSplitted[2];
        var month = dateSplitted[1];
        var day   = dateSplitted[0];
        var dateEcheanceProprietaire  = new Date((parseInt(year) + parseInt(duree)), month, day);
        $('#projet_proprietaires_'+id+'_dateEcheanceProprietaire3').val(('0' + dateEcheanceProprietaire.getDate()).slice(-2) + '/' + ('0' + dateEcheanceProprietaire.getMonth()).slice(-2) + '/' + dateEcheanceProprietaire.getFullYear());
      }
      if($('#projet_proprietaires_'+id+'_dateSignatureProprietaire4').val() && $('#projet_proprietaires_'+id+'_dureeProprietaire').val()) {
        var duree = $('#projet_proprietaires_'+id+'_dureeProprietaire').val().trim();
        var dateSplitted = $('#projet_proprietaires_'+id+'_dateSignatureProprietaire4').val().trim().split('/');
        var year  = dateSplitted[2];
        var month = dateSplitted[1];
        var day   = dateSplitted[0];
        var dateEcheanceProprietaire  = new Date((parseInt(year) + parseInt(duree)), month, day);
        $('#projet_proprietaires_'+id+'_dateEcheanceProprietaire4').val(('0' + dateEcheanceProprietaire.getDate()).slice(-2) + '/' + ('0' + dateEcheanceProprietaire.getMonth()).slice(-2) + '/' + dateEcheanceProprietaire.getFullYear());
      }
      if($('#projet_proprietaires_'+id+'_dateSignatureExploitant').val() && $('#projet_proprietaires_'+id+'_dureeProprietaire').val()) {
        var duree = $('#projet_proprietaires_'+id+'_dureeProprietaire').val().trim();
        var dateSplitted = $('#projet_proprietaires_'+id+'_dateSignatureExploitant').val().trim().split('/');
        var year  = dateSplitted[2];
        var month = dateSplitted[1];
        var day   = dateSplitted[0];
        var dateEcheanceExploitant  = new Date((parseInt(year) + parseInt(duree)), month, day);
        $('#projet_proprietaires_'+id+'_dateEcheanceExploitant').val(('0' + dateEcheanceExploitant.getDate()).slice(-2) + '/' + ('0' + dateEcheanceExploitant.getMonth()).slice(-2) + '/' + dateEcheanceExploitant.getFullYear());
      }
      if($('#projet_proprietaires_'+id+'_dateSignatureExploitant2').val() && $('#projet_proprietaires_'+id+'_dureeProprietaire').val()) {
        var duree = $('#projet_proprietaires_'+id+'_dureeProprietaire').val().trim();
        var dateSplitted = $('#projet_proprietaires_'+id+'_dateSignatureExploitant2').val().trim().split('/');
        var year  = dateSplitted[2];
        var month = dateSplitted[1];
        var day   = dateSplitted[0];
        var dateEcheanceExploitant  = new Date((parseInt(year) + parseInt(duree)), month, day);
        $('#projet_proprietaires_'+id+'_dateEcheanceExploitant2').val(('0' + dateEcheanceExploitant.getDate()).slice(-2) + '/' + ('0' + dateEcheanceExploitant.getMonth()).slice(-2) + '/' + dateEcheanceExploitant.getFullYear());
      }
      if($('#projet_proprietaires_'+id+'_dateSignatureExploitant3').val() && $('#projet_proprietaires_'+id+'_dureeProprietaire').val()) {
        var duree = $('#projet_proprietaires_'+id+'_dureeProprietaire').val().trim();
        var dateSplitted = $('#projet_proprietaires_'+id+'_dateSignatureExploitant3').val().trim().split('/');
        var year  = dateSplitted[2];
        var month = dateSplitted[1];
        var day   = dateSplitted[0];
        var dateEcheanceExploitant  = new Date((parseInt(year) + parseInt(duree)), month, day);
        $('#projet_proprietaires_'+id+'_dateEcheanceExploitant3').val(('0' + dateEcheanceExploitant.getDate()).slice(-2) + '/' + ('0' + dateEcheanceExploitant.getMonth()).slice(-2) + '/' + dateEcheanceExploitant.getFullYear());
      }
    });
    $($collectionHolderProprietaire).on('click', 'tr', function() {
      $collectionHolderProprietaire.children().removeClass('info');
      $(this).addClass('info');
      if ($(this).attr('class').match('proprietaire_entry')) {
        second_tr_index = $(this).index() + 1;
        third_tr_index = $(this).index() + 2;
        fourth_tr_index = $(this).index() + 3;
        fifth_tr_index = $(this).index() + 4;
        six_tr_index = $(this).index() + 5;
        seventh_tr_index = $(this).index() + 6;
      } else if ($(this).attr('class').match('proprietaire2_entry')) {
        second_tr_index = $(this).index() - 1;
        third_tr_index = $(this).index() + 1;
        fourth_tr_index = $(this).index() + 2;
        fifth_tr_index = $(this).index() + 3;
        six_tr_index = $(this).index() + 4;
        seventh_tr_index = $(this).index() + 5;
      } else if ($(this).attr('class').match('proprietaire3_entry')) {
        second_tr_index = $(this).index() - 2;
        third_tr_index = $(this).index() - 1;
        fourth_tr_index = $(this).index() + 1;
        fifth_tr_index = $(this).index() + 2;
        six_tr_index = $(this).index() + 3;
        seventh_tr_index = $(this).index() + 4;
      } else if ($(this).attr('class').match('proprietaire4_entry')) {
        second_tr_index = $(this).index() - 3;
        third_tr_index = $(this).index() - 2;
        fourth_tr_index = $(this).index() - 1;
        fifth_tr_index = $(this).index() + 1;
        six_tr_index = $(this).index() + 2;
        seventh_tr_index = $(this).index() + 3;
      } else if ($(this).attr('class').match('exploitant_entry')) {
        second_tr_index = $(this).index() - 4;
        third_tr_index = $(this).index() - 3;
        fourth_tr_index = $(this).index() - 2;
        fifth_tr_index = $(this).index() - 1;
        six_tr_index = $(this).index() + 1;
        seventh_tr_index = $(this).index() + 2;
      } else if ($(this).attr('class').match('exploitant2_entry')) {
        second_tr_index = $(this).index() - 5;
        third_tr_index = $(this).index() - 4;
        fourth_tr_index = $(this).index() - 3;
        fifth_tr_index = $(this).index() - 2;
        six_tr_index = $(this).index() - 1;
        seventh_tr_index = $(this).index() + 1;
      } else if ($(this).attr('class').match('exploitant3_entry')) {
        second_tr_index = $(this).index() - 6;
        third_tr_index = $(this).index() - 5;
        fourth_tr_index = $(this).index() - 4;
        fifth_tr_index = $(this).index() - 3;
        six_tr_index = $(this).index() - 2;
        seventh_tr_index = $(this).index() - 1;
      }
      $($collectionHolderProprietaire).find('tr:eq('+second_tr_index+')').addClass('info');
      $($collectionHolderProprietaire).find('tr:eq('+third_tr_index+')').addClass('info');
      $($collectionHolderProprietaire).find('tr:eq('+fourth_tr_index+')').addClass('info');
      $($collectionHolderProprietaire).find('tr:eq('+fifth_tr_index+')').addClass('info');
      $($collectionHolderProprietaire).find('tr:eq('+six_tr_index+')').addClass('info');
      $($collectionHolderProprietaire).find('tr:eq('+seventh_tr_index+')').addClass('info');
      if($collectionHolderProprietaire.children().length) {
        $('#projet_proprietaires_remove_entry').removeClass('disabled');
        $('#projet_proprietaires_duplicate_entry').removeClass('disabled');
        $('#projet_proprietaires_publish_entry').removeClass('disabled');
        if ($collectionHolderProprietaire.find('tr[class*="info"][class*="proprietaire"][class*="hide"]:eq(0)').length) {
          $('#projet_proprietaires_add_proprietaire_entry').removeClass('disabled');
        } else {
          $('#projet_proprietaires_add_proprietaire_entry').addClass('disabled');
        }
        if ($collectionHolderProprietaire.find('tr[class*="info"][class*="exploitant"][class*="hide"]:eq(0)').length) {
          $('#projet_proprietaires_add_exploitant_entry').removeClass('disabled');
        } else {
          $('#projet_proprietaires_add_exploitant_entry').addClass('disabled');
        }
      }
    });
    loadAllParcellesTags();
    var suggestionsArray = [];
    {% if form.vars.value.parcelles[0] is defined %}
      {% for parcelle in form.vars.value.parcelles %}
        if(!suggestionsArray.includes('{{ parcelle.nom }}')) {
          suggestionsArray.push('{{ parcelle.nom }}');
        }
      {% endfor %}
    {% endif %}
    $('#projet_parcelles').on('change', 'input[id$="_nom"]', function() {
      suggestionsArray = [];
      if($('#projet_parcelles tr').length) {
        $('#projet_parcelles tr').each(function(i,element) {
          if(!suggestionsArray.includes($(element).find('td:eq(0) input[name]').val().trim())) {
            suggestionsArray.push($(element).find('td:eq(0) input[name]').val().trim());
          }
        });
      }
      loadAllParcellesTags();
    });
    var selectedParcellesCarte = [];
    function loadAllParcellesTags() {
      if($('#projet_proprietaires tr').length) $('#projet_proprietaires_recherche').removeClass('hide');
      else $('#projet_proprietaires_recherche').addClass('hide');
      var selectedSuggestionsArray = [];
      $('#projet_proprietaires input[id$="_parcelles"]').each(function(i,element) {
        id = $(this).attr('name').match(/\d+/);
        id = parseInt(id);
        
        selectedSuggestionsArray[id] = $('#projet_proprietaires_'+id+'_parcelles').val().split(',');
        $('#projet_proprietaires_'+id+'_parcelles').tagsinput({
          maxTags: 40,
          typeahead: {
            afterSelect: function(val) { this.$element.val(''); },
            minLength : 0,
            source: function(query) {
              suggestionsArray = [];
              $('#projet_parcelles tr').each(function(i,element) {
                if(!suggestionsArray.includes($(element).find('td:eq(0) input[name]').val().trim()) && !selectedSuggestionsArray[id].includes($(element).find('td:eq(0) input[name]').val().trim())) {
                  suggestionsArray.push($(element).find('td:eq(0) input[name]').val().trim());
                }
              });
              return suggestionsArray;
            }
          },
          freeInput: false
        });
        $('#projet_proprietaires_'+id+'_parcelles').on('itemAdded', function(event) {
          selectedSuggestionsArray[id] = $('#projet_proprietaires_'+id+'_parcelles').val().split(',');
        });
        $('#projet_proprietaires_'+id+'_parcelles').on('itemRemoved', function(event) {
          selectedSuggestionsArray[id] = $('#projet_proprietaires_'+id+'_parcelles').val().split(',');
        });
      });
      if(typeof tileLayer !== 'undefined') {
        $('#parcelles_carte').empty();
        selectedParcellesCarte.forEach(featureId => {
          tileLayer.setFeatureStyle(featureId, {
              fillColor: "green",
              color: "black",
              weight: 1,
              fill: true
          });
        });
        selectedParcellesCarte = [];
        if($('#projet_parcelles tr').length) {
          parcellesArray = [];
          parcelleCommuneArray = [];
          communeIdsArray = [];
          $('#projet_parcelles tr').each(function(i,element) {
            if($(element).find('td:eq(0) input[name]').val() && !parcellesArray.includes($(element).find('td:eq(0) input[name]').val().trim())) {
              parcellesArray.push($(element).find('td:eq(0) input[name]').val().trim());
              parcelleCommuneArray.push([$(element).find('td:eq(0) input[name]').val().trim(), $(element).find('select[id$="_commune"]').val(), $(element).find('select[id$="_commune"] :selected').text().replace(/\(.+/, '').trim()]);
            }
            if($(element).find('select[id$="_commune"]').val() && !communeIdsArray.includes($(element).find('select[id$="_commune"]').val())) {
              communeIdsArray.push($(element).find('select[id$="_commune"]').val());
            }
          });
          if(parcellesArray.length) {
            if(!communeIdsArray.length) {
              communeIdsArray.push($('#projet_parcelles select[id$="_commune"]:eq(0) option:selected').val());
            }
            if(communeIdsArray.length>0) {
              $.ajax({
                url: "{{ path('france_cadastre') }}",
                dataType: 'json',
                data: {communes: communeIdsArray, parcelleCommunes: parcelleCommuneArray, parcelles: parcellesArray},
                success:  function(features) {
                  features.forEach(feature => {
                    $('#parcelles_carte').append('<tr><td>'+feature.section+'</td><td>'+feature.numero+'</td><td>'+feature.commune+'</td><td>'+feature.contenance+'</td></tr>');
                    if(feature.selected) {
                      selectedParcellesCarte.push(feature.id); 
                      tileLayer.setFeatureStyle(feature.id, {
                          fillColor: "red",
                          color: "black",
                          weight: 1,
                          fill: true
                      });
                    }
                  });
                }
              });
            }
          }
        }
      }
    }
    $('#projet_proprietaires_recherche').on('change', function() {
      var search = $(this).val().trim();
      var search_found_in_proprietaire = false;
      var search_found_in_proprietaire2 = false;
      var search_found_in_proprietaire3 = false;
      var search_found_in_proprietaire4 = false;
      var search_found_in_exploitant = false;
      var search_found_in_exploitant2 = false;
      $.each($('#projet_proprietaires tr'), function(i, tr) {
        var row = $(tr);
        var search_found = false;
        if(row.attr('class').match('proprietaire_entry')) search_found_in_proprietaire = false;
        else if(row.attr('class').match('proprietaire2_entry')) search_found_in_proprietaire2 = false;
        else if(row.attr('class').match('proprietaire3_entry')) search_found_in_proprietaire3 = false;
        else if(row.attr('class').match('proprietaire4_entry')) search_found_in_proprietaire4 = false;
        else if(row.attr('class').match('exploitant_entry')) search_found_in_exploitant = false;
        else if(row.attr('class').match('exploitant2_entry')) search_found_in_exploitant2 = false;
        $.each(row.find('td'), function(i, td) {
          var col = $(td);
          if(search && col.find('input[name]').length && col.find('input[name]').val().match(new RegExp(search, 'gi'))) {
            col.css('background-color', 'rgb(255, 153, 0)');
            search_found = true;
          } else if(search && col.find('select').length && (col.find('select option:selected').text().match(new RegExp(search, 'gi')) || (col.find('select').val().length > 1 && col.find('select').val().match(new RegExp(search, 'gi'))))) {
            col.css('background-color', 'rgb(255, 153, 0)');
            search_found = true;
          } else if(search && !col.find('input[name]').length && !col.find('select').length && col.text().match(new RegExp(search, 'gi'))) {
            col.css('background-color', 'rgb(255, 153, 0)');
            search_found = true;
          } else col.css('background-color', 'white');
        });
        if(row.attr('class').match('proprietaire_entry')) {
          search_found_in_proprietaire = search_found;
        } else if(row.attr('class').match('proprietaire2_entry')) {
          search_found_in_proprietaire2 = search_found;
        } else if(row.attr('class').match('proprietaire3_entry')) {
          search_found_in_proprietaire3 = search_found;
        } else if(row.attr('class').match('proprietaire4_entry')) {
          search_found_in_proprietaire4 = search_found;
        } else if(row.attr('class').match('expoitant_entry')) {
          search_found_in_exploitant = search_found;
        } else if(row.attr('class').match('expoitant2_entry')) {
          search_found_in_exploitant2 = search_found;
        } else if(row.attr('class').match('expoitant3_entry')) {
          if(!search || search_found || search_found_in_proprietaire || search_found_in_proprietaire2 || search_found_in_proprietaire3 || search_found_in_proprietaire4 || search_found_in_exploitant || search_found_in_exploitant2) {
            row.prev().prev().prev().prev().prev().prev().removeClass('hide');
            row.prev().prev().prev().prev().prev().removeClass('hide');
            row.prev().prev().prev().prev().removeClass('hide');
            row.prev().prev().prev().removeClass('hide');
            row.prev().prev().removeClass('hide');
            row.prev().removeClass('hide');
          } else {
            row.prev().prev().prev().prev().prev().prev().addClass('hide');
            row.prev().prev().prev().prev().prev().addClass('hide');
            row.prev().prev().prev().prev().addClass('hide');
            row.prev().prev().prev().addClass('hide');
            row.prev().prev().addClass('hide');
            row.prev().addClass('hide');
            row.addClass('hide');
          }
        }
      });
    });

    var $collectionHolderDC = $('#projet_dateCles');
    var prototypeDC = $collectionHolderDC.data('prototype');

    $('#projet_dateCles_add_entry').click(function () {
      var length = $collectionHolderDC.children().length;
      var entry = prototypeDC.replace(/__name__label__/g, length);
      entry = entry.replace(/__name__/g, length);
      $collectionHolderDC.append(entry);

      $('#projet_dateCles_' + length + '_date').datepicker({
        format: 'dd/mm/yyyy',
        autoclose: true,
        language: 'fr',
        clear: true,
      });
    });

    var telephones = {{ telephones|raw }}
    $('#tab_contacts select').change(function () {
      var selected_user = $(this).val();
      var telephone_selector = $(this).parents('tr').find('input:last');
      $.each(telephones, function(code, telephone) {
        if(telephone.id == selected_user) telephone_selector.val(telephone.telephone);
      });
    })

    $('#projet_dateCles_remove_entry').click(function () {
      $('> :last-child', $collectionHolderDC).remove();
    });

    var $collectionHolderDC = $('#projet_batimentExistant_toitures');
    var prototypeDC = $collectionHolderDC.data('prototype');

    $('#projet_batimentExistant_toitures_add_entry').click(function () {
        var length = $collectionHolderDC.children().length;
        var entry = prototypeDC.replace(/__name__label__/g, length);
        entry = entry.replace(/__name__/g, length);
        $collectionHolderDC.append(entry);

    });

    $('#projet_batimentExistant_toitures_remove_entry').click(function () {
        $('> :last-child', $collectionHolderDC).remove();
    });

    var current_batiment_image = 0;
    var batiment_images = {};
    var batiments = JSON.parse({{ batiments|raw }});
    function updateBatiment(by_user) {
      current_batiment_image = 0;
      batiment_images = {};
      $('#batimentNouveau_options p').html('');
      $('#projet_batimentExistant_bardage').parents('.form-group').addClass('hide');
      $('#projet_batimentExistant_ossature').parents('.form-group').addClass('hide');
      $('#projet_batimentExistant_charpente').parents('.form-group').addClass('hide');
      {# $('#projet_batimentExistant_photoFile').parents('.form-group').removeClass('hide'); #}
      if($('#projet_batimentNouveau').val()) {
        var selected_batiment = $('#projet_batimentNouveau').val();
        $.each(batiments, function(i, batiment) {
          if(batiment['id'] == selected_batiment) {
            $.each(batiment, function(field, value) {
              {# if($('#projet_batimentExistant_' + field) && (typeof value === 'string' || value instanceof String)) $('#projet_batimentExistant_' + field).val(value.trim()); #}
              if(field == 'bardage' || field == 'ossature' || field == 'charpente' || field == 'couverture') {
                $('#projet_batimentExistant_'+field).parents('.form-group').removeClass('hide');
                var select = '<div class="form-group form-group-sm"><label class="col-sm-4 control-label">'+field+':</label><div class="col-sm-8"><select id="'+field.toLowerCase()+'" class="form-control batiment_select_option">';
                is_empty = 1;
                $.each(value, function(i, value2) {
                  value2 = value2.trim();
                  if(value2) is_empty = 0;
                  if((!$('#projet_batimentExistant_'+field).val() && !i) || ($('#projet_batimentExistant_'+field).val() && value2 == $('#projet_batimentExistant_'+field).val())) {
                    $('#projet_batimentExistant_'+field).val(value2);
                    select += '<option selected>'+value2+'</option>';
                  } else select += '<option>'+value2+'</option>';
                });
                select += '</select></div></div>';
                if(!is_empty) $('#batimentNouveau_options p').append(select);
              } else if(field.match(/photo/) && value && value.trim()) {
                batiment_images[Object.keys(batiment_images).length] = {0: '{{ asset('') }}upload/' + value};
                if(!$('#batiment_photo').length) $('#batimentNouveau_options p').append('<div id="batiment_photo" class="form-group form-group-sm"><img style="max-width: 100%;padding:3%;" src="{{ asset('') }}upload/' + value + '"><nav style="margin-left:30%;" aria-label="Page navigation center-text"><ul class="pagination"><li class="page-item disabled"><a id="prev_batiment_image" class="page-link" href="#">Précédent</a></li><li class="page-item disabled"><a id="next_batiment_image" class="page-link" href="#">Suivant</a></li></ul></nav></div>');
              } else if(by_user && $('#projet_batimentExistant_' + field).length && (typeof value === 'string' || value instanceof String)) 
                $('#projet_batimentExistant_' + field).val(value.trim());
              else if((typeof value === 'string' || value instanceof String) && value.trim())
                $('#batimentNouveau_options p').append('<div class="form-group form-group-sm"><label class="col-sm-4 control-label">'+field+':</label><div class="col-sm-8">' + value + '</div></div>');
              else if(by_user && field == 'toitures') {
                $('#projet_batimentExistant_toitures').html('');
                $.each(value, function(i2, toiture) {
                  $('#projet_batimentExistant_toitures_add_entry').click();
                  $.each(toiture, function(field2, value2) {
                    if($('#projet_batimentExistant_toitures_' + i2 + '_' + field2).length && (typeof value2 === 'string' || value2 instanceof String)) 
                      $('#projet_batimentExistant_toitures_' + i2 + '_' + field2).val(value2.trim());
                      else if(field2 == 'photo' && value2 && value2.trim()) {
                        batiment_images[Object.keys(batiment_images).length] = {0: '{{ asset('') }}upload/' + value2};
                        if(!$('#batiment_photo').length) $('#batimentNouveau_options p').append('<div id="batiment_photo" class="form-group form-group-sm"><img style="max-width: 100%;padding:3%;" src="{{ asset('') }}upload/' + value2 + '"><nav style="margin-left:30%;" aria-label="Page navigation center-text"><ul class="pagination"><li class="page-item disabled"><a id="prev_batiment_image" class="page-link" href="#">Précédent</a></li><li class="page-item disabled"><a id="next_batiment_image" class="page-link" href="#">Suivant</a></li></ul></nav></div>');
                      }
                  });
                });
              }
            });
            if(batiment_images[0] !== undefined) {
              updatePrevNextBatimentButtons();
            }
          }
        });
      }
    }
    $('#projet_batimentNouveau').change(function () {
      updateBatiment(1);
    });
    function updatePrevNextBatimentButtons() {
      prev = -1;
      next = -1;
      $.each(batiment_images, function(i, value) {
        if(current_batiment_image > i) prev = 1;
        if(next == -1 && current_batiment_image < i) next = 1;
      });
      if(prev >= 0) $('body').find('#prev_batiment_image').parent().removeClass('disabled');
      else  $('body').find('#prev_batiment_image').parent().addClass('disabled');
      if(next >= 0) $('body').find('#next_batiment_image').parent().removeClass('disabled');
      else $('body').find('#next_batiment_image').parent().addClass('disabled');
    }
    $('body').on('click','#next_batiment_image, #prev_batiment_image',function(e) {
      e.preventDefault();
      prev = -1;
      next = -1;
      $.each(batiment_images, function(i, value) {
        if(current_batiment_image > i) prev = i;
        if(next == -1 && current_batiment_image < i) next = i;
      });
      if(($(this).attr('id') == 'prev_batiment_image' && prev >= 0) || ($(this).attr('id') == 'next_batiment_image' && next >= 0)) {
        if($(this).attr('id') == 'next_batiment_image') current_batiment_image = next;
        else current_batiment_image = prev;
        updatePrevNextBatimentButtons();
        $('#batiment_photo img').attr('src', batiment_images[current_batiment_image][0]);
      }
    });

    $('body').on('change', 'select.batiment_select_option', function () {
        var selected_field = $(this).attr('id');
        var selected_value = $(this).val();
        $('#projet_batimentExistant_'+selected_field).val(selected_value);
    });

    var $collectionHolderEtat = $('#projet_etats');
    var prototypeEtat = $collectionHolderEtat.data('prototype');

    $('#projet_etats_add_entry').click(function () {
      var length = $collectionHolderEtat.children().length;
      var entry = prototypeEtat.replace(/__name__label__/g, length);
      entry = entry.replace(/__name__/g, length);
      $collectionHolderEtat.append(entry);

      $('#projet_etats_' + length + '_date').datepicker({
        format: 'dd/mm/yyyy',
        autoclose: true,
        language: 'fr',
      });

      {# $('#projet_etats_' + length + '_dynamique').val('0'); #}
      
      $('#projet_etats_' + length + '_phase').change();
    });

    $('#projet_etats_remove_entry').click(function () {
      $('> :last-child', $collectionHolderEtat).remove();
    });

    $('#projet_etats_export_entry').click(function () {
      if($collectionHolderEtat.find('tr').length) {
        var titles = [];
        var data = [];
        $collectionHolderEtat.parents('table').find('th').each(function() {
          titles.push($(this).text());
        });
        $collectionHolderEtat.children().each(function(i, tr) {
          if($(tr).find('td').length) {
            $(tr).find('td').each(function(j, td) {
              if ($(td).find('input[name]:eq(0)').length) {
                data.push('"' + $(td).find('input[name]:eq(0)').val() + '"');
              } else if ($(td).find('select[name]:eq(0)').length) {
                data.push('"' + $(td).find('select[name]:eq(0)').val() + '"');
              } else if (j > 0) {
                data.push('"' + $(td).text() + '"');
              } else {
                data.push('');
              }
            });
          }
        });
        
        exportToCsv(titles, data, 'etats_');
      }
    });

    var etats = {{ grid_helper.getJsonEtats|raw }};
   {#  $('body').on('change', 'select[id*="projet_etats"][id*="_phase"]', function () {
        var selected_phase = $(this).val();
        var etat_selector = $(this).parents('tr').find('select:eq(1)');
        $.each(etats, function(code, etat) {
          if(code == selected_phase) {
            var selected_data = [];
            $.each(etat['data'], function(field, value) {
              if(!etat_selector.find('option[value="'+field+'"]').length) etat_selector.append(new Option(value, field));
              selected_data.push(field);
            });
            $(etat_selector.find('option')).each(function(index,element) {
              if(!selected_data.includes($(element).attr('value'))) $(element).remove();
            });
          }
        });
    }); #}
    $('body').on('change', 'select[id="projet_phase"]', function () {
        var selected_phase = $(this).val();
        var etat_selector = $('select[id="projet_progression"]');
        $.each(etats, function(code, etat) {
          if(code == selected_phase) {
            var selected_data = [];
            $.each(etat['data'], function(field, value) {
              if(!etat_selector.find('option[value="'+field+'"]').length) etat_selector.append(new Option(value, field));
              selected_data.push(field);
            });
            $(etat_selector.find('option')).each(function(index,element) {
              if(!selected_data.includes($(element).attr('value'))) $(element).remove();
            });
          }
        });
    });
    $('#projet_etats').on('change', 'select[id*="_phase"]', function () {
        var selected_phase = $(this).val();
        var etat_selector = $(this).parents('tr').find('select:eq(1)');
        $.each(etats, function(code, etat) {
          if(code == selected_phase) {
            var selected_data = [];
            var already_selected_data = [];
            $('#projet_etats tr').each(function(field, element) {
              if($(element).index() != etat_selector.parents('tr').index() && !already_selected_data.includes($(element).find('select:eq(1)').val()))already_selected_data.push($(element).find('select:eq(1)').val());
            });
            $.each(etat['data'], function(field, value) {
              if(!already_selected_data.includes(field) && !etat_selector.find('option[value="'+field+'"]').length) etat_selector.append(new Option(value, field));
              if(!already_selected_data.includes(field)) selected_data.push(field);
            });
            $(etat_selector.find('option')).each(function(index,element) {
              if(!selected_data.includes($(element).attr('value'))) $(element).remove();
            });
          }
        });
    });

    var $collectionHolderTache = $('#projet_taches');
    var prototypeTache = $collectionHolderTache.data('prototype');

    $('#projet_taches_add_entry').click(function () {
      var length = $collectionHolderTache.children().length;
      var entry = prototypeTache.replace(/__name__label__/g, length);
      entry = entry.replace(/__name__/g, length);
      $collectionHolderTache.append(entry);

      $('#projet_taches_' + length + '_date').datepicker({
        format: 'dd/mm/yyyy',
        autoclose: true,
        language: 'fr',
      });

      {# $('#projet_taches_' + length + '_dynamique').val('0'); #}
      
      $('#projet_taches_' + length + '_objet').change();
    });

    $('#projet_taches_remove_entry').click(function () {
      $('> :last-child', $collectionHolderTache).remove();
    });

    $('#projet_taches_export_entry').click(function () {
      if($collectionHolderTache.find('tr').length) {
        var titles = [];
        var data = [];
        $collectionHolderTache.parents('table').find('th').each(function() {
          titles.push($(this).text());
        });
        $collectionHolderTache.children().each(function(i, tr) {
          if($(tr).find('td').length) {
            $(tr).find('td').each(function(j, td) {
              if ($(td).find('input[name]:eq(0)').length) {
                data.push('"' + $(td).find('input[name]:eq(0)').val() + '"');
              } else if ($(td).find('select[name]:eq(0)').length) {
                data.push('"' + $(td).find('select[name]:eq(0)').val() + '"');
              } else if (j > 0) {
                data.push('"' + $(td).text() + '"');
              } else {
                data.push('');
              }
            });
          }
        });
        
        exportToCsv(titles, data, 'taches_');
      }
    });

    var taches = {{ grid_helper.getJsonTaches|raw }};
    $('body').on('change', 'select[id*="_objet"]', function () {
        var selected_objet = $(this).val();
        var tache_selector = $(this).parents('tr').find('select:eq(1)');
        $.each(taches, function(code, tache) {
          if(code == selected_objet) {
            var selected_data = [];
            var already_selected_data = [];
            $('#projet_taches tr').each(function(field, element) {
              if($(element).index() != tache_selector.parents('tr').index() && !already_selected_data.includes($(element).find('select:eq(1)').val()))already_selected_data.push($(element).find('select:eq(1)').val());
            });
            $.each(tache['data'], function(field, value) {
              if(!already_selected_data.includes(field) && !tache_selector.find('option[value="'+field+'"]').length) tache_selector.append(new Option(value, field));
              if(!already_selected_data.includes(field)) selected_data.push(field);
            });
            $(tache_selector.find('option')).each(function(index,element) {
              if(!selected_data.includes($(element).attr('value'))) $(element).remove();
            });
          }
        });
    });

    var $collectionHolderConcertation = $('#projet_concertations');
    var prototypeConcertation = $collectionHolderConcertation.data('prototype');

    $('#projet_concertations_add_entry').click(function () {
      var length = $collectionHolderConcertation.children().length;
      var entry = prototypeConcertation.replace(/__name__label__/g, length);
      entry = entry.replace(/__name__/g, length);
      $collectionHolderConcertation.append(entry);

      $('#projet_concertations_' + length + '_date').datepicker({
        format: 'dd/mm/yyyy',
        autoclose: true,
        language: 'fr',
      });

      {# $('#projet_concertations_' + length + '_dynamique').val('0'); #}

    });

    $('#projet_concertations_remove_entry').click(function () {
      $('> :last-child', $collectionHolderConcertation).remove();
    });

    $('#projet_concertations_export_entry').click(function () {
      if($collectionHolderConcertation.find('tr').length) {
        var titles = [];
        var data = [];
        $collectionHolderConcertation.parents('table').find('th').each(function() {
          titles.push($(this).text());
        });
        $collectionHolderConcertation.children().each(function(i, tr) {
          if($(tr).find('td').length) {
            $(tr).find('td').each(function(j, td) {
              if ($(td).find('input[name]:eq(0)').length) {
                data.push('"' + $(td).find('input[name]:eq(0)').val() + '"');
              } else if ($(td).find('select[name]:eq(0)').length) {
                data.push('"' + $(td).find('select[name]:eq(0)').val() + '"');
              } else if (j > 0) {
                data.push('"' + $(td).text() + '"');
              } else {
                data.push('');
              }
            });
          }
        });
        
        exportToCsv(titles, data, 'concertations_');
      }
    });

    var $collectionHolderDocument = $('#projet_documents');
    var prototypeDocument = $collectionHolderDocument.data('prototype');

    $('#projet_documents_add_entry').click(function () {
      var length = $collectionHolderDocument.children().length;
      var entry = prototypeDocument.replace(/__name__label__/g, length);
      entry = entry.replace(/__name__/g, length);
      $collectionHolderDocument.append(entry);

      $('#projet_documents_' + length + '_date').datepicker({
        format: 'dd/mm/yyyy',
        autoclose: true,
        language: 'fr',
      });

    });

    $('#projet_documents_remove_entry').click(function () {
      var documents_remove_index = -1;
      $.each($collectionHolderDocument.children(), function(index, element) {
        if(!$(element).find('td input[id*="plan"]').prop('checked')) documents_remove_index = index;
      });
      if(documents_remove_index >= 0) $('> :eq('+documents_remove_index+')', $collectionHolderDocument).remove();
    });

    var $collectionHolderParcelle = $('#projet_parcelles');
    var prototypeParcelle = $collectionHolderParcelle.data('prototype');

    $('#projet_parcelles_add_entry').click(function () {
      var length = $collectionHolderParcelle.children().length;
      var entry = prototypeParcelle.replace(/__name__label__/g, length);
      entry = entry.replace(/__name__/g, length);
      $collectionHolderParcelle.append(entry);
      
      $('#projet_parcelles_' + length + '_departement').val($('#projet_departement').val());
      if($('#projet_communes option:selected').length) {
        $('#projet_parcelles_' + length + '_commune').append(new Option($('#projet_communes option:selected').text(), $('#projet_communes option:selected').val()));
        $('#projet_parcelles_' + length + '_commune').val($('#projet_communes option:selected').val());
      } else $('#projet_parcelles_' + length + '_commune').val(9);
      $('#projet_parcelles_' + length + '_commune').select2({
        ajax: {
          url: queryCommuneUrl,
          dataType: 'json',
          delay: 500,
          processResults: function (data) {
            return {
              results: data
            };
          }
        },
        escapeMarkup: function (markup) { return markup; }, // let our custom formatter work
        minimumInputLength: 1,
      });
    });

    $('#projet_parcelles_remove_entry').click(function () {
      if($collectionHolderParcelle.find('tr.info').length) {
        $collectionHolderParcelle.find('tr.info').remove();
      } else {
        $('> :last-child', $collectionHolderParcelle).remove();
      }
      enableDisableParcellesSendMail();
      loadAllParcellesTags();
    });

    $('#projet_parcelles_export_entry').click(function () {
      if($collectionHolderParcelle.find('tr').length) {
        var titles = [];
        var data = [];
        $collectionHolderParcelle.parents('table').find('th').each(function() {
          titles.push($(this).text());
        });
        $collectionHolderParcelle.children().each(function(i, tr) {
          if($(tr).find('td').length) {
            $(tr).find('td').each(function(j, td) {
              if ($(td).find('input[name]:eq(0)').length) {
                data.push('"' + $(td).find('input[name]:eq(0)').val() + '"');
              } else if ($(td).find('select[name]:eq(0)').length) {
                data.push('"' + $(td).find('select[name]:eq(0)').val() + '"');
              } else if (j > 0) {
                data.push('"' + $(td).text() + '"');
              } else {
                data.push('');
              }
            });
          }
        });
        
        exportToCsv(titles, data, 'parcelles_');
      }
    });

    function enableDisableParcellesSendMail() {
      if($collectionHolderParcelle.find('tr.info').length) {
        $('#projet_parcelles_send_mail').removeClass('disabled');
      } else {
        $('#projet_parcelles_send_mail').addClass('disabled');
      }
    }
    $($collectionHolderParcelle).on('click', 'tr', function() {
      if($(this).hasClass('info')) {
        $(this).removeClass('info');
      } else {
        $(this).addClass('info');
      }
      enableDisableParcellesSendMail();
    });
    $('#projet_parcelles_send_mail').click(function () {
      if(!$(this).hasClass('disabled')) {
        var selectedParcellesForEmail = [];
        var selectedCommunesForEmail = [];
        var selectedDepartementsForEmail = [];
        $($collectionHolderParcelle).find('tr.info').each(function(i,element) {
          selectedParcellesForEmail.push($(element).find('input[id$="_nom"]').val());
          if(!selectedCommunesForEmail.includes($(element).find('select[id$="_commune"] :selected').text().trim())) {
            selectedCommunesForEmail.push($(element).find('select[id$="_commune"] :selected').text().trim());
            selectedDepartementsForEmail.push($(element).find('select[id$="_departement"] :selected').text().trim());
          }
        });
        $('#message_parcelles_object').val('Sujet');
        $('#message_parcelles_body').val('Madame, monsieur,'+"\n\n"+
        'Nous réalisons actuellement une étude de faisabilité foncière d’un projet d’énergie renouvelable situé sur la commune '+ selectedCommunesForEmail.join() +' dans le départment de '+ selectedDepartementsForEmail.join() +"\n\n"+
        'A cette fin,nous sollicitons de votre part, la communication des matices cadastrales des parcelles suivantes afin de demander l’avis des propriétaires concernés.'+"\n\n"+
        'Vous remerciant par avance, je vous prie d\'agréer, madame, monsieur, l’expression de mes salutations distinguées'+"\n\n"+
        'Commune: '+ selectedCommunesForEmail.join() +"\n"+
        'Département: '+ selectedDepartementsForEmail.join() +"\n"+
        'Parcelles: '+ selectedParcellesForEmail.join());
        $('#message_parcelles_departements').val(selectedDepartementsForEmail.join());
        $('#message_parcelles_communes').val(selectedCommunesForEmail.join());
        $('#message_parcelles_parcelles').val(selectedParcellesForEmail.join());
        $('#message_parcelles_departements, #message_parcelles_communes, #message_parcelles_parcelles').parents('.form-group').addClass('hide');
        $('.send-mail-modal').modal('show');
      }
    });

    var $collectionHolderEnjeux = $('#projet_enjeuxs');
    var prototypeEnjeux = $collectionHolderEnjeux.data('prototype');

    $('#projet_enjeuxs_add_entry').click(function () {
      var length = $collectionHolderEnjeux.children().length;
      var entry = prototypeEnjeux.replace(/__name__label__/g, length);
      entry = entry.replace(/__name__/g, length);
      $collectionHolderEnjeux.append(entry);

      $('#projet_enjeuxs_' + length + '_date').datepicker({
        format: 'dd/mm/yyyy',
        autoclose: true,
        language: 'fr',
      });

      $('#projet_enjeuxs_' + length + '_enjeux').change();
    });

    $('#projet_enjeuxs_remove_entry').click(function () {
      $('> :last-child', $collectionHolderEnjeux).remove();
    });
    $('body').on('change', '#projet_enjeuxs select', function () {
      if($(this).val() == '-2') $(this).parent().css('background-color', '#00FF66');
      else if($(this).val() == '-1') $(this).parent().css('background-color', '#66CCFF');
      else if($(this).val() == '0') $(this).parent().css('background-color', '#FFFF00');
      else if($(this).val() == '1') $(this).parent().css('background-color', '#FF9900');
      else if($(this).val() == '2') $(this).parent().css('background-color', '#FF3333');
      else $(this).parent().css('background-color', '');
    });

    var $collectionHolderNote = $('#projet_notes');
    var prototypeNote = $collectionHolderNote.data('prototype');

    $('#projet_notes_add_entry').click(function () {
      var length = $collectionHolderNote.children().length;
      var entry = prototypeNote.replace(/__name__label__/g, length);
      entry = entry.replace(/__name__/g, length);
      $collectionHolderNote.append(entry);

      $('#projet_notes_' + length + '_date').datepicker({
        format: 'dd/mm/yyyy',
        autoclose: true,
        language: 'fr',
      });

    });

    $('#projet_notes_remove_entry').click(function () {
      if($('> :last-child', $collectionHolderNote).length) {
        var id = $('> :last-child', $collectionHolderNote).find('input').attr('id').match(/\d+/);
        id = parseInt(id);
        delete main_images[id];
        if(current_main_image == id) {
          current_main_image = current_main_image - 1;
          if(main_images[current_main_image] !== undefined)
            $('#main_photo img').attr('src', main_images[current_main_image][2]);
          else $('#main_photo img').attr('src', '');
        }
        updatePrevNextButtons();
      }
      $('> :last-child', $collectionHolderNote).remove();
    });
    
    var equipementType = '{{ form.vars.value.equipement is defined and form.vars.value.equipement ? form.vars.value.equipement : "" }}';
    var technologies = {{ technologies|raw }};
    $('#projet_technologie').change(function () {
      if($('#projet_technologie').val() == 'eolienne') {
        var clone = $('#projet_surfaceUtile').parents('.form-group').clone();
        $('#projet_surfaceUtile').parents('.form-group').remove();
        $(clone).insertAfter($('#projet_unite').parents('.form-group'));
        var clone = $('#projet_voiries').parents('.form-group').clone();
        $('#projet_voiries').parents('.form-group').remove();
        $(clone).insertAfter($('#projet_unite').parents('.form-group'));
        $('#projet_lineaire').parents('.form-group').removeClass('hide');
        $('#projet_interdistance').parents('.form-group').removeClass('hide');
        $('#projet_interdistance').val(400);
        $('#projet_puissanceUnitaire').parents('.form-group').addClass('hide');
        var technologie_emprise = 3000;
        $('#projet_emprise').val(technologie_emprise);
        $('#projet_terrain_topographie').parents('.form-group').find('label').text('Relief');
        var clone = $('#projet_terrain_altitude').parents('.form-group').clone();
        $('#projet_terrain_altitude').parents('.form-group').remove();
        $(clone).insertBefore($('#projet_terrain_topographie').parents('.form-group'));
        $('#projet_terrain_exposition').parents('.form-group').find('label').text('Orientation');
        var projet_terrain_exposition = $('#projet_terrain_exposition').val();
        $('#projet_terrain_exposition').parents('.form-group').find('div').html('<select id="projet_terrain_exposition" name="projet[terrain][exposition]" class="form-control"><option value=""></option><option value="E-O">E-O</option><option value="N-S">N-S</option><option value="NO-SE">NO-SE</option><option value="NE-SO">NE-SO</option></select>');
        $('#projet_terrain_exposition').val(projet_terrain_exposition);
      } else {
        var clone = $('#projet_surfaceUtile').parents('.form-group').clone();
        $('#projet_surfaceUtile').parents('.form-group').remove();
        $(clone).insertBefore($('#projet_unite').parents('.form-group'));
        var clone = $('#projet_voiries').parents('.form-group').clone();
        $('#projet_voiries').parents('.form-group').remove();
        $(clone).insertBefore($('#projet_unite').parents('.form-group'));
        $('#projet_lineaire').parents('.form-group').addClass('hide');
        $('#projet_lineaire').val(0);
        $('#projet_interdistance').parents('.form-group').addClass('hide');
        $('#projet_interdistance').val(0);
        $('#projet_puissanceUnitaire').parents('.form-group').addClass('hide');
        {# equipementType = ''; #}
        $('#projet_emprise').val(0);
        $('#projet_terrain_topographie').parents('.form-group').find('label').text('Relief');
        var clone = $('#projet_terrain_altitude').parents('.form-group').clone();
        $('#projet_terrain_altitude').parents('.form-group').remove();
        $(clone).insertBefore($('#projet_terrain_topographie').parents('.form-group'));
        $('#projet_terrain_exposition').parents('.form-group').find('label').text('Exposition');
        var projet_terrain_exposition = $('#projet_terrain_exposition').val();
        $('#projet_terrain_exposition').parents('.form-group').find('div').html('<select id="projet_terrain_exposition" name="projet[terrain][exposition]" class="form-control"><option value=""></option><option value="S">S</option><option value="SE">SE</option><option value="E">E</option><option value="O">O</option><option value="SO">SO</option></select>');
        $('#projet_terrain_exposition').val(projet_terrain_exposition);
      }
      if($(this).val()) {
        var selected_technologie = $(this).val();
        $.each(technologies, function(code, technologie) {
          if(code == selected_technologie) {
            $('#tab_projet p').html('');
            var technologie_lineaire = $('#projet_lineaire').val() ? parseFloat($('#projet_lineaire').val().replace(/\s/g, '')) : 0;
            var technologie_interdistance = $('#projet_interdistance').val() ? parseFloat($('#projet_interdistance').val().replace(/\s/g, '')) : 0;
            var technologie_su = $('#projet_surfaceUtile').val() ? parseFloat($('#projet_surfaceUtile').val().replace(/\s/g, '')) : 0;
            var technologie_largeur = 0;
            var technologie_longueur = 0;
            var technologie_pu = 0;
            $('#projet_equipement').html('');
            $.each(technologie['data'], function(field, value) {
              $('#projet_equipement').append(new Option(field, field.trim().toLowerCase()));
            });
            if(equipementType && $('#projet_equipement option[value="'+equipementType+'"]').length) $('#projet_equipement').val(equipementType);
            else $('#projet_equipement').val($('#projet_equipement option:first').val());
            $.each(technologie['data'][$( "#projet_equipement option:selected" ).text()], function(field, value) {
              if(field.match('Longueur')) technologie_longueur = value.replace(/'/, '.').trim();
              else if(field.match('Largeur')) technologie_largeur = value.replace(/'/, '.').trim();
              else if(field.match('Puissance')) {
                if($('#projet_technologie').val() == 'eolienne') {
                  technologie_pu = value.replace(/'/, '.').trim();
                } else {
                  technologie_pu = value.replace(/'/, '.').trim() / 1000000;
                }
                $('#projet_puissanceUnitaire').val(technologie_pu);
              }
              $('#tab_projet p').append('<div class="form-group form-group-sm"><label class="col-sm-4 control-label">'+field+':</label><div class="col-sm-8 control-label">' + value + '</div></div>');
            });
            if($('#projet_technologie').val() != 'eolienne') {
              var technologie_emprise = (technologie_largeur * technologie_longueur) / 1000000;
              $('#projet_emprise').val(technologie_emprise.toFixed(3));
            } else {
              var technologie_emprise = $('#projet_emprise').val() ? parseFloat($('#projet_emprise').val().replace(/\s/g, '')) : 0;
            }
            if($('#projet_technologie').val() == 'eolienne' || (technologie_su && technologie_largeur && technologie_longueur)) {
              if($('#projet_technologie').val() == 'eolienne') {
                var technologie_unite = technologie_lineaire && technologie_interdistance ? Math.round(((technologie_lineaire / technologie_interdistance)+1)) : 0;
                $('#projet_unite').val(technologie_unite.toString().replace(/\s/g, '').replace(/\B(?=(\d{3})+(?!\d))/g, ' '));
                var voiries = Math.round(technologie_lineaire * 4.5);
                $('#projet_voiries').val(voiries.toString().replace(/\s/g, '').replace(/\B(?=(\d{3})+(?!\d))/g, ' '));
                technologie_su = technologie_unite * technologie_emprise;
                $('#projet_surfaceUtile').val(technologie_su.toString().replace(/\s/g, '').replace(/\B(?=(\d{3})+(?!\d))/g, ' '));
              } else {
                var technologie_unite = technologie_su * 0.4 / technologie_emprise;
                $('#projet_unite').val(technologie_unite.toFixed(0).toString().replace(/\s/g, '').replace(/\B(?=(\d{3})+(?!\d))/g, ' '));
              }

              var technologie_pt = technologie_unite * technologie_pu;
              $('#projet_puissanceTotale').val(technologie_pt.toFixed(3));
              $('#projet_potentiel').val(technologie_pt.toFixed(3));
            }
          }
        });
      }
    });
    $('#projet_equipement').change(function() {
      equipementType = $(this).val();
      $('#projet_technologie').change();
    });
    $('#tab_projet').on('change', '#projet_lineaire, #projet_interdistance, #projet_surfaceUtile, #projet_emprise, #projet_unite', function () {
      $('#projet_technologie').change();
    });
    $('#tab_projet').on('input', '#projet_surfaceUtile', function () {
      $('#projet_surfaceUtile').val($('#projet_surfaceUtile').val().replace(/\s/g, '').replace(/\B(?=(\d{3})+(?!\d))/g, ' '));
      var technologie_su = $('#projet_surfaceUtile').val() ? parseFloat($('#projet_surfaceUtile').val().replace(/\s/g, '')) : 0;
      voiries = technologie_su * 0.6;
      $('#projet_voiries').val(voiries.toString().replace(/\s/g, '').replace(/\B(?=(\d{3})+(?!\d))/g, ' '));
    });

    var current_main_image = 0;
    {% if form.vars.value.notes[0].photo is defined and form.vars.value.notes[0].photo %}
    var main_images = {
      {% for note in form.vars.value.notes %}
      {{ loop.index0 }}:{0:'{{ note.titre }}', 1:'{{ note.note }}', 2:'{{ asset('upload/' ~ note.photo) }}', 3:'{{ note.date|date('d/m/Y') }}', 4: true}
      {% if not loop.last %},{% endif %}{% endfor %}
      };
    $('#main_photo img').attr('src', main_images[0][2]);
    {% if form.vars.value.notes[1].photo is defined and form.vars.value.notes[1].photo %}
    updatePrevNextButtons();
    {% endif %}
    {% else %}
    var main_images = {};
    {% endif %}
    function updatePrevNextButtons() {
      $('#projet_notes tr.info').removeClass('info');
      if(main_images[current_main_image][4]) $('#projet_notes tr:eq('+current_main_image+')').removeClass('success2').addClass('info');
      else $('#projet_notes tr:eq('+current_main_image+')').removeClass('success2');
      prev = -1;
      next = -1;
      $.each(main_images, function(i, value) {
        if(current_main_image > parseInt(i) && value[4]) prev = 1;
        if(next == -1 && current_main_image < parseInt(i) && value[4]) next = 1;
      });
      if(prev >= 0) $('#prev_image').parent().removeClass('disabled');
      else  $('#prev_image').parent().addClass('disabled');
      if(next >= 0) $('#next_image').parent().removeClass('disabled');
      else $('#next_image').parent().addClass('disabled');
      if(main_images[0] === undefined) {
        $('#projet_notes_recherche').addClass('hide');
        $('#projet_notes_recherche').val();
      } else $('#projet_notes_recherche').removeClass('hide');
    }
    $('#next_image, #prev_image').click(function(e) {
      e.preventDefault();
      prev = -1;
      next = -1;
      $.each(main_images, function(i, value) {
        if(current_main_image > parseInt(i) && value[4]) prev = i;
        if(next == -1 && current_main_image < parseInt(i) && value[4]) next = i;
      });
      if(($(this).attr('id') == 'prev_image' && prev >= 0) || ($(this).attr('id') == 'next_image' && next >= 0)) {
        if($(this).attr('id') == 'next_image') current_main_image = next;
        else current_main_image = prev;
        updatePrevNextButtons();
        $('#main_photo img').attr('src', '');
        $('#main_photo img').attr('src', main_images[current_main_image][2]);
      }
    });
    $('body').on('change', '#tab_images input[id*=_photoFile]', function() {
      var id = $(this).attr('id').match(/\d+/);
      id = parseInt(id);
      if (this.files && this.files[0]) {
        var reader = new FileReader();
        
        reader.onload = function(e) {
          $('#main_photo img').attr('src', e.target.result);
          if(main_images[id] !== undefined) main_images[id][2] = e.target.result;
          else {
            search = $('#projet_notes_recherche').val();
            if(!search || $('#projet_notes_'+id+'_titre').val().match(new RegExp(search, 'gi')) || $('#projet_notes_'+id+'_note').val().match(new RegExp(search, 'gi')) || $('#projet_notes_'+id+'_date').val().match(new RegExp(search, 'gi')))
              main_images[id] = {0: $('#projet_notes_'+id+'_titre').val(), 1: $('#projet_notes_'+id+'_note').val(), 2: e.target.result, 3: $('#projet_notes_'+id+'_date').val(), 4: true};
            else main_images[id] = {0: $('#projet_notes_'+id+'_titre').val(), 1: $('#projet_notes_'+id+'_note').val(), 2: e.target.result, 3: $('#projet_notes_'+id+'_date').val(), 4: false};
          }
          current_main_image = id;
          updatePrevNextButtons();
        }
        
        reader.readAsDataURL(this.files[0]); // convert to base64 string
      }
    });
    $('body').on('change', '#tab_images input[id*=_date]', function() {
      var id = $(this).attr('id').match(/\d+/);
      id = parseInt(id);
      if(main_images[id] !== undefined) main_images[id][3] = $(this).val();
    });
    $('body').on('change', '#tab_images input[id*=_titre]', function() {
      var id = $(this).attr('id').match(/\d+/);
      id = parseInt(id);
      if(main_images[id] !== undefined) main_images[id][0] = $(this).val();
    });
    $('body').on('change', '#tab_images input[id*=_note]', function() {
      var id = $(this).attr('id').match(/\d+/);
      id = parseInt(id);
      if(main_images[id] !== undefined) main_images[id][1] = $(this).val();
    });
    $('#projet_notes_recherche').change(function() {
      var search = $(this).val();
      $('#main_photo img').attr('src', '');
      found = 0;
      $.each(main_images, function(i, value) {
        if(value[0].match(new RegExp(search, 'gi')) || value[1].match(new RegExp(search, 'gi')) || value[3].match(new RegExp(search, 'gi'))) {
          main_images[i][4] = true;
          if(!found) {
            $('#projet_notes tr:eq('+i+')').addClass('info');
            found = 1;
            current_main_image = parseInt(i);
            $('#main_photo img').attr('src', value[2]);
          } else $('#projet_notes tr:eq('+i+')').addClass('success2');
        } else {
          main_images[i][4] = false;
          $('#projet_notes tr:eq('+i+')').removeClass('success2').removeClass('info');
        }
      });
      updatePrevNextButtons();
    });

    function countParcelles() {
      var parcelles_count = $('#projet_parcelles tr').length;
      var parcelles = [];
      var parcellesSurfaces = 0;
      $('#projet_parcelles tr').each(function(i,element) {
        parcelles.push($(element).find('td:eq(0) input[name]').val().trim());
        surface = parseInt($(element).find('input[id$="_surface"]').val().replace(/\s/g, ''));
        if(surface) parcellesSurfaces += surface;
      });
      var selectedParcellesInFoncier = [];
      var counted_accords = [];
      var accords_count = $('#projet_proprietaires tr.proprietaire_entry').length;
      if(accords_count) {
        accords_count = 0;
        $('#projet_proprietaires tr.proprietaire_entry').each(function(i,element) {
          selectedParcelles = $(element).find('td:eq(0) input[name]').val().split(',');
          $.each(selectedParcelles, function(j, word) {
            if(!counted_accords.includes(word) && parcelles.includes(word) && $(element).find('select[id$="_accordProprietaire"]').val() == 'OUI' && (!$('#projet_proprietaires tr.proprietaire2_entry:eq('+i+')').find('input[id$="_proprietaire2"]').val() || $('#projet_proprietaires tr.proprietaire2_entry:eq('+i+')').find('select[id$="_accordProprietaire2"]').val() == 'OUI') && (!$('#projet_proprietaires tr.proprietaire3_entry:eq('+i+')').find('input[id$="_proprietaire3"]').val() || $('#projet_proprietaires tr.proprietaire3_entry:eq('+i+')').find('select[id$="_accordProprietaire3"]').val() == 'OUI') && (!$('#projet_proprietaires tr.proprietaire4_entry:eq('+i+')').find('input[id$="_proprietaire4"]').val() || $('#projet_proprietaires tr.proprietaire4_entry:eq('+i+')').find('select[id$="_accordProprietaire4"]').val() == 'OUI') && $('#projet_proprietaires tr.exploitant_entry:eq('+i+')').find('select[id$="_accordExploitant"]').val() != 'NON' && $('#projet_proprietaires tr.exploitant_entry:eq('+i+')').find('select[id$="_accordExploitant"]').val() != 'NEGO' && $('#projet_proprietaires tr.exploitant_entry2:eq('+i+')').find('select[id$="_accordExploitant2"]').val() != 'NON' && $('#projet_proprietaires tr.exploitant_entry2:eq('+i+')').find('select[id$="_accordExploitant2"]').val() != 'NEGO' && $('#projet_proprietaires tr.exploitant3_entry:eq('+i+')').find('select[id$="_accordExploitant3"]').val() != 'NON' && $('#projet_proprietaires tr.exploitant3_entry:eq('+i+')').find('select[id$="_accordExploitant3"]').val() != 'NEGO') {
              accords_count++;
              counted_accords.push(word);
            }
            selectedParcellesInFoncier.push(word);
          });
        });
      }
      if($('#tab_foncier legend span').length) $('#tab_foncier legend span').remove();
      if(parcelles_count) {
        var parcellesInFoncier = [];
        $.each(parcelles, function(j, word) {
          if(!selectedParcellesInFoncier.includes(word)) {
            parcellesInFoncier.push(word);
          } else {
            parcellesInFoncier.push('<small style="color:gray;">' + word + '</small>');
          }
        });
        selectedParcelles = ' <span>(Parcelles: ' + parcellesInFoncier.join(', ') + ')</span>';
        $('#tab_foncier legend').append(' <span style="color:red;">'+accords_count+'/'+parcelles_count+'</span>' + selectedParcelles);
        $('#tab_parcelles legend').html('Parcelles: <span style="color:red;">('+parcellesSurfaces.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ')+' m2 / '+(Math.round((parcellesSurfaces/10000)*100)/100).toString().replace(/\./,',')+' ha)</span>');
      }
    }
    $('#tab_parcelles .btn').on('click', function() {
      countParcelles();
    });
    $collectionHolderProprietaire.on('change', 'select[id*="_accord"], input[id*="_parcelles"]', function() {
      countParcelles();
    });
    $collectionHolderParcelle.on('change', 'input[id$="_nom"], input[id$="_surface"]', function() {
      countParcelles();
    });

    function commandeUpdate() {
      var total = 0;
      var engage = 0;
      var paye = 0;
      $.each($('[id*="_montantTotal"]'), function(i, element) {
        var attr = $(element).parents('tr').attr('duplicate');
        if($(element).val().trim() && (typeof attr === 'undefined' || attr === false)) {
          total += parseInt($(element).val().trim());
        }
      });
      $.each($('[id*="_montantEngage"]'), function(i, element) {
        if($(element).val().trim() > 0) {
          engage += parseInt($(element).val().trim());
          var attr = $(element).parents('tr').attr('duplicate');
          if(typeof attr === 'undefined' || attr === false) {
            row_total = $(element).parents('tr').find('[id*="_montantTotal"]').val().trim();
            if(row_total) {
              $(element).parents('tr').find('[id*="_montantRestant"]').val(parseInt(row_total) - parseInt($(element).val().trim()));
            }
          } else {
            row_total = $(element).parents('tbody').find('tr:eq('+($(element).parents('tr').index()-1)+')').find('[id*="_montantRestant"]').val().trim();
            if(row_total) {
              $(element).parents('tr').find('[id*="_montantRestant"]').val(parseInt(row_total) - parseInt($(element).val().trim()));
            }
          }
        }
      });
      if($('[id*="_montantPaye"]').length) {
        $('#projet_finances_recherche').removeClass('hide');
        $.each($('[id*="_montantPaye"]'), function(i, element) {
          if($(element).val().trim() > 0) {
            paye += parseInt($(element).val().trim());
            var attr = $(element).parents('tr').attr('duplicate');
            if(typeof attr === 'undefined' || attr === false) {
              row_total = $(element).parents('tr').find('[id*="_montantTotal"]').val().trim();
              if(row_total && (!$(element).parents('tr').find('[id*="_montantEngage"]').val().trim() || $(element).parents('tr').find('[id*="_montantEngage"]').val().trim() == '0')) {
                $(element).parents('tr').find('[id*="_montantRestant"]').val(parseInt(row_total) - parseInt($(element).val().trim()));
              }
            } else {
              row_total = $(element).parents('tbody').find('tr:eq('+($(element).parents('tr').index()-1)+')').find('[id*="_montantRestant"]').val().trim();
              if(row_total && (!$(element).parents('tr').find('[id*="_montantEngage"]').val().trim() || $(element).parents('tr').find('[id*="_montantEngage"]').val().trim() == '0')) {
                $(element).parents('tr').find('[id*="_montantRestant"]').val(parseInt(row_total) - parseInt($(element).val().trim()));
              }
            }
          }
        });
      } else $('#projet_finances_recherche').addClass('hide');

      var somme = 'Total: ' + total + '€ HT | Total engagé: ' + engage + '€ HT | Total payé: ' + paye + '€ HT';
      $('#selected-counter').text(somme);
      var last_index = 0;
      var second_id = 0;
      $.each($('#projet_finances [id*="_dateEngmt"]'), function(i, element) {
        var row = $(element).parents('tr');
        var id = (row.find('[id*="_duplique"]').val() && row.find('[id*="_duplique"]').val() >= 0) ? (parseInt(row.find('[id*="_duplique"]').val().trim())+1) : (row.index() + 1);
        if((row.find('[id*="_duplique"]').val() && row.find('[id*="_duplique"]').val() >= 0)) id = last_index;
        else {
          id = last_index + 1;
          last_index = id;
          second_id = 0;
        }
        second_id++;
        row.find('td:eq(0)').text({% if projet is defined and projet.id is not null %}'{{ projet.id }}.' + {% endif %}id + '.' + second_id);
        var dateFacture = row.find('[id*="_dateFacture"]').val().match(/(\d+)\/(\d+)\/(\d+)/);
        var dateEngmt = row.find('[id*="_dateEngmt"]').val().match(/(\d+)\/(\d+)\/(\d+)/);
        var dateEcheance = row.find('[id*="_dateEcheance"]').val().match(/(\d+)\/(\d+)\/(\d+)/);
        if(dateFacture) {
          var date1 = new Date(dateFacture[2] + '/' + dateFacture[1] + '/' + dateFacture[3]);
          var date2 = new Date();
          var diffTime = date2 - date1;
          var diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) - 1;
          if(diffDays >= 1) diffDays = '+' + diffDays;
          row.find('td.difference').text(diffDays);
        } else if(dateEngmt && dateEcheance) {
          var date1 = new Date(dateEcheance[2] + '/' + dateEcheance[1] + '/' + dateEcheance[3]);
          var date2 = new Date(dateEngmt[2] + '/' + dateEngmt[1] + '/' + dateEngmt[3]);
          var diffTime = date2 - date1;
          var diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
          row.find('td.difference').text(diffDays);
        } else row.find('td.difference').text(0);
      });
    }
    $('#tab_commandes').on('change', 'input', function() {
      commandeUpdate();
    });
    $('#projet_finances_recherche').on('change', function() {
      var search = $(this).val().trim();
      $.each($('#projet_finances tr'), function(i, tr) {
        var row = $(tr);
        var search_found = false;
        row.find('td')
        $.each(row.find('td'), function(i, td) {
          var col = $(td);
          if(search && col.find('input').length && col.find('input').val().match(new RegExp(search, 'gi'))) {
            col.css('background-color', 'rgb(255, 153, 0)');
            search_found = true;
          } else if(search && col.find('select').length && (col.find('select option:selected').text().match(new RegExp(search, 'gi')) || (col.find('select').val().length > 1 && col.find('select').val().match(new RegExp(search, 'gi'))))) {
            col.css('background-color', 'rgb(255, 153, 0)');
            search_found = true;
          } else if(search && !col.find('input').length && !col.find('select').length && col.text().match(new RegExp(search, 'gi'))) {
            col.css('background-color', 'rgb(255, 153, 0)');
            search_found = true;
          } else col.css('background-color', 'white');
        });
        if(!search || search_found) row.removeClass('hide');
        else row.addClass('hide');
      });
    });

    $('document').ready(function() {
      $('#projet_batimentExistant_documentEnergie').css('width', '100%').select2();
      $('<legend>Raccordement</legend>').insertBefore($('#projet_batimentExistant_livraison').parents('.form-group'));
      $('<legend>Urbanisme</legend>').insertBefore($('#projet_batimentExistant_documentUrbanisme').parents('.form-group'));
      $('<legend>Energie</legend>').insertBefore($('#projet_batimentExistant_documentEnergie').parents('.form-group'));
      $('<legend>Raccordement</legend>').insertBefore($('#projet_terrain_livraison').parents('.form-group'));
      $('<legend>Urbanisme</legend>').insertBefore($('#projet_terrain_documentUrbanisme').parents('.form-group'));
      $('<legend>Energie</legend>').insertBefore($('#projet_terrain_pcaet').parents('.form-group'));
      $('<legend>Eoliennes</legend>').insertBefore($('#projet_terrain_eoliennesDepartement').parents('.form-group'));
      $('<legend>Gisement</legend>').insertBefore($('#projet_terrain_vitesseVent').parents('.form-group'));
      $('#projet_batimentExistant_bardage').parents('.form-group').addClass('hide');
      $('#projet_batimentExistant_ossature').parents('.form-group').addClass('hide');
      $('#projet_batimentExistant_charpente').parents('.form-group').addClass('hide');
      countParcelles();
      commandeUpdate();
      loadCoucheCadastre();
      $('#projet_typeProjet').change();
      update_type_milieu = true;
      $('#projet_technologie').change();
      $('select[id*="_phase"]').change();
      $('select[id*="_objet"]').change();
      $('#projet_enjeuxs select').change();
      if(!$('#projet_etats tr').length) $('#projet_etats_add_entry').click();
      if(!$('#projet_taches tr').length) $('#projet_taches_add_entry').click();
      if($('#projet_taches tr').length < 2) {
        $('#projet_taches_add_entry').click();
        $('#projet_taches_1_objet').val('foncier');
        $('#projet_taches_1_objet').change();
      }
      $('<div id="batimentNouveau_options" class="form-group form-group-sm"><label class="col-sm-4 control-label"></label><div class="col-sm-8"><p></p></div></div>').insertAfter($('#projet_batimentExistant_photoFile').parents('div.form-group'));
      $('#parcelleMap').addClass('hide');
    });
    $('a[href="#parcelleTable"]').on('click', function() {
      $('#parcelleMap').addClass('hide');
      $('#fields_div').addClass('col-sm-12');
      $('#fields_div').removeClass('col-sm-6');
    });
    $('a[href="#parcelleCarte"]').on('click', function() {
      $('#parcelleMap').removeClass('hide');
      $('#fields_div').removeClass('col-sm-12');
      $('#fields_div').addClass('col-sm-6');
    });
    $('#nouveau_projet_nav a').click(function (e) {
      e.preventDefault();
      var attr = $(this).attr('rel');
      if(typeof attr !== typeof undefined && attr !== false) {
        refresh_messagerie = 0;
        markers.clearLayers();
        parcMarkers = {};
        $('#nouveau_projet_nav li').removeClass('active');
        $(this).parent().addClass('active');
        $('fieldset').addClass('hide');
        $('fieldset#' + attr).removeClass('hide');
        if(attr != 'tab_localisation' && attr != 'tab_contacts' && attr != 'tab_site' && attr != 'tab_projet' && attr != 'tab_images') {
          $('#map, #map_search').addClass('hide');
          $('#main_photo').addClass('hide');
          $('#fields_div').removeClass('col-sm-6');
          $('#fields_div').addClass('col-sm-12');
          $('fieldset#' + attr + ' .col-sm-4').addClass('col-sm-2').removeClass('col-sm-4');
          if(attr == 'tab_messagerie') {
            refresh_messagerie = 1;
            refreshMessagerie();
            $('html, body').animate({
              scrollTop: $("#send_message").offset().top
            }, 'slow');
          }
        } else {
          if(attr != 'tab_images') {
            $('#map, #map_search').removeClass('hide');
            $('#main_photo').addClass('hide');
          } else {
            $('#map, #map_search').addClass('hide');
            $('#main_photo').removeClass('hide');
          }
          $('#fields_div').removeClass('col-sm-12');
          $('#fields_div').addClass('col-sm-6');
        }
        if(attr == 'tab_site') {
          loadParcMarkers();
          $('.form_site').addClass('hide');
          var type_site = $('#projet_typeSite').val();
          $('#tab_site legend:eq(0)').text($('#projet_typeSite option:selected').text());
          if(type_site == 'terrain' || type_site == 'parking' || type_site == 'plan_deau') $('#form_site_terrain').removeClass('hide');
          else if(type_site == 'batiment_existant') {
            $('#projet_batimentExistant_bardage').parents('.form-group').addClass('hide');
            $('#projet_batimentExistant_ossature').parents('.form-group').addClass('hide');
            $('#projet_batimentExistant_charpente').parents('.form-group').addClass('hide');
            $('#projet_batimentExistant_photoFile').parents('.form-group').removeClass('hide');
            $('#form_site_batimentExistant').removeClass('hide');
            $('#batimentNouveau_options').addClass('hide');
          } else if(type_site == 'nouveau_batiment') {
            $('#form_site_batimentNouveau').removeClass('hide');
            updateBatiment(0);
            $('#form_site_batimentExistant').removeClass('hide');
            $('#batimentNouveau_options').removeClass('hide');
          }
        }
        if(attr != 'tab_parcelles') {
          $('#parcelleMap').addClass('hide');
        } else {
          $('a[href="#parcelleCarte"]').click();
        }
      }
    });
    var refresh_messagerie = 0;
    var last_messagerie = [];
    function refreshMessagerie() {
      if(refresh_messagerie) {
        var csrf = '{{ csrf_token('token')|e('js') }}';
        $.ajax({
          url: Routing.generate('messagerie_list', { id: {{ projet.id }} }),
          type: 'GET',
          dataType: "json",
          data: { token: csrf },
          beforeSend: function() {
            $('.chat-messages').find('#loading_messages').remove();
            $('.chat-messages').append('<span id="loading_messages">chargement..</span>');
          },
          success: function(result) {
            last_messagerie = result;
            var message_search = $('#message_search').val().trim();
            $.each(result, function(index, message) {
              if(!message_search || message[2].match(new RegExp(message_search, 'i')) || message[3].match(new RegExp(message_search, 'i'))) {
                if(!$('.chat-messages').find('div[message="'+message[0]+'"]').length) {
                  if(message[1] == {{ app.user.id }}) {
                    $('.chat-messages').append('<div message="'+message[0]+'" class="chat-message-right mb-4"><div title="'+message[5]+'"><img src="{{ asset('images/me.jpg') }}" class="rounded-circle mr-1" alt="'+message[2]+'" width="40" height="40"><div class="text-muted small text-nowrap mt-2">'+message[4]+'</div></div><div class="flex-shrink-1 bg-gray rounded py-2 px-3 mr-3"><div class="font-weight-bold mb-1">Vous</div>'+message[3]+'</div></div>');
                  } else {
                    $('.chat-messages').append('<div message="'+message[0]+'" class="chat-message-left pb-4"><div title="'+message[5]+'"><img src="{{ asset('images/user.jpg') }}" class="rounded-circle mr-1" alt="'+message[2]+'" width="40" height="40"><div class="text-muted small text-nowrap mt-2">'+message[4]+'</div></div><div class="flex-shrink-1 bg-light rounded py-2 px-3 ml-3"><div class="font-weight-bold mb-1">'+message[2]+'</div>'+message[3]+'</div></div>');
                  }
                  $('html, body').animate({
                    scrollTop: $("#send_message").offset().top
                  }, 'slow');
                }
              } else if($('.chat-messages').find('div[message="'+message[0]+'"]').length) {
                $('.chat-messages').find('div[message="'+message[0]+'"]').remove();
              }
            });
            $('.chat-messages').find('#loading_messages').remove();
            $('a[rel="tab_messagerie"]').html('Messagerie');
          }
        });
      }
    }
    $('#send_body').keypress(function (e) {
      if (e.which == 13) {
        e.preventDefault();
        $('#send_message').click();
      }
    });
    $('#send_message').click(function(e) {
      e.preventDefault();
      var body = $('#send_body').val();
      if(body) {
        var csrf = '{{ csrf_token('token')|e('js') }}';
        $.ajax({
          url: Routing.generate('messagerie_new', { id: {{ projet.id }} }),
          type: 'GET',
          dataType: "json",
          data: { body: body, token: csrf },
          success: function(result) {
            if(result['status']) {
              $('#send_body').val('');
              refreshMessagerie();
            }
          }
        });
      }
    });
    $('#message_search').keypress(function (e) {
      if (e.which == 13) {
        e.preventDefault();
        $('#message_search').change();
      }
    });
    $('#message_search').change(function() {
      if(!last_messagerie.length) refreshMessagerie();
      else {
        var message_search = $(this).val().trim();
        $.each(last_messagerie, function(index, message) {
          if(!message_search || message[2].match(new RegExp(message_search, 'i')) || message[3].match(new RegExp(message_search, 'i'))) {
            if(!$('.chat-messages').find('div[message="'+message[0]+'"]').length) {
              if(message[1] == {{ app.user.id }}) {
                $('.chat-messages').append('<div message="'+message[0]+'" class="chat-message-right mb-4"><div title="'+message[5]+'"><img src="{{ asset('images/me.jpg') }}" class="rounded-circle mr-1" alt="'+message[2]+'" width="40" height="40"><div class="text-muted small text-nowrap mt-2">'+message[4]+'</div></div><div class="flex-shrink-1 bg-gray rounded py-2 px-3 mr-3"><div class="font-weight-bold mb-1">Vous</div>'+message[3]+'</div></div>');
              } else {
                $('.chat-messages').append('<div message="'+message[0]+'" class="chat-message-left pb-4"><div title="'+message[5]+'"><img src="{{ asset('images/user.jpg') }}" class="rounded-circle mr-1" alt="'+message[2]+'" width="40" height="40"><div class="text-muted small text-nowrap mt-2">'+message[4]+'</div></div><div class="flex-shrink-1 bg-light rounded py-2 px-3 ml-3"><div class="font-weight-bold mb-1">'+message[2]+'</div>'+message[3]+'</div></div>');
              }
              $('html, body').animate({
                scrollTop: $("#send_message").offset().top
              }, 'slow');
            }
          } else if($('.chat-messages').find('div[message="'+message[0]+'"]').length) {
            $('.chat-messages').find('div[message="'+message[0]+'"]').remove();
          }
        });
      }
    });
    setInterval(refreshMessagerie, 10000);
  </script>
{% endblock %}