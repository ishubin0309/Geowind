{% extends 'base.html.twig' %}

{% set title = 'Graphique' %}
{% set item = 'graphique' %}

{% block body %}
  <style>
    .done {
      background-color:#00CC33;
    }
    .refused {
      background-color:#FF0000;
    }
    .in_progress {
      animation-duration: 1000ms;
      animation-name: blink;
      animation-iteration-count: infinite;
      animation-direction: alternate;
      -webkit-animation:blink 1000ms infinite;
    }
    @keyframes blink {
      from {
        background-color:white;
      }
      to {
        background-color:#007826;
      }
    }
    @-webkit-keyframes blink {
      from {
        background-color:white;
      }
      to {
        background-color:#007826;
      }
    }
  </style>
  <div class="container-fluid">
    <nav class="navbar navbar-default">
      <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#graphique_nav" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">{# <img alt="Brand" width="20"  src="{{ asset('favicon.png') }}"> #}</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="graphique_nav">
          <ul class="nav navbar-nav">
            <li class="active"><a href="#" rel="tab_graphique">Graphique</a></li>
            <li class=""><a href="#" rel="tab_news">News</a></li>
            <li class=""><a href="#" rel="tab_docs">Docs</a></li>
          </ul>
        </div><!-- /.navbar-collapse -->
      </div><!-- /.container-fluid -->
    </nav>
    <fieldset id="tab_graphique">
      <legend>Graphique ({{ projets|length }} sites)</legend>

      <table class="table">
        <thead>
          <tr>
            <th></th>
            <th></th>
            <th colspan="3">Exploration</th>
            <th>D1</th>
            <th colspan="5">Négociation</th>
            <th>D2</th>
            <th colspan="7">Développement</th>
            <th>D3</th>
            <th colspan="7">Instruction</th>
            <th>D4</th>
            <th colspan="6">Pré-construction</th>
            <th>D5</th>
            <th colspan="7">Construction</th>
          </tr>
          <tr>
            <th>ID</th>
            <th>Type de projet</th>
            {% for i in 1..40 %}
            <th>{{ i }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody id="graphique">
        </tbody>
      </table>
    </fieldset>
    <fieldset id="tab_news" class="hide">
      <legend>News <a href="{{ path('news_new') }}" class="btn btn-primary btn-xs pull-right"><i class="fa fa-fw fa-plus"></i> Ajouter news</a></legend>
        
      {% if news is empty %}
        <div class="alert alert-info mt0">
          Aucune news
        </div>
      {% else %}
        <table id="datatable_news" class="table table-striped table-middle">
          <thead>
            <tr>
              <th>Date</th>
              <th>Saisie</th>
              <th>Thème</th>
              <th>Filère</th>
              <th class="column-fit">Titre</th>
              <th>Note</th>
              <th>URL</th>
              <th class="column-fit"></th>
            </tr>
          </thead>
          <tbody>
            {% for item in news %}
            <tr>
              <td>{{ item.date|date('d/m/Y') }}</td>
              <td>{{ item.saisie }}</td>
              <td>{{ item.theme }}</td>
              <td>{{ item.filiere }}</td>
              <td class="column-fit">{{ item.titre }}</td>
              <td>
              <button class="btn btn-info btn-sm btn_note">Afficher</button>
              <span class="hide">{{ item.note }}</span>
              </td>
              <td>{{ item.url }}</td>
              <td class="column-fit">
              <a href="{{ path('news_edit', {id: item.id}) }}"><button id="{{ item.id }}" type="news" class="btn btn-warning btn-xs button-edit"><i class="fa fa-fw fa-edit"></i></button></a>
              {% if is_granted('ROLE_ADMIN') %}
              &nbsp;&nbsp;<button id="{{ item.id }}" type="news" class="btn btn-danger btn-xs button-delete" title="Double click"><i class="fa fa-fw fa-trash"></i></button>
              {% endif %}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      {% endif %}
    </fieldset>
    <fieldset id="tab_docs" class="hide">
      <legend>Docs <a href="{{ path('docs_new') }}" class="btn btn-primary btn-xs pull-right"><i class="fa fa-fw fa-plus"></i> Ajouter doc</a></legend>
        
        {% if docs is empty %}
        <div class="alert alert-info mt0">
          Aucune docs
        </div>
      {% else %}
      
      <div class="row-fluid">
        <div class="col-md-6">
          <input type="text" id="docs_recherche" class="form-control hide" placeholder="recherche" autocomplete="off">
          <table id="datatable_docs" class="table table-striped table-middle">
            <thead>
              <tr>
                <th>Date</th>
                <th class="column-fit">Titre</th>
                <th>Note</th>
                <th>Photo</th>
                <th class="column-fit"></th>
              </tr>
            </thead>
            <tbody id="docs">
              {% for item in docs %}
              <tr>
                <td>{{ item.date|date('d/m/Y') }}</td>
                <td class="column-fit">{{ item.titre }}</td>
                <td>
                <button class="btn btn-info btn-sm btn_note">Afficher</button>
                <span class="hide">{{ item.note }}</span>
                </td>
                <td>{{ item.photoOriginalName }}</td>
                <td class="column-fit">
                <a href="{{ path('docs_edit', {id: item.id}) }}"><button id="{{ item.id }}" type="docs" class="btn btn-warning btn-xs button-edit"><i class="fa fa-fw fa-edit"></i></button></a>
                {% if is_granted('ROLE_ADMIN') %}
                &nbsp;&nbsp;<button id="{{ item.id }}" type="docs" class="btn btn-danger btn-xs button-delete" title="Double click"><i class="fa fa-fw fa-trash"></i></button>
                {% endif %}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="col-md-6">
          <div id="main_photo" class="hide col-sm-12"><img style="width: inherit;" src=""><nav style="margin-left:30%;" aria-label="Page navigation center-text"><ul class="pagination"><li class="page-item disabled"><a id="prev_image" class="page-link" href="#">Précédent</a></li><li class="page-item disabled"><a id="next_image" class="page-link" href="#">Suivant</a></li></ul></nav></div>
        </div>
      </div>
      {% endif %}
    </fieldset>
  </div>
  <div class="modal fade bs-modal" tabindex="-1" role="dialog" aria-labelledby="newsModal">
    <div class="modal-dialog" role="document">
      <div class="modal-content text-center">
        <div id="show_note" style="padding: 20px;text-align: left;" class="modal-body">
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block js %}
  
  <script>
    var data = [];
    {% for projet in projets %}
      data.push({
          id: {{ projet.id }},
          typeProjet: '{{ projet.typeProjet }}',
          {% set column = 0 %}
          {% set class = 'done' %}
          {% set en_attente = 0 %}
          {% if projet.phase == 'decision1' %}
            {% set column = 4 %}
            {% if projet.progression == 'rejet' %}
              {% set class = 'refused' %}
            {% elseif projet.progression == 'en_attente' %}
              {% set en_attente = 1 %}
              {% set class = 'in_progress' %}
            {% endif %}
          {% elseif projet.phase == 'decision2' %}
            {% set column = 10 %}
            {% if projet.progression == 'rejet' %}
              {% set class = 'refused' %}
            {% elseif projet.progression == 'en_attente' %}
              {% set en_attente = 1 %}
              {% set class = 'in_progress' %}
            {% endif %}
          {% elseif projet.phase == 'decision3' %}
            {% set column = 18 %}
            {% if projet.progression == 'rejet' %}
              {% set class = 'refused' %}
            {% elseif projet.progression == 'en_attente' %}
              {% set en_attente = 1 %}
              {% set class = 'in_progress' %}
            {% endif %}
          {% elseif projet.phase == 'decision4' %}
            {% set column = 26 %}
            {% if projet.progression == 'rejet' %}
              {% set class = 'refused' %}
            {% elseif projet.progression == 'en_attente' %}
              {% set en_attente = 1 %}
              {% set class = 'in_progress' %}
            {% endif %}
          {% elseif projet.phase == 'decision5' %}
            {% set column = 33 %}
            {% if projet.progression == 'rejet' %}
              {% set class = 'refused' %}
            {% elseif projet.progression == 'en_attente' %}
              {% set en_attente = 1 %}
              {% set class = 'in_progress' %}
            {% endif %}
          {% else %}
            {% set column = projet.progression|replace({'nouveau':0,'verification':1,'identification':2,'contacts':3,'visites':5,'pourpalers':6,'signatures':7,'sous_promesse':8,'accord_municipal':9,'devis_etude':11,'budgete':12,'a_letude':13,'avant_projet':14,'prerapport':15,'projet_fige':16,'etudes_boucles':17,'dossier_depose':19,'completude':20,'a_lenquete':21,'replique':22,'soutenance':23,'autorise':24,'purge':25,'bornage':27,'plan_exe':28,'baux_signe':29,'etude_geo':30,'contrat_rac':31,'contrat_achat':32,'chiffrage':34,'data_room':35,'audits':36,'finance':37,'achats':38,'en_travaux':39,'en_service':40}) %}
          {% endif %}
          column: {{ column }},
          {% if column %}
            class: '{{ class }}',
          {% else %}
            class: '',
          {% endif %}
      });
    {% endfor %}
    var typeProjet = {{ grid_helper.getJsontypeProjets|raw }};

    function typeProjetFormatter(value) {
      return typeProjet[value] !== undefined ? typeProjet[value]['name'] : value;
    }
    function formatProjetLink(value) {
      url = '{{ path('projet_edit', {id: 0}) }}';
      return url.replace(/0/, value);
    }
    $.each(data, function(index, row) {
      var rest = '';
      for (var i = 1; i <= 40; i++) {
        if(row['column'] > i) rest += '<td class="done"></td>';
        else if(row['column'] == i) rest += '<td class="'+row['class']+'"></td>';
        else rest += '<td></td>';
      }
      var found = 0;
      $('#graphique tr').each(function(index2, row2) {
        if(!found && $(row2).attr('rel') < row['column']) {
          $('<tr rel="'+row['column']+'"><td><a href="'+formatProjetLink(row['id'])+'">'+row['id']+'</a></td><td>'+typeProjetFormatter(row['typeProjet'])+'</td>'+rest+'</tr>').insertBefore($(row2));
          found = true;
        }
      });
      if(!found) $('#graphique').append('<tr rel="'+row['column']+'"><td><a href="'+formatProjetLink(row['id'])+'">'+row['id']+'</a></td><td>'+typeProjetFormatter(row['typeProjet'])+'</td>'+rest+'</tr>');
    })
  </script>
  <script>
  var current_main_image = 0;
    {% if docs[0].photo is defined and docs[0].photo %}
    var main_images = {
      {% for doc in docs %}
      {{ loop.index0 }}:{0:'{{ doc.titre }}', 1:'{{ doc.note }}', 2:'{{ asset('upload/' ~ doc.photo) }}', 3:'{{ doc.date|date('d/m/Y') }}', 4: true}
      {% if not loop.last %},{% endif %}{% endfor %}
      };
    $('#main_photo img').attr('src', main_images[0][2]);
    {% if docs[1].photo is defined and docs[1].photo %}
    updatePrevNextButtons();
    {% endif %}
    {% else %}
    var main_images = {};
    {% endif %}
    function updatePrevNextButtons() {
      $('#docs tr.info').removeClass('info');
      if(main_images[current_main_image][4]) $('#docs tr:eq('+current_main_image+')').removeClass('success2').addClass('info');
      else $('#docs tr:eq('+current_main_image+')').removeClass('success2');
      prev = -1;
      next = -1;
      $.each(main_images, function(i, value) {
        if(current_main_image > i && value[4]) prev = 1;
        if(next == -1 && current_main_image < i && value[4]) next = 1;
      });
      if(prev >= 0) $('#prev_image').parent().removeClass('disabled');
      else  $('#prev_image').parent().addClass('disabled');
      if(next >= 0) $('#next_image').parent().removeClass('disabled');
      else $('#next_image').parent().addClass('disabled');
      if(main_images[0] === undefined) {
        $('#docs_recherche').addClass('hide');
        $('#docs_recherche').val();
      } else $('#docs_recherche').removeClass('hide');
    }
    $('#next_image, #prev_image').click(function(e) {
      e.preventDefault();
      prev = -1;
      next = -1;
      $.each(main_images, function(i, value) {
        if(current_main_image > i && value[4]) prev = i;
        if(next == -1 && current_main_image < i && value[4]) next = i;
      });
      if(($(this).attr('id') == 'prev_image' && prev >= 0) || ($(this).attr('id') == 'next_image' && next >= 0)) {
        if($(this).attr('id') == 'next_image') current_main_image = next;
        else current_main_image = prev;
        updatePrevNextButtons();
        $('#main_photo img').attr('src', main_images[current_main_image][2]);
      }
    });
    $('#docs_recherche').change(function() {
      var search = $(this).val();
      $('#main_photo img').attr('src', '');
      found = 0;
      $.each(main_images, function(i, value) {
        if(value[0].match(new RegExp(search, 'gi')) || value[1].match(new RegExp(search, 'gi')) || value[3].match(new RegExp(search, 'gi'))) {
          if(!found) {
            $('#docs tr:eq('+i+')').addClass('info');
            found = 1;
            current_main_image = i;
            $('#main_photo img').attr('src', value[2]);
            main_images[i][4] = true;
          } else $('#docs tr:eq('+i+')').addClass('success2');
        } else {
          main_images[i][4] = false;
          $('#docs tr:eq('+i+')').removeClass('success2').removeClass('info');
        }
      });
      updatePrevNextButtons();
    });
  </script>
  <script>
  $('.btn_note').click(function() {
    var note = $(this).parent().find('span').text().replace(/\n/, '<br>');
    $('.bs-modal').modal('show');
    $('#show_note').html(note);
  });
  {% if is_granted('ROLE_ADMIN') %}
  $('.button-delete').dblclick(function() {
    id = $(this).attr('id');
    type = $(this).attr('type');
    title = type=='news' ? 'News sera supprimé définitivement.' : 'Doc sera supprimé définitivement.';
    if (!id) {
      return;
    }
    swal({
      title: "Supprimer ?",
      text: title,
      type: "warning",
      showCancelButton: true,
      confirmButtonColor: "#DD6B55",
      confirmButtonText: "Supprimer",
      cancelButtonText: "Annuler",
      closeOnConfirm: false,
      closeOnCancel: true,
      allowOutsideClick: true,
      showLoaderOnConfirm: true,
    },
    function(isConfirm){
      if (isConfirm) {
        var csrf = '{{ csrf_token('token')|e('js') }}';
        $.ajax({
          url: Routing.generate(type + '_delete', {id: id}),
          type: 'DELETE',
          data: {token: csrf},
          success: function(result) {
            location.reload();
          }
        });
      } else {

      }
    });

  });
  {% endif %}
  </script>
  <script>
  $('#graphique_nav a').click(function (e) {
    var attr = $(this).attr('rel');
    if(typeof attr !== typeof undefined && attr !== false) {
      e.preventDefault();
      $('#graphique_nav li').removeClass('active');
      $(this).parent().addClass('active');
      $('fieldset').addClass('hide');
      $('fieldset#' + attr).removeClass('hide');
      if(attr == 'tab_docs') $('#main_photo').removeClass('hide');
      else $('#main_photo').addClass('hide');
    }
  });
  </script>
{% endblock %}