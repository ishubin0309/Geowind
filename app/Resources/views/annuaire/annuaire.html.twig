{% extends 'base.html.twig' %}

{% set title = 'Mairie' %}
{% set item = 'annuaire' %}

{% block body %}

  <div class="container">
    <nav class="navbar navbar-default">
      <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#mairie_nav" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">{# <img alt="Brand" width="20"  src="{{ asset('favicon.png') }}"> #}</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="mairie_nav">
          <ul class="nav navbar-nav">
            <li class="active"><a href="#" rel="tab_list">Mairies contactées</a></li>
            <li><a href="{{ path('annuaire_secteur') }}">Carte des contacts <i style="color:red;" class="fa fa-map-o" aria-hidden="true"></i></a></li>
            <li class=""><a href="#" rel="tab_model">Modèles</a></li>
            <li class=""><a href="#" rel="tab_search">Recherche</a></li>
          </ul>
        </div><!-- /.navbar-collapse -->
      </div><!-- /.container-fluid -->
    </nav>
    <fieldset id="tab_list">
      <legend>Mairies contactées</legend>
      {% if messages is empty %}
        <div class="alert alert-info mt0">
          Aucune mairie contactée
        </div>
      {% else %}
        <table id="datatable" class="table table-striped table-middle">
          <thead>
            <tr>
              <th>Date1</th>
              <th>Mairie</th>
              <th>Destinaire</th>
              <th>Contactée par</th>
              <th>Objet</th>
              <th>Message</th>
              <th>Résultat</th>
              <th>Date2</th>
            </tr>
          </thead>
          <tbody>
            {% for message in messages %}
            <tr>
              <td>{{ message.createdAt|date('d/m/Y') }}</td>
              <td><a href="{{ path('annuaire_mairie', { 'insee': message.mairie.insee }) }}">{{ message.mairie }}</a></td>
              <td>{{ message.to }}</td>
              <td>{{ message.createdBy }}</td>
              <td>{{ message.object }}</td>
              <td>
              {% if message.body|length > 20 %}
              <span title="{{ message.body }}">{{ message.body|slice(0, 20) }}</span>
              {% else %}
              {{ message.body }}
              {% endif %}
              </td>
              <td>
              {% set result = message.result ? message.result : '?' %}
                <select rel="{{ message.id }}" data="{{ result }}" style="width:100%;" class="form-control change_result">
                  {% for option in ['?', '+', '-'] %}
                  <option {% if option == result %}selected{% endif %}>({{ option }})</option>
                  {% endfor %}
                </select>
              </td>
              <td>{{ message.result is not null and message.result != '?' ? message.updatedAt|date('d/m/Y') : '' }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      {% endif %}
    </fieldset>
    <fieldset id="tab_model" class="hide">
      <legend>Modèle <a href="{{ path('model_new') }}" class="btn btn-primary btn-sm pull-right">Nouveau modèle</a></legend>
      {% if models is empty %}
        <div class="alert alert-info mt0">
          Aucun modèle
        </div>
      {% else %}
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Intitulé du modèle</th>
              <th class="column-fit"></th>
              <th class="column-fit"></th>
            </tr>
          </thead>
          <tbody>
            {% for model in models %}
            <tr>
              <td>{{ model }}</td>
              <td class="column-fit">
                <a href="{{ path('model_edit', { 'id': model.id }) }}" class="btn btn-warning btn-xs"><i class="fa fa-pencil"></i></a>
              </td>
              <td class="column-fit">
                <button id="{{ model.id }}" model="{{ model }}" class="btn btn-danger btn-xs button-delete" title="Double click"><i class="fa fa-fw fa-trash"></i></button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      {% endif %}
    </fieldset>
    <fieldset id="tab_search" class="hide">
      <legend>Chercher une mairie</legend>
      <select id="input-mairie" style="width:50%" type="text" class="form-control"></select>
    </fieldset>
  </div>
        
{% endblock %}

{% block js %}
  <script>
    $('.button-delete').dblclick(function() {
      id = $(this).attr('id');
      model = $(this).attr('model');
      
      if (!id) {
        return;
      }
      swal({
        title: "Supprimer ?",
        text: "Le modèle « "+model+" » sera supprimé définitivement.",
        type: "warning",
        showCancelButton: true,
        confirmButtonColor: "#DD6B55",
        confirmButtonText: "Supprimer",
        cancelButtonText: "Annuler",
        closeOnConfirm: false,
        closeOnCancel: true,
        allowOutsideClick: true,
        showLoaderOnConfirm: true,
      },
      function(isConfirm){
        if (isConfirm) {
          var csrf = '{{ csrf_token('token')|e('js') }}';
          $.ajax({
            url: Routing.generate('model_delete', {id: id}),
            type: 'DELETE',
            data: { token: csrf  },
            success: function(result) {
              location.reload();
            }
          });
        } else {

        }
      });

    });

    $('#datatable').DataTable({
      language: dtLang,
      paging: false,
      ordering: false,
      bInfo: false,
    });
    
    $("#input-mairie").select2({
      ajax: {
        url: Routing.generate('mairie_search'),
        dataType: 'json',
        delay: 500,
        processResults: function (data) {
          return {
            results: data
          };
        }
      },
      escapeMarkup: function (markup) { return markup; }, // let our custom formatter work
      minimumInputLength: 1,
    });
    
    $('#input-mairie').on('select2:select', function (e) {
      var data = e.params.data;
      window.location.href = Routing.generate('annuaire_mairie', { insee: data.insee });
    });

    $(".change_result").select2();

    $('.change_result').on('select2:select', function() {
      option = $(this).val().replace(/(\(|\))/g, '').trim();
      id = $(this).attr('rel');
      old_data = $(this).attr('data');
      swal({
          title: "êtes-vous sûr ?",
          text: "Le résultat de message va être changé",
          type: "warning",
          showCancelButton: true,
          confirmButtonColor: "#DD6B55",
          confirmButtonText: "Changer",
          cancelButtonText: "Annuler",
          closeOnConfirm: false,
          closeOnCancel: true,
          allowOutsideClick: true,
          showLoaderOnConfirm: true,
        },
        function(isConfirm){
          if (isConfirm) {
            var csrf = '{{ csrf_token('token')|e('js') }}';
            $.ajax({
              url: Routing.generate('message_edit', {id: id}),
              type: 'POST',
              data: { result: option, token: csrf  },
              success: function(result) {
                window.location.href = '{{ path('annuaire_index') }}';
              }
            });
          } else {
            $('select[rel="'+id+'"]').val('('+old_data+')');
            $('.change_result').change();
          }
        });
      });

      $('#mairie_nav a').click(function (e) {
        var attr = $(this).attr('rel');
        if(typeof attr !== typeof undefined && attr !== false) {
          e.preventDefault();
          $('#mairie_nav li').removeClass('active');
          $(this).parent().addClass('active');
          $('fieldset').addClass('hide');
          $('fieldset#' + attr).removeClass('hide');
        }
      });
  </script>
{% endblock %}